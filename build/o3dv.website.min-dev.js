var OV=(()=>{var Zi=Object.defineProperty;var lo=Object.getOwnPropertyDescriptor;var ao=Object.getOwnPropertyNames;var ho=Object.prototype.hasOwnProperty;var uo=(s,e)=>{for(var t in e)Zi(s,t,{get:e[t],enumerable:!0})},mo=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ao(e))!ho.call(s,r)&&r!==t&&Zi(s,r,{get:()=>e[r],enumerable:!(i=lo(e,r))||i.enumerable});return s};var fo=s=>mo(Zi({},"__esModule",{value:!0}),s);var So={};uo(So,{CreateHeaderButton:()=>yo,SetWebsiteEventHandler:()=>Io,StartEmbed:()=>Mo,StartWebsite:()=>To});var ci=null,yn=new Set;function Qi(s){ci=s}function $i(s){return ci===null?null:ci+"/"+s}function ge(s){return new Promise((e,t)=>{if(ci===null){t();return}if(yn.has(s)){e();return}let i=document.createElement("script");i.type="text/javascript",i.src=$i(s),i.onload=()=>{yn.add(s),e()},i.onerror=()=>{t()},document.head.appendChild(i)})}var Sn=57.29577951308232,Nt=.017453292519943;function Xt(s){return Math.abs(s)<1e-8}function pi(s,e){return e-s>1e-8}function bn(s,e){return s-e>1e-8}function gi(s,e){return e-s>-1e-8}function xi(s,e){return s-e>-1e-8}function J(s,e){return Math.abs(e-s)<1e-8}function er(s,e,t){return Math.abs(e-s)<t}function Ue(s){return s>1e-8}function dt(s){return s<-1e-8}var G={X:1,Y:2,Z:3};var B=class{constructor(e,t){this.x=e,this.y=t}Clone(){return new B(this.x,this.y)}};function mt(s,e){return J(s.x,e.x)&&J(s.y,e.y)}function tr(s,e){return new B(s.x-e.x,s.y-e.y)}function ir(s,e){return Math.sqrt((s.x-e.x)*(s.x-e.x)+(s.y-e.y)*(s.y-e.y))}function he(s){return Math.round(parseFloat(s))}function wn(s){let e=he(s.paddingLeft)+he(s.paddingRight),t=he(s.borderLeftWidth)+he(s.borderRightWidth),i=he(s.marginLeft)+he(s.marginRight);return e+t+i}function En(s){let e=he(s.paddingTop)+he(s.paddingBottom),t=he(s.borderTopWidth)+he(s.borderBottomWidth),i=he(s.marginTop)+he(s.marginBottom);return e+t+i}function An(s,e,t){let i=getComputedStyle(s),r=e-wn(i),n=t-En(i);return{width:r,height:n}}function ft(s,e,t){if(s.getBoundingClientRect){let i=s.getBoundingClientRect();e-=i.left,t-=i.top}return window.pageXOffset&&window.pageYOffset&&(e+=window.pageXOffset,t+=window.pageYOffset),new B(e,t)}function Vt(s,e,t){let i=document.createElement(s);return e&&(i.className=e),t&&(i.innerHTML=t),i}function Q(s,e,t,i){let r=Vt(e,t,i);return s.appendChild(r),r}function v(s,e,t){return Q(s,"div",e,t)}function Te(s){for(;s.firstChild;)s.removeChild(s.firstChild)}function ct(s,e){e.parentNode.insertBefore(s,e)}function Dn(s,e){e.parentNode.insertBefore(s,e.nextSibling)}function O(s,e){e?s.style.display="block":s.style.display="none"}function Gn(s){return s.offsetParent!==null}function Lt(s,e){s.style.width=e.toString()+"px"}function xe(s,e){s.style.height=e.toString()+"px"}function Bt(s){let e=getComputedStyle(s);return s.offsetWidth+he(e.marginLeft)+he(e.marginRight)}function et(s){let e=getComputedStyle(s);return s.offsetHeight+he(e.marginTop)+he(e.marginBottom)}function Pn(s,e){let t=getComputedStyle(s);Lt(s,e-wn(t))}function tt(s,e){let t=getComputedStyle(s);xe(s,e-En(t))}function Ci(s,e,t,i,r){let n=Q(s,"label");n.setAttribute("for",e);let o=Q(n,"input","ov_checkbox");return o.setAttribute("type","checkbox"),o.setAttribute("id",e),o.checked=i,Q(n,"span",null,t),r&&o.addEventListener("change",r),o}function _n(s,e,t){let i=Q(s,"input","ov_slider");return i.setAttribute("type","range"),i.setAttribute("min",e.toString()),i.setAttribute("max",t.toString()),i}function rr(s,e,t,i){let r=v(s,"ov_select_container"),n=Q(r,"select","ov_select");for(let o of e)Q(n,"option",null,o);return n.selectedIndex=t,i&&n.addEventListener("change",()=>{i(n.selectedIndex)}),n}function nr(s,e){function t(l,a){a?l.classList.add("on"):l.classList.remove("on")}let i=!1,r=null,n="ov_toggle";e&&(n+=" "+e);let o=v(s,n);return v(o,"ov_toggle_slider"),o.addEventListener("click",()=>{i=!i,t(o,i),r&&r()}),{element:o,GetStatus:()=>i,SetStatus:l=>{i=l,t(o,i)},OnChange:l=>{r=l}}}function Ce(s,e){return Vt("div",s,e)}var D=class{constructor(e,t,i){this.r=e,this.g=t,this.b=i}Set(e,t,i){this.r=e,this.g=t,this.b=i}Clone(){return new D(this.r,this.g,this.b)}};function Ee(s){return parseInt(Math.round(s*255),10)}function Re(s,e,t){return new D(Ee(s),Ee(e),Ee(t))}function it(s){return s<.04045?s*.0773993808:Math.pow(s*.9478672986+.0521327014,2.4)}function Yt(s){return s<.0031308?s*12.92:1.055*Math.pow(s,.41666)-.055}function ee(s){let e=parseInt(s,10).toString(16);for(;e.length<2;)e="0"+e;return e}function ue(s){let e=ee(s.r),t=ee(s.g),i=ee(s.b);return e+t+i}function Rn(s){return new D(s[0],s[1],s[2])}function pt(s,e){return s.r===e.r&&s.g===e.g&&s.b===e.b}function te(s){return new TextDecoder("utf-8").decode(s)}function vi(s){return new TextEncoder().encode(s).buffer}function Kt(s){let e="data:";if(!s.startsWith(e))return null;let t=s.indexOf(";");if(t===-1)return null;let i=s.indexOf(",");if(i===-1)return null;let r=s.substring(e.length,e.length+t-5),n=atob(s.substring(i+1)),o=new ArrayBuffer(n.length),l=new Uint8Array(o);for(let a=0;a<n.length;a++)l[a]=n.charCodeAt(a);return{mimeType:r,buffer:o}}function Ot(s){if(s==null)return"";let e=s.split("/");return e.length===0?"":e[e.length-1]}function gt(s){let e=new Blob([s]);return URL.createObjectURL(e)}function sr(s,e){let t=new Blob([s],{type:e});return URL.createObjectURL(t)}function Fn(s){URL.revokeObjectURL(s)}function Nn(s,e){let t=null,i=n=>{n.preventDefault();let o=n.clientX-t;e.onSplit(o)},r=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",r),document.removeEventListener("mouseleave",r),t=null};s.addEventListener("mousedown",n=>{t=n.clientX,e.onSplitStart(),document.addEventListener("mousemove",i),document.addEventListener("mouseup",r),document.addEventListener("mouseleave",r)})}function or(s,e){return s.length>0?s:e}function Vn(s){return or(s,"No Name")}function Ii(s){return or(s,"No Name")}function Ti(s){return or(s,"No Name")}function lr(){return window.matchMedia("(hover: hover)").matches}function Ln(s){window.matchMedia("(max-width: 800px)").addEventListener("change",s)}function Bn(){return window.matchMedia("(max-width: 800px)").matches}function Mi(s,e){function t(r,n){let o=window.innerWidth,l=r.getBoundingClientRect(),a=r.offsetWidth,h=r.offsetHeight,u=n.offsetWidth,d=10,m=l.left+a/2-u/2;return m+u>o-d&&(m=o-u-d),m<d&&(m=d),m=Math.max(m,0),{left:m,top:l.top+h+d}}if(!lr())return;let i=null;s.addEventListener("mouseover",()=>{i=v(document.body,"ov_tooltip",e);let r=t(s,i);i.style.left=r.left+"px",i.style.top=r.top+"px"}),s.addEventListener("mouseout",()=>{i.remove()})}function On(s){let e=document.createElement("input");e.style.position="absolute",e.style.left="0",e.style.top="0",e.setAttribute("value",s),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}function ar(s,e){let t=document.createElement("a");t.href=s,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}function hr(s,e){let t=gt(s);ar(t,e)}function Jt(s,e){let t=Ce("ov_svg_icon");return e&&t.classList.add(e),Q(t,"i","icon icon-"+s),t}function ie(s,e,t){let i=Jt(e,t);return s.appendChild(i),i}function Xe(s,e){let t=s.firstChild;t.className="icon icon-"+e}function yi(s){let e="#"+ue(s),t=new D(Math.max(0,s.r-50),Math.max(0,s.g-50),Math.max(0,s.b-50)),i="#"+ue(t),r=Ce("ov_color_circle");return r.style.background=e,r.style.border="1px solid "+i,r}function kn(s){return s.r*.299+s.g*.587+s.b*.114>186}function Si(s,e,t,i){let r=null;Nn(s,{onSplitStart:()=>{r=Bt(e)},onSplit:n=>{let a=0;t?a=r-n:a=r+n,a<280?a=280:a>450&&(a=450),Pn(e,a),i()}})}function Un(s,e){async function t(n,o){let l=n.createReader();return new Promise((a,h)=>{l.readEntries(async u=>{for(let d of u)d.isFile?o.push(d):d.isDirectory&&await t(d,o);a()},u=>{h(u)})})}async function i(n,o){let l=[];for(let h of n)h.isFile?l.push(h):h.isDirectory&&await t(h,l);let a=await Promise.all(l.map(h=>new Promise((u,d)=>{h.file(m=>{u(m)},m=>{d(m)})})));o(a)}let r=null;if(DataTransferItem&&(DataTransferItem.prototype.getAsEntry?r=DataTransferItem.prototype.getAsEntry:DataTransferItem.prototype.webkitGetAsEntry&&(r=DataTransferItem.prototype.webkitGetAsEntry)),r!==null){let n=[];for(let o of s.items){let l=r.call(o);l!==null&&n.push(l)}i(n,o=>{e(o)})}else e(s.files)}var bi=null;function Hn(s){bi=s}function se(s,e,t){bi?.(s,e,t)}var T=class{constructor(e,t,i){this.x=e,this.y=t,this.z=i}Length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}MultiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}Normalize(){let e=this.Length();return e>0&&this.MultiplyScalar(1/e),this}Offset(e,t){let i=e.Clone().Normalize();return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this}Rotate(e,t,i){let r=e.Clone().Normalize(),n=r.x,o=r.y,l=r.z,a=this.x-i.x,h=this.y-i.y,u=this.z-i.z,d=Math.sin(t),m=Math.cos(t);return this.x=-n*(-n*a-o*h-l*u)*(1-m)+a*m+(-l*h+o*u)*d,this.y=-o*(-n*a-o*h-l*u)*(1-m)+h*m+(l*a-n*u)*d,this.z=-l*(-n*a-o*h-l*u)*(1-m)+u*m+(-o*a+n*h)*d,this.x+=i.x,this.y+=i.y,this.z+=i.z,this}Clone(){return new T(this.x,this.y,this.z)}};function Fe(s,e){return J(s.x,e.x)&&J(s.y,e.y)&&J(s.z,e.z)}function zn(s,e){return new T(s.x+e.x,s.y+e.y,s.z+e.z)}function oe(s,e){return new T(s.x-e.x,s.y-e.y,s.z-e.z)}function Ne(s,e){return Math.sqrt((s.x-e.x)*(s.x-e.x)+(s.y-e.y)*(s.y-e.y)+(s.z-e.z)*(s.z-e.z))}function ur(s,e){return s.x*e.x+s.y*e.y+s.z*e.z}function Wn(s,e){let t=s.Clone().Normalize(),i=e.Clone().Normalize();if(Fe(t,i))return 0;let r=ur(t,i);return Math.acos(r)}function Ye(s,e){let t=new T(0,0,0);return t.x=s.y*e.z-s.z*e.y,t.y=s.z*e.x-s.x*e.z,t.z=s.x*e.y-s.y*e.x,t}function wi(s,e,t){return Math.sqrt(s*s+e*e+t*t)}function Ke(s){return new T(s[0],s[1],s[2])}var Je=class{constructor(e,t,i){this.eye=e,this.center=t,this.up=i}Clone(){return new Je(this.eye.Clone(),this.center.Clone(),this.up.Clone())}};function jn(s,e){return Fe(s.eye,e.eye)&&Fe(s.center,e.center)&&Fe(s.up,e.up)}var de={IntegerToString(s){return s.toString()},StringToInteger(s){return parseInt(s,10)},NumberToString(s){let e=5;return s.toFixed(e)},StringToNumber(s){return parseFloat(s)},ModelUrlsToString:function(s){return s===null?null:s.join(",")},StringToModelUrls:function(s){return s===null||s.length===0?null:s.split(",")},CameraToString:function(s){return s===null?null:[this.NumberToString(s.eye.x),this.NumberToString(s.eye.y),this.NumberToString(s.eye.z),this.NumberToString(s.center.x),this.NumberToString(s.center.y),this.NumberToString(s.center.z),this.NumberToString(s.up.x),this.NumberToString(s.up.y),this.NumberToString(s.up.z)].join(",")},StringToCamera:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==9?null:new Je(new T(this.StringToNumber(e[0]),this.StringToNumber(e[1]),this.StringToNumber(e[2])),new T(this.StringToNumber(e[3]),this.StringToNumber(e[4]),this.StringToNumber(e[5])),new T(this.StringToNumber(e[6]),this.StringToNumber(e[7]),this.StringToNumber(e[8])))},ColorToString:function(s){return s===null?null:[this.IntegerToString(s.r),this.IntegerToString(s.g),this.IntegerToString(s.b)].join(",")},StringToColor:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==3?null:new D(this.StringToInteger(e[0]),this.StringToInteger(e[1]),this.StringToInteger(e[2]))},EnvironmentSettingsToString(s){return s===null?null:[s.environmentMapName,s.backgroundIsEnvMap?"on":"off"].join(",")},StringToEnvironmentSettings:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==2?null:{environmentMapName:e[0],backgroundIsEnvMap:e[1]==="on"}},EdgeSettingsToString:function(s){return s===null?null:[s.showEdges?"on":"off",this.ColorToString(s.edgeColor),this.IntegerToString(s.edgeThreshold)].join(",")},StringToEdgeSettings:function(s){if(s===null||s.length===0)return null;let e=s.split(",");return e.length!==5?null:{showEdges:e[0]==="on",edgeColor:new D(this.StringToInteger(e[1]),this.StringToInteger(e[2]),this.StringToInteger(e[3])),edgeThreshold:this.StringToInteger(e[4])}}},qn=class{constructor(e){this.separator=e,this.paramList=""}AddModelUrls(e){return this.AddUrlPart("model",de.ModelUrlsToString(e)),this}AddCamera(e){return this.AddUrlPart("camera",de.CameraToString(e)),this}AddEnvironmentSettings(e){return this.AddUrlPart("envsettings",de.EnvironmentSettingsToString(e)),this}AddBackgroundColor(e){return this.AddUrlPart("backgroundcolor",de.ColorToString(e)),this}AddDefaultColor(e){return this.AddUrlPart("defaultcolor",de.ColorToString(e)),this}AddEdgeSettings(e){return this.AddUrlPart("edgesettings",de.EdgeSettingsToString(e)),this}AddUrlPart(e,t){e===null||t===null||(this.paramList.length>0&&(this.paramList+=this.separator),this.paramList+=e+"="+t)}GetParameterList(){return this.paramList}},Xn=class{constructor(e,t){this.separator=t,this.paramList=e}GetModelUrls(){if(this.paramList.indexOf("=")===-1)return this.paramList.split(",");let e=this.GetKeywordParams("model");return de.StringToModelUrls(e)}GetCamera(){let e=this.GetKeywordParams("camera");return de.StringToCamera(e)}GetEnvironmentSettings(){let e=this.GetKeywordParams("envsettings");return de.StringToEnvironmentSettings(e)}GetBackgroundColor(){let e=this.GetKeywordParams("backgroundcolor");return de.StringToColor(e)}GetDefaultColor(){let e=this.GetKeywordParams("defaultcolor");return de.StringToColor(e)}GetEdgeSettings(){let e=this.GetKeywordParams("edgesettings");return de.StringToEdgeSettings(e)}GetKeywordParams(e){if(this.paramList===null||this.paramList.length===0)return null;let t=e+"=",i=this.paramList.split(this.separator);for(let r=0;r<i.length;r++){let n=i[r];if(n.startsWith(t))return n.substring(t.length)}return null}};function Ei(){return new qn("$")}function xt(s){return new Xn(s,"$")}function Ai(s){let e=Ei();return e.AddModelUrls(s),e.GetParameterList()}var Z={Url:1,File:2,Decompressed:3},F={Text:1,Binary:2};function re(s){let e=s.lastIndexOf("/");e===-1&&(e=s.lastIndexOf("\\"));let t=s;e!==-1&&(t=s.substring(e+1));let i=t.indexOf("?");return i!==-1&&(t=t.substring(0,i)),decodeURI(t)}function Ve(s){let e=re(s),t=e.lastIndexOf(".");return t===-1?"":e.substring(t+1).toLowerCase()}function Yn(s,e){return new Promise((t,i)=>{let r=new XMLHttpRequest;if(r.open("GET",s,!0),e===F.Text)r.responseType="text";else if(e===F.Binary)r.responseType="arraybuffer";else{i();return}r.onload=function(){r.status===200?t(r.response):i()},r.onerror=function(){i()},r.send(null)})}function Kn(s,e){return new Promise((t,i)=>{let r=new FileReader;r.onloadend=function(n){n.target.readyState===FileReader.DONE&&t(n.target.result)},r.onerror=function(){i()},e===F.Text?r.readAsText(s):e===F.Binary?r.readAsArrayBuffer(s):i()})}function Di(s){for(let e=0;e<s.length;e++){let t=s[e];if(t.search(/www\.dropbox\.com/u)!==-1){t=t.replace("www.dropbox.com","dl.dropbox.com");let i=t.indexOf("?");i!==-1&&(t=t.substring(0,i)),s[e]=t}else if(t.search(/github\.com/u)!==-1){t=t.replace("github.com","raw.githubusercontent.com"),t=t.replace("/blob","");let i=t.indexOf("?");i!==-1&&(t=t.substring(0,i)),s[e]=t}}}var dr=class{constructor(){this.count=null,this.current=null,this.callbacks=null}Run(e,t){this.count=e,this.current=0,this.callbacks=t,e===0?this.TaskReady():this.RunOnce()}RunBatch(e,t,i){let r=0;e>0&&(r=parseInt((e-1)/t,10)+1),this.Run(r,{runTask:(n,o)=>{let l=n*t,a=Math.min((n+1)*t,e)-1;i.runTask(l,a,o)},onReady:i.onReady})}RunOnce(){setTimeout(()=>{this.callbacks.runTask(this.current,this.TaskReady.bind(this))},0)}TaskReady(){this.current+=1,this.current<this.count?this.RunOnce():this.callbacks.onReady&&this.callbacks.onReady()}};function Ct(s){setTimeout(()=>{s()},0)}function Jn(s,e){new dr().Run(s,e)}function Zn(s,e,t){new dr().RunBatch(s,e,t)}function Qn(s){function e(t){t()&&setTimeout(()=>{e(t)},1)}e(s)}var Gi=class{constructor(e,t){this.source=t,t===Z.Url?(this.fileUrl=e,this.fileObject=null,this.name=re(e),this.extension=Ve(e)):t===Z.File?(this.fileUrl=null,this.fileObject=e,this.name=re(e.name),this.extension=Ve(e.name)):t===Z.Decompressed&&(this.fileUrl=null,this.fileObject=null,this.name=re(e),this.extension=Ve(e)),this.content=null}SetContent(e){this.content=e}},Pi=class{constructor(){this.files=[]}FillFromFileUrls(e){this.Fill(e,Z.Url)}FillFromFileObjects(e){this.Fill(e,Z.File)}ExtendFromFileList(e){for(let t=0;t<e.length;t++){let i=e[t];this.ContainsFileByPath(i.name)||this.files.push(i)}}GetFiles(){return this.files}GetContent(e){Jn(this.files.length,{runTask:(t,i)=>{this.GetFileContent(this.files[t],i)},onReady:e})}ContainsFileByPath(e){return this.FindFileByPath(e)!==null}FindFileByPath(e){let t=re(e).toLowerCase();for(let i=0;i<this.files.length;i++){let r=this.files[i];if(r.name.toLowerCase()===t)return r}return null}IsOnlyUrlSource(){if(this.files.length===0)return!1;for(let e=0;e<this.files.length;e++){let t=this.files[e];if(t.source!==Z.Url&&t.source!==Z.Decompressed)return!1}return!0}Fill(e,t){this.files=[];for(let i=0;i<e.length;i++){let r=e[i],n=new Gi(r,t);this.AddFile(n)}}AddFile(e){this.files.push(e)}GetFileContent(e,t){if(e.content!==null){t();return}let i=null;if(e.source===Z.Url)i=Yn(e.fileUrl,F.Binary);else if(e.source===Z.File)i=Kn(e.fileObject,F.Binary);else{t();return}i.then(r=>{e.SetContent(r)}).catch(()=>{}).finally(()=>{t()})}};var Me=class{constructor(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r}};function kt(s){return new Me(s[0],s[1],s[2],s[3])}function $n(s,e){let t=e/2,i=Math.sin(t);return new Me(s.x*i,s.y*i,s.z*i,Math.cos(t))}var He=class{constructor(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r}Clone(){return new He(this.x,this.y,this.z,this.w)}};var U=class{constructor(e){this.matrix=null,e!=null&&(this.matrix=e)}IsValid(){return this.matrix!==null}Set(e){return this.matrix=e,this}Get(){return this.matrix}Clone(){let e=[this.matrix[0],this.matrix[1],this.matrix[2],this.matrix[3],this.matrix[4],this.matrix[5],this.matrix[6],this.matrix[7],this.matrix[8],this.matrix[9],this.matrix[10],this.matrix[11],this.matrix[12],this.matrix[13],this.matrix[14],this.matrix[15]];return new U(e)}CreateIdentity(){return this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this}IsIdentity(){let e=new U().CreateIdentity().Get();for(let t=0;t<16;t++)if(!J(this.matrix[t],e[t]))return!1;return!0}CreateTranslation(e,t,i){return this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1],this}CreateRotation(e,t,i,r){let n=e+e,o=t+t,l=i+i,a=e*n,h=e*o,u=e*l,d=t*o,m=t*l,f=i*l,p=r*n,c=r*o,g=r*l;return this.matrix=[1-(d+f),h+g,u-c,0,h-g,1-(a+f),m+p,0,u+c,m-p,1-(a+d),0,0,0,0,1],this}CreateRotationAxisAngle(e,t){let i=$n(e,t);return this.CreateRotation(i.x,i.y,i.z,i.w)}CreateScale(e,t,i){return this.matrix=[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1],this}ComposeTRS(e,t,i){let r=e.x,n=e.y,o=e.z,l=t.x,a=t.y,h=t.z,u=t.w,d=i.x,m=i.y,f=i.z,p=l+l,c=a+a,g=h+h,x=l*p,C=l*c,M=l*g,I=a*c,S=a*g,w=h*g,y=u*p,E=u*c,b=u*g;return this.matrix=[(1-(I+w))*d,(C+b)*d,(M-E)*d,0,(C-b)*m,(1-(x+w))*m,(S+y)*m,0,(M+E)*f,(S-y)*f,(1-(x+I))*f,0,r,n,o,1],this}DecomposeTRS(){let e=new T(this.matrix[12],this.matrix[13],this.matrix[14]),t=wi(this.matrix[0],this.matrix[1],this.matrix[2]),i=wi(this.matrix[4],this.matrix[5],this.matrix[6]),r=wi(this.matrix[8],this.matrix[9],this.matrix[10]),n=this.Determinant();dt(n)&&(t*=-1);let o=new T(t,i,r),l=this.matrix[0]/t,a=this.matrix[4]/i,h=this.matrix[8]/r,u=this.matrix[1]/t,d=this.matrix[5]/i,m=this.matrix[9]/r,f=this.matrix[2]/t,p=this.matrix[6]/i,c=this.matrix[10]/r,g=null,x=l+d+c;if(x>0){let C=Math.sqrt(x+1)*2;g=new Me((p-m)/C,(h-f)/C,(u-a)/C,.25*C)}else if(l>d&&l>c){let C=Math.sqrt(1+l-d-c)*2;g=new Me(.25*C,(a+u)/C,(h+f)/C,(p-m)/C)}else if(d>c){let C=Math.sqrt(1+d-l-c)*2;g=new Me((a+u)/C,.25*C,(m+p)/C,(h-f)/C)}else{let C=Math.sqrt(1+c-l-d)*2;g=new Me((h+f)/C,(m+p)/C,.25*C,(u-a)/C)}return{translation:e,rotation:g,scale:o}}Determinant(){let e=this.matrix[0],t=this.matrix[1],i=this.matrix[2],r=this.matrix[3],n=this.matrix[4],o=this.matrix[5],l=this.matrix[6],a=this.matrix[7],h=this.matrix[8],u=this.matrix[9],d=this.matrix[10],m=this.matrix[11],f=this.matrix[12],p=this.matrix[13],c=this.matrix[14],g=this.matrix[15],x=e*o-t*n,C=e*l-i*n,M=e*a-r*n,I=t*l-i*o,S=t*a-r*o,w=i*a-r*l,y=h*p-u*f,E=h*c-d*f,b=h*g-m*f,A=u*c-d*p,k=u*g-m*p,R=d*g-m*c;return x*R-C*k+M*A+I*b-S*E+w*y}Invert(){let e=this.matrix[0],t=this.matrix[1],i=this.matrix[2],r=this.matrix[3],n=this.matrix[4],o=this.matrix[5],l=this.matrix[6],a=this.matrix[7],h=this.matrix[8],u=this.matrix[9],d=this.matrix[10],m=this.matrix[11],f=this.matrix[12],p=this.matrix[13],c=this.matrix[14],g=this.matrix[15],x=e*o-t*n,C=e*l-i*n,M=e*a-r*n,I=t*l-i*o,S=t*a-r*o,w=i*a-r*l,y=h*p-u*f,E=h*c-d*f,b=h*g-m*f,A=u*c-d*p,k=u*g-m*p,R=d*g-m*c,N=x*R-C*k+M*A+I*b-S*E+w*y;if(J(N,0))return null;let V=[(o*R-l*k+a*A)/N,(i*k-t*R-r*A)/N,(p*w-c*S+g*I)/N,(d*S-u*w-m*I)/N,(l*b-n*R-a*E)/N,(e*R-i*b+r*E)/N,(c*M-f*w-g*C)/N,(h*w-d*M+m*C)/N,(n*k-o*b+a*y)/N,(t*b-e*k-r*y)/N,(f*S-p*M+g*x)/N,(u*M-h*S-m*x)/N,(o*E-n*A-l*y)/N,(e*A-t*E+i*y)/N,(p*C-f*I-c*x)/N,(h*I-u*C+d*x)/N];return new U(V)}Transpose(){let e=[this.matrix[0],this.matrix[4],this.matrix[8],this.matrix[12],this.matrix[1],this.matrix[5],this.matrix[9],this.matrix[13],this.matrix[2],this.matrix[6],this.matrix[10],this.matrix[14],this.matrix[3],this.matrix[7],this.matrix[11],this.matrix[15]];return new U(e)}InvertTranspose(){let e=this.Invert();return e===null?null:e.Transpose()}MultiplyVector(e){let t=e.x,i=e.y,r=e.z,n=e.w,o=this.matrix[0],l=this.matrix[1],a=this.matrix[2],h=this.matrix[3],u=this.matrix[4],d=this.matrix[5],m=this.matrix[6],f=this.matrix[7],p=this.matrix[8],c=this.matrix[9],g=this.matrix[10],x=this.matrix[11],C=this.matrix[12],M=this.matrix[13],I=this.matrix[14],S=this.matrix[15];return new He(t*o+i*u+r*p+n*C,t*l+i*d+r*c+n*M,t*a+i*m+r*g+n*I,t*h+i*f+r*x+n*S)}MultiplyMatrix(e){let t=this.matrix[0],i=this.matrix[1],r=this.matrix[2],n=this.matrix[3],o=this.matrix[4],l=this.matrix[5],a=this.matrix[6],h=this.matrix[7],u=this.matrix[8],d=this.matrix[9],m=this.matrix[10],f=this.matrix[11],p=this.matrix[12],c=this.matrix[13],g=this.matrix[14],x=this.matrix[15],C=e.matrix[0],M=e.matrix[1],I=e.matrix[2],S=e.matrix[3],w=e.matrix[4],y=e.matrix[5],E=e.matrix[6],b=e.matrix[7],A=e.matrix[8],k=e.matrix[9],R=e.matrix[10],N=e.matrix[11],V=e.matrix[12],ae=e.matrix[13],H=e.matrix[14],Ie=e.matrix[15],ke=[t*C+i*w+r*A+n*V,t*M+i*y+r*k+n*ae,t*I+i*E+r*R+n*H,t*S+i*b+r*N+n*Ie,o*C+l*w+a*A+h*V,o*M+l*y+a*k+h*ae,o*I+l*E+a*R+h*H,o*S+l*b+a*N+h*Ie,u*C+d*w+m*A+f*V,u*M+d*y+m*k+f*ae,u*I+d*E+m*R+f*H,u*S+d*b+m*N+f*Ie,p*C+c*w+g*A+x*V,p*M+c*y+g*k+x*ae,p*I+c*E+g*R+x*H,p*S+c*b+g*N+x*Ie];return new U(ke)}};var q=class{constructor(e){e!=null?this.matrix=e:(this.matrix=new U,this.matrix.CreateIdentity())}SetMatrix(e){return this.matrix=e,this}GetMatrix(){return this.matrix}IsIdentity(){return this.matrix.IsIdentity()}AppendMatrix(e){return this.matrix=this.matrix.MultiplyMatrix(e),this}Append(e){return this.AppendMatrix(e.GetMatrix()),this}TransformCoord3D(e){let t=new He(e.x,e.y,e.z,1),i=this.matrix.MultiplyVector(t);return new T(i.x,i.y,i.z)}Clone(){let e=this.matrix.Clone();return new q(e)}};var Ze=class{constructor(){this.name=null,this.url=null,this.buffer=null,this.offset=new B(0,0),this.scale=new B(1,1),this.rotation=0}IsValid(){return this.name!==null&&this.url!==null&&this.buffer!==null}HasTransformation(){return!mt(this.offset,new B(0,0))||!mt(this.scale,new B(1,1))||!J(this.rotation,0)}IsEqual(e){return!(this.name!==e.name||this.url!==e.url||!mt(this.offset,e.offset)||!mt(this.scale,e.scale)||!J(this.rotation,e.rotation))}};function Ut(s,e){return s===null&&e===null?!0:s===null||e===null?!1:s.IsEqual(e)}var Y={Phong:1,Physical:2},es=class{constructor(e){this.type=e,this.isDefault=!1,this.name="",this.color=new D(0,0,0),this.vertexColors=!1}IsEqual(e){return!(this.type!==e.type||this.isDefault!==e.isDefault||this.name!==e.name||!pt(this.color,e.color)||this.vertexColors!==e.vertexColors)}},mr=class extends es{constructor(e){super(e);this.emissive=new D(0,0,0),this.opacity=1,this.transparent=!1,this.diffuseMap=null,this.bumpMap=null,this.normalMap=null,this.emissiveMap=null,this.alphaTest=0,this.multiplyDiffuseMap=!1}IsEqual(e){return!(!super.IsEqual(e)||!pt(this.emissive,e.emissive)||!J(this.opacity,e.opacity)||this.transparent!==e.transparent||!Ut(this.diffuseMap,e.diffuseMap)||!Ut(this.bumpMap,e.bumpMap)||!Ut(this.normalMap,e.normalMap)||!Ut(this.emissiveMap,e.emissiveMap)||!J(this.alphaTest,e.alphaTest)||this.multiplyDiffuseMap!==e.multiplyDiffuseMap)}EnumerateTextureMaps(e){this.diffuseMap!==null&&e(this.diffuseMap),this.bumpMap!==null&&e(this.bumpMap),this.normalMap!==null&&e(this.normalMap),this.emissiveMap!==null&&e(this.emissiveMap)}},K=class extends mr{constructor(){super(Y.Phong);this.ambient=new D(0,0,0),this.specular=new D(0,0,0),this.shininess=0,this.specularMap=null}IsEqual(e){return!(!super.IsEqual(e)||!pt(this.ambient,e.ambient)||!pt(this.specular,e.specular)||!J(this.shininess,e.shininess)||!Ut(this.specularMap,e.specularMap))}EnumerateTextureMaps(e){super.EnumerateTextureMaps(e),this.specularMap!==null&&e(this.specularMap)}},vt=class extends mr{constructor(){super(Y.Physical);this.metalness=0,this.roughness=1,this.metalnessMap=null}IsEqual(e){return!(!super.IsEqual(e)||!J(this.metalness,e.metalness)||!J(this.roughness,e.roughness)||!Ut(this.metalnessMap,e.metalnessMap))}EnumerateTextureMaps(e){super.EnumerateTextureMaps(e),this.metalnessMap!==null&&e(this.metalnessMap)}};var rt={Empty:0,TriangleMesh:1};function Ht(s){return s.TriangleCount()>0?rt.TriangleMesh:rt.Empty}function Zt(s,e,t){let i=oe(e,s),r=oe(t,s),n=Ye(i,r);return n.Normalize(),n}function nt(s,e){if(!e.IsIdentity()){for(let t=0;t<s.VertexCount();t++){let i=s.GetVertex(t),r=e.TransformCoord3D(i);i.x=r.x,i.y=r.y,i.z=r.z}if(s.NormalCount()>0){let t=e.GetMatrix().InvertTranspose();if(t!==null){let i=new q(t);for(let r=0;r<s.NormalCount();r++){let n=s.GetNormal(r),o=i.TransformCoord3D(n);n.x=o.x,n.y=o.y,n.z=o.z}}}}}function ts(s){for(let e=0;e<s.TriangleCount();e++){let t=s.GetTriangle(e),i=t.v1;t.v1=t.v2,t.v2=i}}var _i=class{constructor(e,t){this.min=e,this.max=t}GetMin(){return this.min}GetMax(){return this.max}GetCenter(){return new T((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,(this.min.z+this.max.z)/2)}},fr=class{constructor(){this.box=new _i(new T(1/0,1/0,1/0),new T(-1/0,-1/0,-1/0)),this.isValid=!1}GetBox(){return this.isValid?this.box:null}AddPoint(e){this.box.min.x=Math.min(this.box.min.x,e.x),this.box.min.y=Math.min(this.box.min.y,e.y),this.box.min.z=Math.min(this.box.min.z,e.z),this.box.max.x=Math.max(this.box.max.x,e.x),this.box.max.y=Math.max(this.box.max.y,e.y),this.box.max.z=Math.max(this.box.max.z,e.z),this.isValid=!0}};var Ri=class{constructor(e,t){this.boundingBox=e,this.level=t,this.pointItems=[],this.childNodes=[]}AddPoint(e,t,i){let r=this.FindNodeForPoint(e);if(r===null||r.FindPointDirectly(e)!==null)return!1;if(r.pointItems.length<i.maxPointsPerNode||r.level>=i.maxTreeDepth)return r.AddPointDirectly(e,t),!0;{r.CreateChildNodes();let n=r.pointItems;r.pointItems=[];for(let o=0;o<n.length;o++){let l=n[o];if(!r.AddPoint(l.point,l.data,i))return!1}return r.AddPoint(e,t,i)}}FindPoint(e){let t=this.FindNodeForPoint(e);return t===null?null:t.FindPointDirectly(e)}AddPointDirectly(e,t){this.pointItems.push({point:e,data:t})}FindPointDirectly(e){for(let t=0;t<this.pointItems.length;t++){let i=this.pointItems[t];if(Fe(e,i.point))return i.data}return null}FindNodeForPoint(e){if(!this.IsPointInBounds(e))return null;if(this.childNodes.length===0)return this;for(let t=0;t<this.childNodes.length;t++){let r=this.childNodes[t].FindNodeForPoint(e);if(r!==null)return r}return null}CreateChildNodes(){function e(l,a,h,u,d,m,f){let p=new _i(new T(a,h,u),new T(a+d,h+m,u+f));l.childNodes.push(new Ri(p,l.level+1))}let t=this.boundingBox.min,i=this.boundingBox.GetCenter(),r=(this.boundingBox.max.x-this.boundingBox.min.x)/2,n=(this.boundingBox.max.y-this.boundingBox.min.y)/2,o=(this.boundingBox.max.z-this.boundingBox.min.z)/2;e(this,t.x,t.y,t.z,r,n,o),e(this,i.x,t.y,t.z,r,n,o),e(this,t.x,i.y,t.z,r,n,o),e(this,i.x,i.y,t.z,r,n,o),e(this,t.x,t.y,i.z,r,n,o),e(this,i.x,t.y,i.z,r,n,o),e(this,t.x,i.y,i.z,r,n,o),e(this,i.x,i.y,i.z,r,n,o)}IsPointInBounds(e){return xi(e.x,this.boundingBox.min.x)&&xi(e.y,this.boundingBox.min.y)&&xi(e.z,this.boundingBox.min.z)&&gi(e.x,this.boundingBox.max.x)&&gi(e.y,this.boundingBox.max.y)&&gi(e.z,this.boundingBox.max.z)}},cr=class{constructor(e,t){this.options={maxPointsPerNode:10,maxTreeDepth:10},t!==void 0&&(t.maxPointsPerNode!==void 0&&(this.options.maxPointsPerNode=t.maxPointsPerNode),t.maxTreeDepth!==void 0&&(this.options.maxTreeDepth=t.maxTreeDepth)),this.rootNode=new Ri(e,0)}AddPoint(e,t){return this.rootNode.AddPoint(e,t,this.options)}FindPoint(e){return this.rootNode.FindPoint(e)}};var is=class{constructor(){this.edges=[],this.triangles=[]}},rs=class{constructor(e,t){this.vertex1=e,this.vertex2=t,this.triangles=[]}},ns=class{constructor(e,t){this.edge=e,this.reversed=t}},ss=class{constructor(){this.triEdge1=null,this.triEdge2=null,this.triEdge3=null}},pr=class{constructor(){this.vertices=[],this.edges=[],this.triangleEdges=[],this.triangles=[],this.edgeStartToEndVertexMap=new Map}AddVertex(){return this.vertices.push(new is),this.vertices.length-1}AddTriangle(e,t,i){function r(h,u,d){h[u].triangles.push(d)}function n(h,u,d,m){let f=h[d],p=u[m];f.edges.push(p.edge)}function o(h,u,d,m){let f=u[d];h[f.edge].triangles.push(m)}let l=this.triangles.length,a=new ss;a.triEdge1=this.AddTriangleEdge(e,t),a.triEdge2=this.AddTriangleEdge(t,i),a.triEdge3=this.AddTriangleEdge(i,e),r(this.vertices,e,l),r(this.vertices,t,l),r(this.vertices,i,l),n(this.vertices,this.triangleEdges,e,a.triEdge1),n(this.vertices,this.triangleEdges,t,a.triEdge2),n(this.vertices,this.triangleEdges,i,a.triEdge3),o(this.edges,this.triangleEdges,a.triEdge1,l),o(this.edges,this.triangleEdges,a.triEdge2,l),o(this.edges,this.triangleEdges,a.triEdge3,l),this.triangles.push(a)}AddTriangleEdge(e,t){let i=e,r=t,n=!1;t<e&&(i=t,r=e,n=!0);let o=this.AddEdge(i,r);return this.triangleEdges.push(new ns(o,n)),this.triangleEdges.length-1}AddEdge(e,t){this.edgeStartToEndVertexMap.has(e)||this.edgeStartToEndVertexMap.set(e,[]);let i=this.edgeStartToEndVertexMap.get(e);for(let n=0;n<i.length;n++){let o=i[n];if(o.endVertex===t)return o.edgeIndex}let r=this.edges.length;return i.push({endVertex:t,edgeIndex:r}),this.edges.push(new rs(e,t)),r}};function Fi(s){let e=!0;return s.EnumerateMeshInstances(t=>{Ht(t)!==rt.Empty&&(e=!1)}),e}function gr(s){let e=new fr;return s.EnumerateVertices(t=>{e.AddPoint(t)}),e.GetBox()}function co(s){function e(n,o,l){let a=o.FindPoint(n);return a===null&&(a=l.AddVertex(),o.AddPoint(n,a)),a}let t=gr(s),i=new cr(t),r=new pr;return s.EnumerateTriangleVertices((n,o,l)=>{let a=e(n,i,r),h=e(o,i,r),u=e(l,i,r);r.AddTriangle(a,h,u)}),r}function os(s){function e(i,r,n){let o=i.triangles[r],l=i.triangleEdges[o.triEdge1],a=i.triangleEdges[o.triEdge2],h=i.triangleEdges[o.triEdge3];return l.edge===n?l.reversed:a.edge===n?a.reversed:h.edge===n?h.reversed:null}let t=co(s);for(let i=0;i<t.edges.length;i++){let r=t.edges[i],n=r.triangles.length;if(n===0||n%2!==0)return!1;let o=0;for(let l=0;l<r.triangles.length;l++){let a=r.triangles[l];e(t,a,i)?o+=1:o-=1}if(o!==0)return!1}return!0}function ls(s){for(let e=0;e<s.MaterialCount();e++){let t=s.GetMaterial(e);if(t.isDefault&&!t.vertexColors)return!0}return!1}function xr(s,e){for(let t=0;t<s.MaterialCount();t++){let i=s.GetMaterial(t);i.isDefault&&(i.color=e)}}var _={Text:1,Integer:2,Number:3,Boolean:4,Percent:5,Color:6},L=class{constructor(e,t,i){this.type=e,this.name=t,this.value=i}},Ae=class{constructor(e){this.name=e,this.properties=[]}PropertyCount(){return this.properties.length}AddProperty(e){this.properties.push(e)}GetProperty(e){return this.properties[e]}};var as=class{constructor(){}VertexCount(){return 0}VertexColorCount(){return 0}NormalCount(){return 0}TextureUVCount(){return 0}TriangleCount(){return 0}EnumerateVertices(e){}EnumerateTriangleVertexIndices(e){}EnumerateTriangleVertices(e){}},It=class extends as{constructor(){super();this.name="",this.propertyGroups=[]}GetName(){return this.name}SetName(e){this.name=e}PropertyGroupCount(){return this.propertyGroups.length}AddPropertyGroup(e){return this.propertyGroups.push(e),this.propertyGroups.length-1}GetPropertyGroup(e){return this.propertyGroups[e]}};var X=class extends It{constructor(){super();this.vertices=[],this.vertexColors=[],this.normals=[],this.uvs=[],this.triangles=[]}VertexCount(){return this.vertices.length}VertexColorCount(){return this.vertexColors.length}NormalCount(){return this.normals.length}TextureUVCount(){return this.uvs.length}TriangleCount(){return this.triangles.length}AddVertex(e){return this.vertices.push(e),this.vertices.length-1}SetVertex(e,t){this.vertices[e]=t}GetVertex(e){return this.vertices[e]}AddVertexColor(e){return this.vertexColors.push(e),this.vertexColors.length-1}SetVertexColor(e,t){this.vertexColors[e]=t}GetVertexColor(e){return this.vertexColors[e]}AddNormal(e){return this.normals.push(e),this.normals.length-1}SetNormal(e,t){this.normals[e]=t}GetNormal(e){return this.normals[e]}AddTextureUV(e){return this.uvs.push(e),this.uvs.length-1}SetTextureUV(e,t){this.uvs[e]=t}GetTextureUV(e){return this.uvs[e]}AddTriangle(e){return this.triangles.push(e),this.triangles.length-1}GetTriangle(e){return this.triangles[e]}EnumerateVertices(e){for(let t of this.vertices)e(t)}EnumerateTriangleVertexIndices(e){for(let t of this.triangles)e(t.v0,t.v1,t.v2)}EnumerateTriangleVertices(e){for(let t of this.triangles){let i=this.vertices[t.v0],r=this.vertices[t.v1],n=this.vertices[t.v2];e(i,r,n)}}Clone(){let e=new X;e.SetName(this.GetName());for(let t=0;t<this.VertexCount();t++){let i=this.GetVertex(t);e.AddVertex(i.Clone())}for(let t=0;t<this.VertexColorCount();t++){let i=this.GetVertexColor(t);e.AddVertexColor(i.Clone())}for(let t=0;t<this.NormalCount();t++){let i=this.GetNormal(t);e.AddNormal(i.Clone())}for(let t=0;t<this.TextureUVCount();t++){let i=this.GetTextureUV(t);e.AddTextureUV(i.Clone())}for(let t=0;t<this.TriangleCount();t++){let i=this.GetTriangle(t);e.AddTriangle(i.Clone())}return e}};var z=class{constructor(e,t,i){this.v0=e,this.v1=t,this.v2=i,this.c0=null,this.c1=null,this.c2=null,this.n0=null,this.n1=null,this.n2=null,this.u0=null,this.u1=null,this.u2=null,this.mat=null,this.curve=null}HasVertices(){return this.v0!==null&&this.v1!==null&&this.v2!==null}HasVertexColors(){return this.c0!==null&&this.c1!==null&&this.c2!==null}HasNormals(){return this.n0!==null&&this.n1!==null&&this.n2!==null}HasTextureUVs(){return this.u0!==null&&this.u1!==null&&this.u2!==null}SetVertices(e,t,i){return this.v0=e,this.v1=t,this.v2=i,this}SetVertexColors(e,t,i){return this.c0=e,this.c1=t,this.c2=i,this}SetNormals(e,t,i){return this.n0=e,this.n1=t,this.n2=i,this}SetTextureUVs(e,t,i){return this.u0=e,this.u1=t,this.u2=i,this}SetMaterial(e){return this.mat=e,this}SetCurve(e){return this.curve=e,this}Clone(){let e=new z(this.v0,this.v1,this.v2);return e.SetVertexColors(this.c0,this.c1,this.c2),e.SetNormals(this.n0,this.n1,this.n2),e.SetTextureUVs(this.u0,this.u1,this.u2),e.SetMaterial(this.mat),e.SetCurve(this.curve),e}};function hs(){let s=document.createElement("canvas");document.body.appendChild(s);let e={canvas:s,antialias:!0},t=new THREE.WebGLRenderer(e);t.setClearColor("#ffffff",1),t.setSize(10,10);let i=new THREE.Scene,r=new THREE.AmbientLight(8947848);i.add(r);let n=new THREE.DirectionalLight(8947848);n.position.set(0,0,1),i.add(n);let o=new THREE.PerspectiveCamera(45,1,.1,1e3);o.position.set(0,0,1),o.up.set(0,1,0),o.lookAt(new THREE.Vector3(0,0,0)),i.add(o);let l=new THREE.PlaneGeometry(1,1),a=new THREE.Mesh(l,new THREE.MeshPhongMaterial({color:13369344}));i.add(a),t.render(i,o);let h=t.getContext(),u=new Uint8Array(4);h.readPixels(5,5,1,1,h.RGBA,h.UNSIGNED_BYTE,u),document.body.removeChild(s);let d=50;return u[0]<d&&u[1]<d&&u[2]<d}var me={Phong:1,Physical:2};function us(s){let e=0,t=0;for(let i=0;i<s.MaterialCount();i++){let r=s.GetMaterial(i);r.type===Y.Phong?e+=1:r.type===Y.Physical&&(t+=1)}return e>=t?me.Phong:me.Physical}function Ni(s){return Re(s.r,s.g,s.b)}function De(s){return new THREE.Color(s.r/255,s.g/255,s.b/255)}function Tt(s,e){let t=new X,i=s.attributes.position.array,r=s.attributes.position.itemSize||3;for(let h=0;h<i.length;h+=r){let u=i[h],d=i[h+1],m=i[h+2];t.AddVertex(new T(u,d,m))}let n=s.attributes.color!==void 0;if(n){let h=s.attributes.color.array,u=s.attributes.color.itemSize||3;for(let d=0;d<h.length;d+=u){let m=new THREE.Color(h[d],h[d+1],h[d+2]);t.AddVertexColor(Ni(m))}}let o=s.attributes.normal!==void 0;if(o){let h=s.attributes.normal.array,u=s.attributes.normal.itemSize||3;for(let d=0;d<h.length;d+=u){let m=h[d],f=h[d+1],p=h[d+2];t.AddNormal(new T(m,f,p))}}let l=s.attributes.uv!==void 0;if(l){let h=s.attributes.uv.array,u=s.attributes.uv.itemSize||2;for(let d=0;d<h.length;d+=u){let m=h[d],f=h[d+1];t.AddTextureUV(new B(m,f))}}let a=null;if(s.index!==null)a=s.index.array;else{a=[];for(let h=0;h<i.length/3;h++)a.push(h)}for(let h=0;h<a.length;h+=3){let u=a[h],d=a[h+1],m=a[h+2],f=new z(u,d,m);n&&f.SetVertexColors(u,d,m),o&&f.SetNormals(u,d,m),l&&f.SetTextureUVs(u,d,m),e!==null&&f.SetMaterial(e),t.AddTriangle(f)}return t}var st=class{constructor(e,t){this.nodeId=e,this.meshIndex=t}IsEqual(e){return this.nodeId===e.nodeId&&this.meshIndex===e.meshIndex}GetKey(){return this.nodeId.toString()+":"+this.meshIndex.toString()}},Vi=class extends It{constructor(e,t,i){super();this.id=e,this.node=t,this.mesh=i}GetId(){return this.id}GetTransformation(){return this.node.GetWorldTransformation()}GetMesh(){return this.mesh}VertexCount(){return this.mesh.VertexCount()}VertexColorCount(){return this.mesh.VertexColorCount()}NormalCount(){return this.mesh.NormalCount()}TextureUVCount(){return this.mesh.TextureUVCount()}TriangleCount(){return this.mesh.TriangleCount()}EnumerateVertices(e){let t=this.node.GetWorldTransformation();t.IsIdentity()?this.mesh.EnumerateVertices(e):this.mesh.EnumerateVertices(i=>{let r=t.TransformCoord3D(i);e(r)})}EnumerateTriangleVertexIndices(e){this.mesh.EnumerateTriangleVertexIndices(e)}EnumerateTriangleVertices(e){let t=this.node.GetWorldTransformation();t.IsIdentity()?this.mesh.EnumerateTriangleVertices(e):this.mesh.EnumerateTriangleVertices((i,r,n)=>{let o=t.TransformCoord3D(i),l=t.TransformCoord3D(r),a=t.TransformCoord3D(n);e(o,l,a)})}PropertyGroupCount(){return this.mesh.PropertyGroupCount()}AddPropertyGroup(e){return this.mesh.AddPropertyGroup(e)}GetPropertyGroup(e){return this.mesh.GetPropertyGroup(e)}GetTransformedMesh(){let e=this.node.GetWorldTransformation(),t=this.mesh.Clone();return nt(t,e),t}};var ds=class{constructor(){this.nextId=0}GenerateId(){let e=this.nextId;return this.nextId+=1,e}},fe={GroupNode:0,MeshNode:1},ye=class{constructor(){this.type=fe.GroupNode,this.name="",this.parent=null,this.transformation=new q,this.childNodes=[],this.meshIndices=[],this.idGenerator=new ds,this.id=this.idGenerator.GenerateId()}IsEmpty(){return this.childNodes.length===0&&this.meshIndices.length===0}GetType(){return this.type}SetType(e){this.type=e}GetId(){return this.id}GetName(){return this.name}SetName(e){this.name=e}HasParent(){return this.parent!==null}GetParent(){return this.parent}GetTransformation(){return this.transformation}GetWorldTransformation(){let e=this.transformation.Clone(),t=this.parent;for(;t!==null;)e.Append(t.transformation),t=t.parent;return e}SetTransformation(e){this.transformation=e}AddChildNode(e){return e.parent=this,e.idGenerator=this.idGenerator,e.id=e.idGenerator.GenerateId(),this.childNodes.push(e),this.childNodes.length-1}RemoveChildNode(e){e.parent=null;let t=this.childNodes.indexOf(e);this.childNodes.splice(t,1)}GetChildNodes(){return this.childNodes}ChildNodeCount(){return this.childNodes.length}GetChildNode(e){return this.childNodes[e]}AddMeshIndex(e){return this.meshIndices.push(e),this.meshIndices.length-1}MeshIndexCount(){return this.meshIndices.length}GetMeshIndex(e){return this.meshIndices[e]}GetMeshIndices(){return this.meshIndices}Enumerate(e){e(this);for(let t of this.childNodes)t.Enumerate(e)}EnumerateChildren(e){for(let t of this.childNodes)e(t),t.EnumerateChildren(e)}EnumerateMeshIndices(e){for(let t of this.meshIndices)e(t);for(let t of this.childNodes)t.EnumerateMeshIndices(e)}};var Cr=class extends It{constructor(){super();this.root=new ye,this.materials=[],this.meshes=[]}GetRootNode(){return this.root}MaterialCount(){return this.materials.length}MeshCount(){return this.meshes.length}MeshInstanceCount(){let e=0;return this.root.Enumerate(t=>{e+=t.MeshIndexCount()}),e}VertexCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.VertexCount()}),e}VertexColorCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.VertexColorCount()}),e}NormalCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.NormalCount()}),e}TextureUVCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.TextureUVCount()}),e}TriangleCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.TriangleCount()}),e}AddMaterial(e){return this.materials.push(e),this.materials.length-1}GetMaterial(e){return this.materials[e]}AddMesh(e){return this.meshes.push(e),this.meshes.length-1}AddMeshToRootNode(e){let t=this.AddMesh(e);return this.root.AddMeshIndex(t),t}RemoveMesh(e){this.meshes.splice(e,1),this.root.Enumerate(t=>{for(let i=0;i<t.meshIndices.length;i++)t.meshIndices[i]===e?(t.meshIndices.splice(i,1),i-=1):t.meshIndices[i]>e&&(t.meshIndices[i]-=1)})}GetMesh(e){return this.meshes[e]}GetMeshInstance(e){let t=null;if(this.root.Enumerate(o=>{o.GetId()===e.nodeId&&(t=o)}),t===null||t.GetMeshIndices().indexOf(e.meshIndex)===-1)return null;let r=this.GetMesh(e.meshIndex),n=new st(t.GetId(),e.meshIndex);return new Vi(n,t,r)}EnumerateMeshes(e){for(let t of this.meshes)e(t)}EnumerateMeshInstances(e){this.root.Enumerate(t=>{for(let i of t.GetMeshIndices()){let r=new st(t.GetId(),i),n=this.GetMesh(i),o=new Vi(r,t,n);e(o)}})}EnumerateTransformedMeshes(e){this.EnumerateMeshInstances(t=>{let i=t.GetTransformedMesh();e(i)})}EnumerateVertices(e){this.EnumerateMeshInstances(t=>{t.EnumerateVertices(e)})}EnumerateTriangleVertexIndices(e){this.EnumerateMeshInstances(t=>{t.EnumerateTriangleVertexIndices(e)})}EnumerateTriangleVertices(e){this.EnumerateMeshInstances(t=>{t.EnumerateTriangleVertices(e)})}};function zt(s){return s!=null}function ze(s,e){return s??e}function Li(s,e){if(!!zt(s))for(let t of Object.keys(s))zt(s[t])&&(e[t]=s[t])}var ms=class{constructor(e){this.params={getDefaultMaterialColor:()=>new D(0,0,0)},Li(e,this.params),this.defaultMaterialIndex=null}Finalize(e){this.Reset(),this.FinalizeMeshes(e),this.FinalizeMaterials(e),this.FinalizeNodes(e)}FinalizeMaterials(e){if(!(e.VertexColorCount()>0))return;let i=new Map;for(let r=0;r<e.MeshCount();r++){let n=e.GetMesh(r);for(let o=0;o<n.TriangleCount();o++){let l=n.GetTriangle(o),a=l.HasVertexColors();i.has(l.mat)?a||i.set(l.mat,!1):i.set(l.mat,a)}}for(let[r,n]of i){let o=e.GetMaterial(r);o.vertexColors=n}}FinalizeMeshes(e){for(let t=0;t<e.MeshCount();t++){let i=e.GetMesh(t);if(Ht(i)===rt.Empty){e.RemoveMesh(t),t=t-1;continue}this.FinalizeMesh(e,i)}}FinalizeMesh(e,t){function i(n){function o(h,u,d,m,f){function p(C,M){for(let I=0;I<C.length;I++){let S=C[I];if(Fe(S,M))return!0}return!1}let c=[],g=f.get(d);for(let C=0;C<g.length;C++){let M=g[C],I=h.GetTriangle(M);if(u.curve===I.curve){let S=m[M];p(c,S)||c.push(S)}}let x=new T(0,0,0);for(let C=0;C<c.length;C++)x=zn(x,c[C]);return x.MultiplyScalar(1/c.length),x.Normalize(),h.AddNormal(x)}let l=[],a=new Map;for(let h=0;h<n.VertexCount();h++)a.set(h,[]);for(let h=0;h<n.TriangleCount();h++){let u=n.GetTriangle(h),d=n.GetVertex(u.v0),m=n.GetVertex(u.v1),f=n.GetVertex(u.v2),p=Zt(d,m,f);l.push(p),a.get(u.v0).push(h),a.get(u.v1).push(h),a.get(u.v2).push(h)}for(let h=0;h<n.TriangleCount();h++){let u=n.GetTriangle(h);if(!u.HasNormals()){let d=o(n,u,u.v0,l,a),m=o(n,u,u.v1,l,a),f=o(n,u,u.v2,l,a);u.SetNormals(d,m,f)}}}let r={calculateCurveNormals:!1};for(let n=0;n<t.TriangleCount();n++){let o=t.GetTriangle(n);this.FinalizeTriangle(t,o,r),o.mat===null&&(o.mat=this.GetDefaultMaterialIndex(e))}r.calculateCurveNormals&&i(t)}FinalizeTriangle(e,t,i){if(!t.HasNormals())if(t.curve===null||t.curve===0){let r=e.GetVertex(t.v0),n=e.GetVertex(t.v1),o=e.GetVertex(t.v2),l=Zt(r,n,o),a=e.AddNormal(l);t.SetNormals(a,a,a)}else i.calculateCurveNormals=!0;t.curve===null&&(t.curve=0)}FinalizeNodes(e){let t=e.GetRootNode(),i=[];t.EnumerateChildren(r=>{r.IsEmpty()&&i.push(r)});for(let r=0;r<i.length;r++){let n=i[r],o=n.GetParent();o!==null&&(o.RemoveChildNode(n),o.IsEmpty()&&i.push(o))}}GetDefaultMaterialIndex(e){if(this.defaultMaterialIndex===null){let t=this.params.getDefaultMaterialColor(),i=new K;i.color=t,i.isDefault=!0,this.defaultMaterialIndex=e.AddMaterial(i)}return this.defaultMaterialIndex}Reset(){this.defaultMaterialIndex=null}};function fs(s,e){new ms(e).Finalize(s)}var W=class{constructor(){this.name=null,this.extension=null,this.callbacks=null,this.model=null,this.error=null,this.message=null}Import(e,t,i,r){this.Clear(),this.name=e,this.extension=t,this.callbacks=r,this.model=new Cr,this.error=!1,this.message=null,this.ResetContent(),this.ImportContent(i,()=>{this.CreateResult(r)})}Clear(){this.name=null,this.extension=null,this.callbacks=null,this.model=null,this.error=null,this.message=null,this.ClearContent()}CreateResult(e){if(this.error){e.onError(),e.onComplete();return}if(Fi(this.model)){this.SetError("The model doesn't contain any meshes."),e.onError(),e.onComplete();return}fs(this.model,{getDefaultMaterialColor:this.callbacks.getDefaultMaterialColor}),e.onSuccess(),e.onComplete()}CanImportExtension(e){return!1}GetUpDirection(){return G.Z}ClearContent(){}ResetContent(){}ImportContent(e,t){}GetModel(){return this.model}SetError(e){this.error=!0,e!=null&&(this.message=e)}WasError(){return this.error}GetErrorMessage(){return this.message}};function ot(s,e,t){let i=s.substring(e),r=i.indexOf(t);return r!==-1&&(i=i.substring(0,r)),i.trim()}function Qe(s,e){if(e!==null){let t=s.indexOf(e);t!==-1&&(s=s.substring(0,t).trim())}return s.split(/\s+/u)}function Ge(s,e){function t(n,o){let l=n.trim();l.length>0&&o(l)}let i=0,r=s.indexOf(`
`,i);for(;r!==-1;)t(s.substring(i,r),e),i=r+1,r=s.indexOf(`
`,i);t(s.substring(i),e)}function ce(s){s.transparent=!1,pi(s.opacity,1)&&(s.transparent=!0)}var vr=class{constructor(e){this.createMaterialFunc=e,this.colorToMaterialIndex=new Map}GetMaterialIndex(e){let t=ue(e);if(this.colorToMaterialIndex.has(t))return this.colorToMaterialIndex.get(t);{let i=this.createMaterialFunc(e);return this.colorToMaterialIndex.set(t,i),i}}};var Ir=class extends W{constructor(){super();this.rhino=null}CanImportExtension(e){return e==="3dm"}GetUpDirection(){return G.Z}ClearContent(){this.instanceIdToObject=null,this.instanceIdToDefinition=null}ResetContent(){this.instanceIdToObject=new Map,this.instanceIdToDefinition=new Map}ImportContent(e,t){this.rhino===null?ge("loaders/rhino3dm.min.js").then(()=>{rhino3dm().then(i=>{this.rhino=i,this.ImportRhinoContent(e),t()})}).catch(()=>{this.SetError("Failed to load rhino3dm."),t()}):(this.ImportRhinoContent(e),t())}ImportRhinoContent(e){let t=this.rhino.File3dm.fromByteArray(e);if(t===null){this.SetError("Failed to read Rhino file.");return}this.ImportRhinoDocument(t),Fi(this.model)&&this.SetError("The model doesn't contain any 3D meshes. Try to save the model while you are in shaded view in Rhino.")}ImportRhinoDocument(e){this.InitRhinoInstances(e),this.ImportRhinoUserStrings(e),this.ImportRhinoGeometry(e)}InitRhinoInstances(e){let t=e.objects();for(let r=0;r<t.count;r++){let n=t.get(r),o=n.attributes();o.isInstanceDefinitionObject&&this.instanceIdToObject.set(o.id,n)}let i=e.instanceDefinitions();for(let r=0;r<i.count();r++){let n=i.get(r);this.instanceIdToDefinition.set(n.id,n)}}ImportRhinoUserStrings(e){let t=e.strings();if(t.count()>0){let i=new Ae("Document user texts");for(let r=0;r<t.count();r++){let n=t.get(r);i.AddProperty(new L(_.Text,n[0],n[1]))}this.model.AddPropertyGroup(i)}}ImportRhinoGeometry(e){let t=e.objects();for(let i=0;i<t.count;i++){let r=t.get(i);this.ImportRhinoGeometryObject(e,r,[])}}ImportRhinoGeometryObject(e,t,i){let r=t.geometry(),n=t.attributes(),o=r.objectType;if(n.isInstanceDefinitionObject&&i.length===0)return;let l=null,a=!1;if(o===this.rhino.ObjectType.Mesh)l=r,a=!1;else if(o===this.rhino.ObjectType.Extrusion)l=r.getMesh(this.rhino.MeshType.Any),a=!0;else if(o===this.rhino.ObjectType.Brep){l=new this.rhino.Mesh;let h=r.faces();for(let u=0;u<h.count;u++){let d=h.get(u),m=d.getMesh(this.rhino.MeshType.Any);m&&(l.append(m),m.delete()),d.delete()}h.delete(),l.compact(),a=!0}else if(o===this.rhino.ObjectType.SubD)r.subdivide(3),l=this.rhino.Mesh.createFromSubDControlNet(r),a=!0;else if(o===this.rhino.ObjectType.InstanceReference){let h=r.parentIdefId;if(this.instanceIdToDefinition.has(h)){let d=this.instanceIdToDefinition.get(h).getObjectIds();for(let m=0;m<d.length;m++){let f=d[m];if(this.instanceIdToObject.has(f)){let p=this.instanceIdToObject.get(f);i.push(t),this.ImportRhinoGeometryObject(e,p,i),i.pop()}}}}l!==null&&(this.ImportRhinoMesh(e,l,t,i),a&&l.delete())}ImportRhinoMesh(e,t,i,r){let n=i.attributes(),o=this.GetMaterialIndex(e,i,r),l=t.toThreejsJSON(),a=Tt(l.data,o);a.SetName(n.name);let h=n.getUserStrings();if(h.length>0){let u=new Ae("User texts");for(let d=0;d<h.length;d++){let m=h[d];u.AddProperty(new L(_.Text,m[0],m[1]))}a.AddPropertyGroup(u)}if(r.length!==0){let u=new U().CreateIdentity();for(let m=r.length-1;m>=0;m--){let c=r[m].geometry().xform.toFloatArray(!1),g=new U(c);u=u.MultiplyMatrix(g)}let d=new q(u);nt(a,d)}this.model.AddMeshToRootNode(a)}GetMaterialIndex(e,t,i){function r(l,a,h){let u=a.attributes();if(u.materialSource===l.ObjectMaterialSource.MaterialFromObject){let d=u.materialIndex;if(d>-1)return e.materials().get(d)}else if(u.materialSource===l.ObjectMaterialSource.MaterialFromLayer){let d=u.layerIndex;if(d>-1){let f=e.layers().get(d).renderMaterialIndex;if(f>-1)return e.materials().get(f)}}else if(u.materialSource===l.ObjectMaterialSource.MaterialFromParent&&h.length!==0)return r(l,h[0],[]);return null}function n(l,a){function h(f,p){f.Set(p.r,p.g,p.b)}function u(f){return f.r===0&&f.g===0&&f.b===0}function d(f){return f.r===255&&f.g===255&&f.b===255}let m=null;if(a===null)m=new K,m.color.Set(255,255,255);else{let f=a.physicallyBased();f.supported?(m=new vt,m.metalness=f.metallic?1:0,m.roughness=f.roughness):(m=new K,h(m.ambient,a.ambientColor),h(m.specular,a.specularColor)),m.name=a.name,h(m.color,a.diffuseColor),m.opacity=1-a.transparency,ce(m),u(m.color)&&!d(a.reflectionColor)&&h(m.color,a.reflectionColor),u(m.color)&&!d(a.transparentColor)&&h(m.color,a.transparentColor)}for(let f=0;f<l.MaterialCount();f++)if(l.GetMaterial(f).IsEqual(m))return f;return l.AddMaterial(m)}let o=r(this.rhino,t,i);return n(this.model,o)}};var Pe=class{constructor(e,t){this.arrayBuffer=e,this.dataView=new DataView(e),this.isLittleEndian=t,this.position=0}GetPosition(){return this.position}SetPosition(e){this.position=e}GetByteLength(){return this.arrayBuffer.byteLength}Skip(e){this.position=this.position+e}End(){return this.position>=this.arrayBuffer.byteLength}ReadArrayBuffer(e){let t=new Uint8Array(this.arrayBuffer),i=new ArrayBuffer(e),r=new Uint8Array(i),n=t.subarray(this.position,this.position+e);return r.set(n,0),this.position+=e,i}ReadBoolean8(){let e=this.dataView.getInt8(this.position);return this.position=this.position+1,!!e}ReadCharacter8(){let e=this.dataView.getInt8(this.position);return this.position=this.position+1,e}ReadUnsignedCharacter8(){let e=this.dataView.getUint8(this.position);return this.position=this.position+1,e}ReadInteger16(){let e=this.dataView.getInt16(this.position,this.isLittleEndian);return this.position=this.position+2,e}ReadUnsignedInteger16(){let e=this.dataView.getUint16(this.position,this.isLittleEndian);return this.position=this.position+2,e}ReadInteger32(){let e=this.dataView.getInt32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadUnsignedInteger32(){let e=this.dataView.getUint32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadFloat32(){let e=this.dataView.getFloat32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadDouble64(){let e=this.dataView.getFloat64(this.position,this.isLittleEndian);return this.position=this.position+8,e}};var P={MAIN3DS:19789,EDIT3DS:15677,EDIT_MATERIAL:45055,MAT_NAME:40960,MAT_AMBIENT:40976,MAT_DIFFUSE:40992,MAT_SPECULAR:41008,MAT_SHININESS:41024,MAT_SHININESS_STRENGTH:41025,MAT_TRANSPARENCY:41040,MAT_COLOR_F:16,MAT_COLOR:17,MAT_LIN_COLOR:18,MAT_LIN_COLOR_F:19,MAT_TEXMAP:41472,MAT_TEXMAP_NAME:41728,MAT_TEXMAP_UOFFSET:41816,MAT_TEXMAP_VOFFSET:41818,MAT_TEXMAP_USCALE:41812,MAT_TEXMAP_VSCALE:41814,MAT_TEXMAP_ROTATION:41820,PERCENTAGE:48,PERCENTAGE_F:49,EDIT_OBJECT:16384,OBJ_TRIMESH:16640,OBJ_LIGHT:17920,OBJ_CAMERA:18176,TRI_VERTEX:16656,TRI_TEXVERTEX:16704,TRI_FACE:16672,TRI_TRANSFORMATION:16736,TRI_MATERIAL:16688,TRI_SMOOTH:16720,KF3DS:45056,OBJECT_NODE:45058,OBJECT_HIERARCHY:45072,OBJECT_INSTANCE_NAME:45073,OBJECT_PIVOT:45075,OBJECT_POSITION:45088,OBJECT_ROTATION:45089,OBJECT_SCALE:45090,OBJECT_ID:45104},cs=class{constructor(){this.id=-1,this.name="",this.flags=-1,this.parentId=-1,this.instanceName="",this.pivot=[0,0,0],this.positions=[],this.rotations=[],this.scales=[]}},ps=class{constructor(){this.nodes=[],this.nodeIdToNode=new Map}IsEmpty(){return this.nodes.length===0}AddNode(e){this.nodes.push(e),this.nodeIdToNode.set(e.nodeId,e)}GetNodes(){return this.nodes}},Tr=class extends W{constructor(){super()}CanImportExtension(e){return e==="3ds"}GetUpDirection(){return G.Z}ClearContent(){this.materialNameToIndex=null,this.meshNameToIndex=null,this.nodeList=null}ResetContent(){this.materialNameToIndex=new Map,this.meshNameToIndex=new Map,this.nodeList=new ps}ImportContent(e,t){this.ProcessBinary(e),t()}ProcessBinary(e){let t=new Pe(e,!0),i=t.GetByteLength();this.ReadChunks(t,i,(r,n)=>{r===P.MAIN3DS?this.ReadMainChunk(t,n):this.SkipChunk(t,n)})}ReadMainChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,(r,n)=>{r===P.EDIT3DS?this.ReadEditorChunk(e,n):r===P.KF3DS?this.ReadKeyFrameChunk(e,n):this.SkipChunk(e,n)}),this.BuildNodeHierarchy()}ReadEditorChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,(r,n)=>{r===P.EDIT_MATERIAL?this.ReadMaterialChunk(e,n):r===P.EDIT_OBJECT?this.ReadObjectChunk(e,n):this.SkipChunk(e,n)})}ReadMaterialChunk(e,t){let i=new K,r=this.GetChunkEnd(e,t),n=null,o=null;this.ReadChunks(e,r,(a,h)=>{a===P.MAT_NAME?i.name=this.ReadName(e):a===P.MAT_AMBIENT?i.ambient=this.ReadColorChunk(e,h):a===P.MAT_DIFFUSE?i.color=this.ReadColorChunk(e,h):a===P.MAT_SPECULAR?i.specular=this.ReadColorChunk(e,h):a===P.MAT_SHININESS?n=this.ReadPercentageChunk(e,h):a===P.MAT_SHININESS_STRENGTH?o=this.ReadPercentageChunk(e,h):a===P.MAT_TRANSPARENCY?(i.opacity=1-this.ReadPercentageChunk(e,h),ce(i)):a===P.MAT_TEXMAP?(i.diffuseMap=this.ReadTextureMapChunk(e,h),ce(i)):this.SkipChunk(e,h)}),n!==null&&o!==null&&(i.shininess=n*o/10);let l=this.model.AddMaterial(i);this.materialNameToIndex.set(i.name,l)}ReadTextureMapChunk(e,t){let i=new Ze,r=this.GetChunkEnd(e,t);return this.ReadChunks(e,r,(n,o)=>{if(n===P.MAT_TEXMAP_NAME){let l=this.ReadName(e),a=this.callbacks.getTextureBuffer(l);i.name=l,a!==null&&(i.url=a.url,i.buffer=a.buffer)}else n===P.MAT_TEXMAP_UOFFSET?i.offset.x=e.ReadFloat32():n===P.MAT_TEXMAP_VOFFSET?i.offset.y=e.ReadFloat32():n===P.MAT_TEXMAP_USCALE?i.scale.x=e.ReadFloat32():n===P.MAT_TEXMAP_VSCALE?i.scale.y=e.ReadFloat32():n===P.MAT_TEXMAP_ROTATION?i.rotation=e.ReadFloat32()*Nt:this.SkipChunk(e,o)}),i}ReadColorChunk(e,t){let i=new D(0,0,0),r=this.GetChunkEnd(e,t),n=!1;return this.ReadChunks(e,r,(o,l)=>{o===P.MAT_COLOR?n||(i.r=e.ReadUnsignedCharacter8(),i.g=e.ReadUnsignedCharacter8(),i.b=e.ReadUnsignedCharacter8()):o===P.MAT_LIN_COLOR?(i.r=e.ReadUnsignedCharacter8(),i.g=e.ReadUnsignedCharacter8(),i.b=e.ReadUnsignedCharacter8(),n=!0):o===P.MAT_COLOR_F?n||(i.r=Ee(e.ReadFloat32()),i.g=Ee(e.ReadFloat32()),i.b=Ee(e.ReadFloat32())):o===P.MAT_LIN_COLOR_F?(i.r=Ee(e.ReadFloat32()),i.g=Ee(e.ReadFloat32()),i.b=Ee(e.ReadFloat32()),n=!0):this.SkipChunk(e,l)}),i}ReadPercentageChunk(e,t){let i=0,r=this.GetChunkEnd(e,t);return this.ReadChunks(e,r,(n,o)=>{n===P.PERCENTAGE?i=e.ReadUnsignedInteger16()/100:n===P.PERCENTAGE_F?i=e.ReadFloat32():this.SkipChunk(e,o)}),i}ReadObjectChunk(e,t){let i=this.GetChunkEnd(e,t),r=this.ReadName(e);this.ReadChunks(e,i,(n,o)=>{n===P.OBJ_TRIMESH?this.ReadMeshChunk(e,o,r):this.SkipChunk(e,o)})}ReadMeshChunk(e,t,i){function r(u,d){if(!d.IsValid())return;let m=d.Determinant(),f=dt(m);f&&(d=new U().CreateScale(-1,1,1).MultiplyMatrix(d));let p=d.Invert();if(p===null)return;let c=new q(p);nt(u,c),f&&ts(u)}let n=new X;n.SetName(i);let o=this.GetChunkEnd(e,t),l=null;if(this.ReadChunks(e,o,(u,d)=>{u===P.TRI_VERTEX?this.ReadVerticesChunk(n,e):u===P.TRI_TEXVERTEX?this.ReadTextureVerticesChunk(n,e):u===P.TRI_FACE?this.ReadFacesChunk(n,e,d):u===P.TRI_TRANSFORMATION?l=this.ReadTransformationChunk(e):this.SkipChunk(e,d)}),n.VertexCount()===n.TextureUVCount())for(let u=0;u<n.TriangleCount();u++){let d=n.GetTriangle(u);d.SetTextureUVs(d.v0,d.v1,d.v2)}let a=new U(l);r(n,a);let h=this.model.AddMesh(n);this.meshNameToIndex.set(n.GetName(),h)}ReadVerticesChunk(e,t){let i=t.ReadUnsignedInteger16();for(let r=0;r<i;r++){let n=t.ReadFloat32(),o=t.ReadFloat32(),l=t.ReadFloat32();e.AddVertex(new T(n,o,l))}}ReadTextureVerticesChunk(e,t){let i=t.ReadUnsignedInteger16();for(let r=0;r<i;r++){let n=t.ReadFloat32(),o=t.ReadFloat32();e.AddTextureUV(new B(n,o))}}ReadFacesChunk(e,t,i){let r=this.GetChunkEnd(t,i),n=t.ReadUnsignedInteger16();for(let o=0;o<n;o++){let l=t.ReadUnsignedInteger16(),a=t.ReadUnsignedInteger16(),h=t.ReadUnsignedInteger16();t.ReadUnsignedInteger16(),e.AddTriangle(new z(l,a,h))}this.ReadChunks(t,r,(o,l)=>{o===P.TRI_MATERIAL?this.ReadFaceMaterialsChunk(e,t):o===P.TRI_SMOOTH?this.ReadFaceSmoothingGroupsChunk(e,n,t):this.SkipChunk(t,l)})}ReadFaceMaterialsChunk(e,t){let i=this.ReadName(t),r=this.materialNameToIndex.get(i),n=t.ReadUnsignedInteger16();for(let o=0;o<n;o++){let l=t.ReadUnsignedInteger16(),a=e.GetTriangle(l);r!==void 0&&(a.mat=r)}}ReadFaceSmoothingGroupsChunk(e,t,i){for(let r=0;r<t;r++){let n=i.ReadUnsignedInteger32(),o=e.GetTriangle(r);o.curve=n}}ReadTransformationChunk(e){let t=[];for(let i=0;i<4;i++){for(let r=0;r<3;r++)t.push(e.ReadFloat32());i<3?t.push(0):t.push(1)}return t}ReadKeyFrameChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,(r,n)=>{r===P.OBJECT_NODE?this.ReadObjectNodeChunk(e,n):this.SkipChunk(e,n)})}BuildNodeHierarchy(){function e(i,r){function n(h){return h.positions.length===0?[0,0,0]:h.positions[0]}function o(h){function u(m){let f=[0,0,0,1],p=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]);if(p>0){let c=m[3]*-.5,g=Math.sin(c)/p;f=[g*m[0],g*m[1],g*m[2],Math.cos(c)]}return f}if(h.rotations.length===0)return[0,0,0,1];let d=h.rotations[0];return u(d)}function l(h){return h.scales.length===0?[1,1,1]:h.scales[0]}let a=new U;if(a.ComposeTRS(Ke(n(i)),kt(o(i)),Ke(l(i))),r){let h=i.pivot;a=new U().CreateTranslation(-h[0],-h[1],-h[2]).MultiplyMatrix(a)}return new q(a)}let t=this.model.GetRootNode();if(this.nodeList.IsEmpty())for(let i=0;i<this.model.MeshCount();i++)t.AddMeshIndex(i);else{let i=new Map;for(let r of this.nodeList.GetNodes()){let n=new ye;r.name.length>0&&r.name!=="$$$DUMMY"&&(n.SetName(r.name),r.instanceName.length>0&&n.SetName(n.GetName()+" "+r.instanceName)),r.parentId===65535||!i.has(r.parentId)?t.AddChildNode(n):i.get(r.parentId).AddChildNode(n),i.set(r.id,n);let o=this.meshNameToIndex.has(r.name);n.SetTransformation(e(r,o)),o&&(n.SetType(fe.MeshNode),n.AddMeshIndex(this.meshNameToIndex.get(r.name)))}}}ReadObjectNodeChunk(e,t){function i(o,l,a){let h=[];l.Skip(10);let u=l.ReadInteger32();for(let d=0;d<u;d++){l.ReadInteger32(),l.ReadUnsignedInteger16()!==0&&l.ReadFloat32();let f=null;if(a===P.OBJECT_ROTATION){let p=l.ReadFloat32();f=o.ReadVector(l),f[3]=p}else f=o.ReadVector(l);h.push(f)}return h}let r=new cs,n=this.GetChunkEnd(e,t);this.ReadChunks(e,n,(o,l)=>{o===P.OBJECT_HIERARCHY?(r.name=this.ReadName(e),r.flags=e.ReadUnsignedInteger32(),r.parentId=e.ReadUnsignedInteger16()):o===P.OBJECT_INSTANCE_NAME?r.instanceName=this.ReadName(e):o===P.OBJECT_PIVOT?r.pivot=this.ReadVector(e):o===P.OBJECT_POSITION?r.positions=i(this,e,P.OBJECT_POSITION):o===P.OBJECT_ROTATION?r.rotations=i(this,e,P.OBJECT_ROTATION):o===P.OBJECT_SCALE?r.scales=i(this,e,P.OBJECT_SCALE):o===P.OBJECT_ID?r.id=e.ReadUnsignedInteger16():this.SkipChunk(e,l)}),this.nodeList.AddNode(r)}ReadName(e){let t="",i=0,r=0;for(;r<64&&(i=e.ReadCharacter8(),i!==0);)t=t+String.fromCharCode(i),r=r+1;return t}ReadVector(e){return[e.ReadFloat32(),e.ReadFloat32(),e.ReadFloat32()]}ReadChunks(e,t,i){for(;e.GetPosition()<=t-6;){let r=e.ReadUnsignedInteger16(),n=e.ReadUnsignedInteger32();i(r,n)}}GetChunkEnd(e,t){return e.GetPosition()+t-6}SkipChunk(e,t){e.Skip(t-6)}};var Se={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126},Le={SCALAR:0,VEC2:1,VEC3:2,VEC4:3,MAT2:4,MAT3:5,MAT4:6},Mt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Mr={GLTF_STRING:1179937895,JSON_CHUNK_TYPE:1313821514,BINARY_CHUNK_TYPE:5130562};function Qt(s){return Re(Yt(s[0]),Yt(s[1]),Yt(s[2]))}function po(s,e){function t(i,r){let n=i;return r!==Se.FLOAT&&(n/=255),Ee(Yt(n))}return new D(t(s[0],e),t(s[1],e),t(s[2],e))}var gs=class{constructor(e){this.reader=new Pe(e,!0),this.componentType=null,this.dataType=null,this.byteStride=null,this.dataCount=null,this.sparseReader=null}SetComponentType(e){this.componentType=e}SetDataType(e){e==="SCALAR"?this.dataType=Le.SCALAR:e==="VEC2"?this.dataType=Le.VEC2:e==="VEC3"?this.dataType=Le.VEC3:e==="VEC4"?this.dataType=Le.VEC4:e==="MAT2"?this.dataType=Le.MAT2:e==="MAT3"?this.dataType=Le.MAT3:e==="MAT4"&&(this.dataType=Le.MAT4)}SetByteStride(e){this.byteStride=e}SetDataCount(e){this.dataCount=e}SetSparseReader(e,t){this.sparseReader={indexReader:e,valueReader:t}}ReadArrayBuffer(e){return this.reader.ReadArrayBuffer(e)}GetDataCount(){return this.dataCount}ReadData(){if(this.dataType===null)return null;if(this.dataType===Le.SCALAR){let e=this.ReadComponent();return this.SkipBytesByStride(1),e}else if(this.dataType===Le.VEC2){let e=this.ReadComponent(),t=this.ReadComponent();return this.SkipBytesByStride(2),new B(e,t)}else if(this.dataType===Le.VEC3){let e=this.ReadComponent(),t=this.ReadComponent(),i=this.ReadComponent();return this.SkipBytesByStride(3),new T(e,t,i)}else if(this.dataType===Le.VEC4){let e=this.ReadComponent(),t=this.ReadComponent(),i=this.ReadComponent(),r=this.ReadComponent();return this.SkipBytesByStride(4),new He(e,t,i,r)}return null}EnumerateData(e){if(this.sparseReader===null)for(let t=0;t<this.dataCount;t++)e(this.ReadData());else{let t=[];for(let r=0;r<this.sparseReader.indexReader.GetDataCount();r++){let n=this.sparseReader.indexReader.ReadData(),o=this.sparseReader.valueReader.ReadData();t.push({index:n,value:o})}let i=0;for(let r=0;r<this.dataCount;r++){let n=this.ReadData();i<t.length&&t[i].index===r?(e(t[i].value),i+=1):e(n)}}}SkipBytes(e){this.reader.Skip(e)}ReadComponent(){return this.componentType===null?null:this.componentType===Se.BYTE?this.reader.ReadCharacter8():this.componentType===Se.UNSIGNED_BYTE?this.reader.ReadUnsignedCharacter8():this.componentType===Se.SHORT?this.reader.ReadInteger16():this.componentType===Se.UNSIGNED_SHORT?this.reader.ReadUnsignedInteger16():this.componentType===Se.UNSIGNED_INT?this.reader.ReadInteger32():this.componentType===Se.FLOAT?this.reader.ReadFloat32():null}SkipBytesByStride(e){if(this.byteStride===null)return;let t=e*this.GetComponentSize();this.reader.Skip(this.byteStride-t)}GetComponentSize(){return this.componentType===Se.BYTE||this.componentType===Se.UNSIGNED_BYTE?1:this.componentType===Se.SHORT||this.componentType===Se.UNSIGNED_SHORT?2:this.componentType===Se.UNSIGNED_INT||this.componentType===Se.FLOAT?4:0}},xs=class{constructor(){this.supportedExtensions=["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_texture_transform"],this.draco=null}LoadLibraries(e,t){if(e===void 0){t.onSuccess();return}this.draco===null&&e.indexOf("KHR_draco_mesh_compression")!==-1?ge("loaders/draco_decoder.js").then(()=>{DracoDecoderModule().then(i=>{this.draco=i,t.onSuccess()})}).catch(()=>{t.onError("Failed to load draco decoder.")}):t.onSuccess()}GetUnsupportedExtensions(e){let t=[];if(e===void 0)return t;for(let i=0;i<e.length;i++){let r=e[i];this.supportedExtensions.indexOf(r)===-1&&t.push(r)}return t}ProcessMaterial(e,t,i){if(e.extensions===void 0)return null;let r=e.extensions.KHR_materials_pbrSpecularGlossiness;if(r===void 0)return null;let n=new K,o=r.diffuseFactor;o!==void 0&&(n.color=Qt(o),n.opacity=o[3]);let l=r.diffuseTexture;l!==void 0&&(n.diffuseMap=i(l));let a=r.specularFactor;a!==void 0&&(n.specular=Qt(a));let h=r.specularGlossinessTexture;h!==void 0&&(n.specularMap=i(h));let u=r.glossinessFactor;return u!==void 0&&(n.shininess=u),n}ProcessTexture(e,t){if(e.extensions===void 0)return;let i=e.extensions.KHR_texture_transform;i!==void 0&&(i.offset!==void 0&&(t.offset.x=i.offset[0],t.offset.y=-i.offset[1]),i.scale!==void 0&&(t.scale.x=i.scale[0],t.scale.y=i.scale[1]),i.rotation!==void 0&&(t.rotation=-i.rotation))}ProcessPrimitive(e,t,i,r){function n(R,N,V,ae,H){let Ie=N.GetAttributeByUniqueId(V,ae),ke=Ie.num_components(),Pt=V.num_points()*ke,_t=Pt*4,ut=R._malloc(_t);N.GetAttributeDataArrayForAllPoints(V,Ie,R.DT_FLOAT32,_t,ut);let ne=new Float32Array(R.HEAPF32.buffer,ut,Pt).slice();if(ke===2)for(let j=0;j<ne.length;j+=2)H(new B(ne[j+0],ne[j+1]));else if(ke===3)for(let j=0;j<ne.length;j+=3)H(new T(ne[j+0],ne[j+1],ne[j+2]));else if(ke===4)for(let j=0;j<ne.length;j+=4)H(new He(ne[j+0],ne[j+1],ne[j+2],ne[j+3]));R._free(ut)}if(this.draco===null||i.extensions===void 0||i.extensions.KHR_draco_mesh_compression===void 0)return!1;let o=new this.draco.Decoder,l=new this.draco.DecoderBuffer,a=i.extensions.KHR_draco_mesh_compression,h=t.bufferViews[a.bufferView],d=e.GetReaderFromBufferView(h).ReadArrayBuffer(h.byteLength);if(l.Init(new Int8Array(d),d.byteLength),o.GetEncodedGeometryType(l)!==this.draco.TRIANGULAR_MESH)return!0;let f=new this.draco.Mesh;if(!o.DecodeBufferToMesh(l,f).ok())return!0;let c=a.attributes.POSITION!==void 0,g=!1,x=a.attributes.NORMAL!==void 0,C=a.attributes.TEXCOORD_0!==void 0;if(!c)return!0;let M=r.VertexCount(),I=r.VertexColorCount(),S=r.NormalCount(),w=r.TextureUVCount();n(this.draco,o,f,a.attributes.POSITION,R=>{r.AddVertex(R)}),x&&n(this.draco,o,f,a.attributes.NORMAL,R=>{r.AddNormal(R)}),C&&n(this.draco,o,f,a.attributes.TEXCOORD_0,R=>{R.y=-R.y,r.AddTextureUV(R)});let E=f.num_faces()*3,b=E*4,A=this.draco._malloc(b);o.GetTrianglesUInt32Array(f,b,A);let k=new Uint32Array(this.draco.HEAPU32.buffer,A,E).slice();for(let R=0;R<k.length;R+=3){let N=k[R],V=k[R+1],ae=k[R+2];e.AddTriangle(i,r,N,V,ae,g,x,C,M,I,S,w)}return this.draco._free(A),!0}},yr=class extends W{constructor(){super();this.gltfExtensions=new xs}CanImportExtension(e){return e==="gltf"||e==="glb"}GetUpDirection(){return G.Y}ClearContent(){this.bufferContents=null,this.imageIndexToTextureParams=null}ResetContent(){this.bufferContents=[],this.imageIndexToTextureParams=new Map}ImportContent(e,t){this.extension==="gltf"?this.ProcessGltf(e,t):this.extension==="glb"&&this.ProcessBinaryGltf(e,t)}ProcessGltf(e,t){let i=te(e),r=JSON.parse(i);if(r.asset.version!=="2.0"){this.SetError("Invalid glTF version."),t();return}for(let n=0;n<r.buffers.length;n++){let o=null,l=r.buffers[n],a=Kt(l.uri);if(a!==null)o=a.buffer;else{let h=this.callbacks.getFileBuffer(l.uri);h!==null&&(o=h)}if(o===null){this.SetError("One of the requested buffers is missing."),t();return}this.bufferContents.push(o)}this.ProcessMainFile(r,t)}ProcessBinaryGltf(e,t){function i(h){let u=h.ReadUnsignedInteger32(),d=h.ReadUnsignedInteger32(),m=h.ReadArrayBuffer(u);return{type:d,buffer:m}}let r=new Pe(e,!0);if(r.ReadUnsignedInteger32()!==Mr.GLTF_STRING){this.SetError("Invalid glTF file."),t();return}if(r.ReadUnsignedInteger32()!==2){this.SetError("Invalid glTF version."),t();return}if(r.ReadUnsignedInteger32()!==r.GetByteLength()){this.SetError("Invalid glTF file."),t();return}let a=null;for(;!r.End();){let h=i(r);h.type===Mr.JSON_CHUNK_TYPE?a=te(h.buffer):h.type===Mr.BINARY_CHUNK_TYPE&&this.bufferContents.push(h.buffer)}if(a!==null){let h=JSON.parse(a);this.ProcessMainFile(h,t)}}ProcessMainFile(e,t){let i=this.gltfExtensions.GetUnsupportedExtensions(e.extensionsRequired);if(i.length>0){this.SetError("Unsupported extension: "+i.join(", ")+"."),t();return}this.gltfExtensions.LoadLibraries(e.extensionsRequired,{onSuccess:()=>{this.ImportModel(e),t()},onError:r=>{this.SetError(r),t()}})}ImportModel(e){let t=e.materials;if(t!==void 0)for(let r of t)this.ImportMaterial(e,r);let i=e.meshes;if(i!==void 0)for(let r of i)this.ImportMesh(e,r);this.ImportNodes(e),this.ImportModelProperties(e)}ImportModelProperties(e){function t(i,r,n){let o=new Ae(r);for(let l in n)if(Object.prototype.hasOwnProperty.call(n,l)&&typeof n[l]=="string"){let a=new L(_.Text,l,n[l]);o.AddProperty(a)}return o.PropertyCount()>0&&i.AddPropertyGroup(o),o}t(this.model,"Asset properties",e.asset),e.asset.extras&&t(this.model,"Extras",e.asset.extras)}GetDefaultScene(e){let t=e.scene||0;return t>=e.scenes.length?null:e.scenes[t]}ImportMaterial(e,t){let i=new vt;if(t.name!==void 0&&(i.name=t.name),i.color=Qt([1,1,1]),t.pbrMetallicRoughness!==void 0){let n=t.pbrMetallicRoughness.baseColorFactor;n!==void 0&&(i.color=Qt(n),i.opacity=n[3]);let o=t.pbrMetallicRoughness.metallicFactor;o!==void 0&&(i.metalness=o);let l=t.pbrMetallicRoughness.roughnessFactor;l!==void 0&&(i.roughness=l);let a=t.emissiveFactor;a!==void 0&&(i.emissive=Qt(a)),i.diffuseMap=this.ImportTexture(e,t.pbrMetallicRoughness.baseColorTexture),i.metalnessMap=this.ImportTexture(e,t.pbrMetallicRoughness.metallicRoughnessTexture),i.normalMap=this.ImportTexture(e,t.normalTexture),i.emissiveMap=this.ImportTexture(e,t.emissiveTexture),i.diffuseMap!==null&&(i.multiplyDiffuseMap=!0);let h=t.alphaMode;h!==void 0&&(h==="BLEND"?i.transparent=!0:h==="MASK"&&(i.transparent=!0,i.alphaTest=t.alphaCutoff||.5))}let r=this.gltfExtensions.ProcessMaterial(t,i,n=>this.ImportTexture(e,n));r!==null&&(i=r),this.model.AddMaterial(i)}ImportTexture(e,t){if(t==null)return null;let i=new Ze,n=e.textures[t.index].source,o=e.images[n],l=null;if(this.imageIndexToTextureParams.has(n))l=this.imageIndexToTextureParams.get(n);else{l={name:null,url:null,buffer:null};let a=n.toString();if(o.uri!==void 0){let h=Kt(o.uri);if(h!==null)l.name="Embedded_"+a+"."+Ot(h.mimeType),l.url=sr(h.buffer,h.mimeType),l.buffer=h.buffer;else{let u=this.callbacks.getTextureBuffer(o.uri);l.name=o.uri,u!==null&&(l.url=u.url,l.buffer=u.buffer)}}else if(o.bufferView!==void 0){let h=e.bufferViews[o.bufferView],u=this.GetReaderFromBufferView(h);if(u!==null){let d=u.ReadArrayBuffer(h.byteLength);l.name="Binary_"+a+"."+Ot(o.mimeType),l.url=sr(d,o.mimeType),l.buffer=d}}this.imageIndexToTextureParams.set(n,l)}return i.name=l.name,i.url=l.url,i.buffer=l.buffer,this.gltfExtensions.ProcessTexture(t,i),i}ImportMesh(e,t){let i=new X;this.model.AddMesh(i),t.name!==void 0&&i.SetName(t.name);for(let r=0;r<t.primitives.length;r++){let n=t.primitives[r];this.ImportPrimitive(e,n,i)}}ImportPrimitive(e,t,i){if(this.gltfExtensions.ProcessPrimitive(this,e,t,i)||t.attributes===void 0)return;let r=t.attributes.POSITION!==void 0,n=t.attributes.COLOR_0!==void 0,o=t.attributes.NORMAL!==void 0,l=t.attributes.TEXCOORD_0!==void 0,a=t.indices!==void 0,h=Mt.TRIANGLES;if(t.mode!==void 0&&(h=t.mode),h!==Mt.TRIANGLES&&h!==Mt.TRIANGLE_STRIP&&h!==Mt.TRIANGLE_FAN)return;let u=i.VertexCount(),d=i.VertexColorCount(),m=i.NormalCount(),f=i.TextureUVCount();if(r){let c=e.accessors[t.attributes.POSITION],g=this.GetReaderFromAccessor(e,c);if(g===null)return;g.EnumerateData(x=>{i.AddVertex(x)})}else return;if(n){let c=e.accessors[t.attributes.COLOR_0],g=this.GetReaderFromAccessor(e,c);if(g===null)return;g.EnumerateData(x=>{let C=po([x.x,x.y,x.z],g.componentType);i.AddVertexColor(C)})}if(o){let c=e.accessors[t.attributes.NORMAL],g=this.GetReaderFromAccessor(e,c);if(g===null)return;g.EnumerateData(x=>{i.AddNormal(x)})}if(l){let c=e.accessors[t.attributes.TEXCOORD_0],g=this.GetReaderFromAccessor(e,c);if(g===null)return;g.EnumerateData(x=>{x.y=-x.y,i.AddTextureUV(x)})}let p=[];if(a){let c=e.accessors[t.indices],g=this.GetReaderFromAccessor(e,c);if(g===null)return;g.EnumerateData(x=>{p.push(x)})}else{let c=i.VertexCount()-u;for(let g=0;g<c;g++)p.push(g)}if(h===Mt.TRIANGLES)for(let c=0;c<p.length;c+=3){let g=p[c],x=p[c+1],C=p[c+2];this.AddTriangle(t,i,g,x,C,n,o,l,u,d,m,f)}else if(h===Mt.TRIANGLE_STRIP)for(let c=0;c<p.length-2;c++){let g=p[c],x=p[c+1],C=p[c+2];if(c%2===1){let M=x;x=C,C=M}this.AddTriangle(t,i,g,x,C,n,o,l,u,d,m,f)}else if(h===Mt.TRIANGLE_FAN)for(let c=1;c<p.length-1;c++){let g=p[0],x=p[c],C=p[c+1];this.AddTriangle(t,i,g,x,C,n,o,l,u,d,m,f)}}AddTriangle(e,t,i,r,n,o,l,a,h,u,d,m){let f=new z(h+i,h+r,h+n);o&&f.SetVertexColors(u+i,u+r,u+n),l&&f.SetNormals(d+i,d+r,d+n),a&&f.SetTextureUVs(m+i,m+r,m+n),e.material!==void 0&&(f.mat=e.material),t.AddTriangle(f)}ImportNodes(e){let t=this.GetDefaultScene(e);if(t===null)return;let i=this.model.GetRootNode();for(let r of t.nodes){let n=e.nodes[r];this.ImportNode(e,n,i)}}ImportNode(e,t,i){function r(o){let l=new U().CreateIdentity();if(o.matrix!==void 0)l.Set(o.matrix);else{let a=[0,0,0],h=[0,0,0,1],u=[1,1,1];o.translation!==void 0&&(a=o.translation),o.rotation!==void 0&&(h=o.rotation),o.scale!==void 0&&(u=o.scale),l.ComposeTRS(Ke(a),kt(h),Ke(u))}return new q(l)}if(t.children===void 0&&t.mesh===void 0)return;let n=new ye;if(t.name!==void 0&&n.SetName(t.name),n.SetTransformation(r(t)),i.AddChildNode(n),t.children!==void 0)for(let o of t.children){let l=e.nodes[o];this.ImportNode(e,l,n)}t.mesh!==void 0&&((t.children===void 0||t.children.length===0)&&n.SetType(fe.MeshNode),n.AddMeshIndex(t.mesh))}GetReaderFromBufferView(e){let t=e.buffer||0,i=this.bufferContents[t];if(i==null)return null;let r=new gs(i);r.SkipBytes(e.byteOffset||0);let n=e.byteStride;return n!==void 0&&n!==0&&r.SetByteStride(n),r}GetReaderFromAccessor(e,t){let i=t.bufferView||0,r=e.bufferViews[i],n=this.GetReaderFromBufferView(r);if(n===null)return null;if(n.SetComponentType(t.componentType),n.SetDataType(t.type),n.SetDataCount(t.count),n.SkipBytes(t.byteOffset||0),t.sparse!==void 0){let o=this.GetReaderFromSparseAccessor(e,t.sparse.indices,t.sparse.indices.componentType,"SCALAR",t.sparse.count),l=this.GetReaderFromSparseAccessor(e,t.sparse.values,t.componentType,t.type,t.sparse.count);o!==null&&l!==null&&n.SetSparseReader(o,l)}return n}GetReaderFromSparseAccessor(e,t,i,r,n){if(t.bufferView===void 0)return null;let o=e.bufferViews[t.bufferView],l=this.GetReaderFromBufferView(o);return l===null?null:(l.SetComponentType(i),l.SetDataType(r),l.SetDataCount(n),l.SkipBytes(t.byteOffset||0),l)}};var Sr=class extends W{constructor(){super();this.ifc=null}CanImportExtension(e){return e==="ifc"}GetUpDirection(){return G.Y}ClearContent(){this.materialNameToIndex=null,this.expressIDToMesh=null}ResetContent(){this.materialNameToIndex=new Map,this.expressIDToMesh=new Map}ImportContent(e,t){this.ifc===null?ge("loaders/web-ifc-api-browser.js").then(()=>{this.ifc=new WebIFC.IfcAPI,this.ifc.Init().then(()=>{this.ImportIfcContent(e),t()})}).catch(()=>{this.SetError("Failed to load web-ifc."),t()}):(this.ImportIfcContent(e),t())}ImportIfcContent(e){let t=new Uint8Array(e),i=this.ifc.OpenModel(t,{COORDINATE_TO_ORIGIN:!0}),r=this.ifc.LoadAllGeometry(i);for(let n=0;n<r.size();n++){let o=r.get(n);o.geometries.size()>0&&this.ImportIfcMesh(i,o)}this.ImportProperties(i),this.ifc.CloseModel(i)}ImportIfcMesh(e,t){let i=new X;i.SetName("Mesh "+t.expressID.toString());let r=0,n=t.geometries;for(let o=0;o<n.size();o++){let l=n.get(o),a=this.ifc.GetGeometry(e,l.geometryExpressID),h=this.ifc.GetVertexArray(a.GetVertexData(),a.GetVertexDataSize()),u=this.ifc.GetIndexArray(a.GetIndexData(),a.GetIndexDataSize()),d=this.GetMaterialIndexByColor(l.color),m=new U(l.flatTransformation),f=new q(m);for(let p=0;p<h.length;p+=6){let c=h[p],g=h[p+1],x=h[p+2],C=new T(c,g,x),M=f.TransformCoord3D(C);i.AddVertex(M)}for(let p=0;p<u.length;p+=3){let c=u[p],g=u[p+1],x=u[p+2],C=new z(r+c,r+g,r+x);C.SetMaterial(d),i.AddTriangle(C)}r+=h.length/6}this.expressIDToMesh.set(t.expressID,i),this.model.AddMeshToRootNode(i)}ImportProperties(e){let t=this.ifc.GetLineIDsWithType(e,WebIFC.IFCRELDEFINESBYPROPERTIES);for(let i=0;i<t.size();i++){let r=t.get(i),n=this.ifc.GetLine(e,r);Array.isArray(n.RelatingPropertyDefinition)||n.RelatedObjects.forEach(o=>{let l=null;if(this.expressIDToMesh.has(o.value)?l=this.expressIDToMesh.get(o.value):this.ifc.GetLine(e,o.value,!0).type===WebIFC.IFCBUILDING&&(l=this.model),l===null)return;let a=n.RelatingPropertyDefinition,h=this.ifc.GetLine(e,a.value,!0);if(!h||!h.HasProperties)return;let u=new Ae(h.Name.value);h.HasProperties.forEach(d=>{if(!d||!d.Name||!d.NominalValue)return;let m=null,f=this.GetIFCString(d.Name.value),p=null;switch(d.NominalValue.label){case"IFCTEXT":case"IFCLABEL":case"IFCIDENTIFIER":m=new L(_.Text,f,this.GetIFCString(d.NominalValue.value));break;case"IFCBOOLEAN":case"IFCLOGICAL":p="Unknown",d.NominalValue.value==="T"?p="True":d.NominalValue.value==="F"&&(p="False"),m=new L(_.Text,f,p);break;case"IFCINTEGER":case"IFCCOUNTMEASURE":m=new L(_.Integer,f,d.NominalValue.value);break;case"IFCREAL":case"IFCLENGTHMEASURE":case"IFCPOSITIVELENGTHMEASURE":case"IFCAREAMEASURE":case"IFCVOLUMEMEASURE":case"IFCRATIOMEASURE":case"IFCPOSITIVERATIOMEASURE":case"IFCMASSMEASURE":case"IFCMASSPERLENGTHMEASURE":case"IFCPLANEANGLEMEASURE":case"IFCTHERMALTRANSMITTANCEMEASURE":m=new L(_.Number,f,d.NominalValue.value);break;default:console.log(d.NominalValue.label),console.log(d.NominalValue.value);break}m!==null&&u.AddProperty(m)}),u.PropertyCount()>0&&l.AddPropertyGroup(u)})}}GetMaterialIndexByColor(e){let t=Re(e.x,e.y,e.z),i="Color "+ee(t.r)+ee(t.g)+ee(t.b)+ee(parseInt(e.w*255,10));if(this.materialNameToIndex.has(i))return this.materialNameToIndex.get(i);{let r=new K;r.name=i,r.color=t,r.opacity=e.w,ce(r);let n=this.model.AddMaterial(r);return this.materialNameToIndex.set(i,n),n}}GetIFCString(e){let t=this.DecodeIFCString(e);return t.length===0&&(t="-"),t}DecodeIFCString(e){let t=/\\X2\\(.*?)\\X0\\/uig,i=e,r=t.exec(e);for(;r;){let n=String.fromCharCode(parseInt(r[1],16));i=i.replace(r[0],n),r=t.exec(e)}return i}};var Bi=class{constructor(){this.name=null,this.material=null}SetName(e){return this.name=e,this}SetMaterial(e){return this.material=e,this}},$t=class{constructor(e){this.params=e||new Bi,this.mesh=new X,this.params.name!==null&&this.mesh.SetName(this.params.name),this.curve=null}GetMesh(){return this.mesh}AddVertex(e,t,i){let r=new T(e,t,i);return this.mesh.AddVertex(r)}AddVertices(e){let t=[];for(let i=0;i<e.length;i++){let r=e[i];t.push(this.AddVertex(r.x,r.y,r.z))}return t}SetCurve(e){this.curve=e}ResetCurve(){this.curve=null}AddTriangle(e,t,i){let r=new z(e,t,i);return this.params.material!==null&&(r.mat=this.params.material),this.curve!==null&&r.SetCurve(this.curve),this.mesh.AddTriangle(r)}AddTriangleInverted(e,t,i){this.AddTriangle(e,i,t)}AddConvexPolygon(e){for(let t=0;t<e.length-2;t++)this.AddTriangle(e[0],e[t+1],e[t+2])}AddConvexPolygonInverted(e){for(let t=0;t<e.length-2;t++)this.AddTriangleInverted(e[0],e[t+1],e[t+2])}},br=class{constructor(e){this.generator=e}GenerateSurfaceBetweenPolygons(e,t){if(e.length!==t.length)return;let i=e.length;for(let r=0;r<i;r++){let n=r,o=r<i-1?n+1:0;this.generator.AddConvexPolygon([e[n],e[o],t[o],t[n]])}}GenerateTriangleFan(e,t){let i=e.length;for(let r=0;r<i;r++){let n=r,o=r<i-1?n+1:0;this.generator.AddTriangle(t,e[n],e[o])}}};function Cs(s,e){return new B(s*Math.cos(e),s*Math.sin(e))}function vs(s,e,t,i){if(!Ue(e)||!Ue(t)||!Ue(i))return null;let r=new $t(s);return r.AddVertex(0,0,0),r.AddVertex(e,0,0),r.AddVertex(e,t,0),r.AddVertex(0,t,0),r.AddVertex(0,0,i),r.AddVertex(e,0,i),r.AddVertex(e,t,i),r.AddVertex(0,t,i),r.AddConvexPolygon([0,3,2,1]),r.AddConvexPolygon([0,1,5,4]),r.AddConvexPolygon([1,2,6,5]),r.AddConvexPolygon([2,3,7,6]),r.AddConvexPolygon([3,0,4,7]),r.AddConvexPolygon([4,5,6,7]),r.GetMesh()}function wr(s,e,t,i,r,n){if(dt(e)||dt(t)||!Ue(i)||r<3)return null;let o=Xt(e),l=Xt(t);if(o&&l)return null;let a=new $t(s),h=new br(a),u=2*Math.PI/r,d=n?1:null,m=[];if(o)m.push(a.AddVertex(0,0,i));else for(let p=0;p<r;p++){let c=Cs(e,p*u);m.push(a.AddVertex(c.x,c.y,i))}let f=[];if(l)f.push(a.AddVertex(0,0,0));else for(let p=0;p<r;p++){let c=Cs(t,p*u);f.push(a.AddVertex(c.x,c.y,0))}return o?(a.SetCurve(d),h.GenerateTriangleFan(f,m[0]),a.ResetCurve(),a.AddConvexPolygonInverted(f)):l?(a.SetCurve(d),h.GenerateTriangleFan(m.slice().reverse(),f[0]),a.ResetCurve(),a.AddConvexPolygon(m)):(a.SetCurve(d),h.GenerateSurfaceBetweenPolygons(f,m),a.ResetCurve(),a.AddConvexPolygonInverted(f),a.AddConvexPolygon(m)),a.GetMesh()}function Is(s,e,t,i,r){return wr(s,e,e,t,i,r)}function Ts(s,e,t,i){function r(f,p,c){return new T(f*Math.sin(p)*Math.cos(c),f*Math.sin(p)*Math.sin(c),f*Math.cos(p))}if(!Ue(e)||t<3)return null;let n=new $t(s),o=new br(n);n.SetCurve(i?1:null);let l=[],a=t+1,h=Math.PI/t,u=2*Math.PI/t;for(let f=1;f<a-1;f++){let p=[],c=f*h;for(let g=0;g<t;g++){let x=g*u,C=r(e,c,-x);p.push(n.AddVertex(C.x,C.y,C.z))}f>1&&o.GenerateSurfaceBetweenPolygons(l[l.length-1],p),l.push(p)}let d=n.AddVertex(0,0,e),m=n.AddVertex(0,0,-e);return o.GenerateTriangleFan(l[0].slice().reverse(),d),o.GenerateTriangleFan(l[l.length-1],m),n.ResetCurve(),n.GetMesh()}function Ms(s,e,t){function i(n,o,l,a,h){let u=new T(l,a,h);u.MultiplyScalar(o/u.Length()),n.AddVertex(u.x,u.y,u.z)}if(!Ue(t))return null;let r=new $t(s);if(e==="tetrahedron"){let n=1;i(r,t,+n,+n,+n),i(r,t,-n,-n,+n),i(r,t,-n,+n,-n),i(r,t,+n,-n,-n),r.AddTriangle(0,1,3),r.AddTriangle(0,2,1),r.AddTriangle(0,3,2),r.AddTriangle(1,2,3)}else if(e==="hexahedron"){let n=1;i(r,t,+n,+n,+n),i(r,t,+n,+n,-n),i(r,t,+n,-n,+n),i(r,t,+n,-n,-n),i(r,t,-n,+n,+n),i(r,t,-n,+n,-n),i(r,t,-n,-n,+n),i(r,t,-n,-n,-n),r.AddConvexPolygon([0,1,5,4]),r.AddConvexPolygon([0,2,3,1]),r.AddConvexPolygon([0,4,6,2]),r.AddConvexPolygon([1,3,7,5]),r.AddConvexPolygon([2,6,7,3]),r.AddConvexPolygon([4,5,7,6])}else if(e==="octahedron"){let n=1,o=0;i(r,t,+n,+o,+o),i(r,t,-n,+o,+o),i(r,t,+o,+n,+o),i(r,t,+o,-n,+o),i(r,t,+o,+o,+n),i(r,t,+o,+o,-n),r.AddTriangle(0,2,4),r.AddTriangle(0,3,5),r.AddTriangle(0,4,3),r.AddTriangle(0,5,2),r.AddTriangle(1,2,5),r.AddTriangle(1,3,4),r.AddTriangle(1,4,2),r.AddTriangle(1,5,3)}else if(e==="dodecahedron"){let n=1,o=0,l=(1+Math.sqrt(5))/2,a=1/l;i(r,t,+n,+n,+n),i(r,t,+n,+n,-n),i(r,t,+n,-n,+n),i(r,t,-n,+n,+n),i(r,t,+n,-n,-n),i(r,t,-n,+n,-n),i(r,t,-n,-n,+n),i(r,t,-n,-n,-n),i(r,t,+o,+a,+l),i(r,t,+o,+a,-l),i(r,t,+o,-a,+l),i(r,t,+o,-a,-l),i(r,t,+a,+l,+o),i(r,t,+a,-l,+o),i(r,t,-a,+l,+o),i(r,t,-a,-l,+o),i(r,t,+l,+o,+a),i(r,t,-l,+o,+a),i(r,t,+l,+o,-a),i(r,t,-l,+o,-a),r.AddConvexPolygon([0,8,10,2,16]),r.AddConvexPolygon([0,16,18,1,12]),r.AddConvexPolygon([0,12,14,3,8]),r.AddConvexPolygon([1,9,5,14,12]),r.AddConvexPolygon([1,18,4,11,9]),r.AddConvexPolygon([2,10,6,15,13]),r.AddConvexPolygon([2,13,4,18,16]),r.AddConvexPolygon([3,14,5,19,17]),r.AddConvexPolygon([3,17,6,10,8]),r.AddConvexPolygon([4,13,15,7,11]),r.AddConvexPolygon([5,9,11,7,19]),r.AddConvexPolygon([6,17,19,7,15])}else if(e==="icosahedron"){let n=1,o=0,l=(1+Math.sqrt(5))/2;i(r,t,+o,+n,+l),i(r,t,+o,+n,-l),i(r,t,+o,-n,+l),i(r,t,+o,-n,-l),i(r,t,+n,+l,+o),i(r,t,+n,-l,+o),i(r,t,-n,+l,+o),i(r,t,-n,-l,+o),i(r,t,+l,+o,+n),i(r,t,+l,+o,-n),i(r,t,-l,+o,+n),i(r,t,-l,+o,-n),r.AddTriangle(0,2,8),r.AddTriangle(0,4,6),r.AddTriangle(0,6,10),r.AddTriangle(0,8,4),r.AddTriangle(0,10,2),r.AddTriangle(1,3,11),r.AddTriangle(1,4,9),r.AddTriangle(1,6,4),r.AddTriangle(1,9,3),r.AddTriangle(1,11,6),r.AddTriangle(2,5,8),r.AddTriangle(2,7,5),r.AddTriangle(2,10,7),r.AddTriangle(3,5,7),r.AddTriangle(3,7,11),r.AddTriangle(3,9,5),r.AddTriangle(4,8,9),r.AddTriangle(5,9,8),r.AddTriangle(6,11,10),r.AddTriangle(7,10,11)}return r.GetMesh()}var Er=class extends W{constructor(){super()}CanImportExtension(e){return e==="o3dv"}GetUpDirection(){return G.Z}ClearContent(){}ResetContent(){}ImportContent(e,t){let i=te(e),r=JSON.parse(i);if(r.root===void 0){t();return}if(r.materials!==void 0)for(let o=0;o<r.materials.length;o++){let l=r.materials[o];this.ImportMaterial(l)}if(r.meshes!==void 0)for(let o=0;o<r.meshes.length;o++){let l=r.meshes[o];this.ImportMesh(l)}let n=r.nodes[r.root];this.ImportNode(r,n,this.model.GetRootNode()),this.ImportProperties(this.model,r),t()}ImportMaterial(e){let t=new vt;t.color.Set(255,255,255),e.name!==void 0&&(t.name=e.name),e.color!==void 0&&(t.color=Rn(e.color)),t.metalness=ze(e.metalness,0),t.roughness=ze(e.roughness,1),this.model.AddMaterial(t)}ImportMesh(e){let t=new Bi;e.name!==void 0&&t.SetName(e.name),e.material!==void 0&&t.SetMaterial(e.material);let i=e.parameters;if(i===void 0)return;let r=null;if(e.type==="cuboid"){if(i.size_x===void 0||i.size_y===void 0||i.size_z===void 0)return;r=vs(t,i.size_x,i.size_y,i.size_z)}else if(e.type==="cylinder"){if(i.radius===void 0||i.height===void 0)return;let n=ze(i.segments,25),o=ze(i.smooth,!0);r=Is(t,i.radius,i.height,n,o)}else if(e.type==="cone"){if(i.top_radius===void 0||i.bottom_radius===void 0||i.height===void 0)return;let n=ze(i.segments,25),o=ze(i.smooth,!0);r=wr(t,i.top_radius,i.bottom_radius,i.height,n,o)}else if(e.type==="sphere"){if(i.radius===void 0)return;let n=ze(i.segments,20),o=ze(i.smooth,!0);r=Ts(t,i.radius,n,o)}else if(e.type==="platonic"){if(i.solid_type===void 0)return;let n=ze(i.radius,1);r=Ms(t,i.solid_type,n)}r!==null&&(this.ImportProperties(r,e),this.model.AddMesh(r))}ImportNode(e,t,i){if(t.name!==void 0&&i.SetName(t.name),t.transformation!==void 0){let r=this.GetTransformation(t.transformation);i.SetTransformation(r)}if(t.children!==void 0)for(let r of t.children){let n=e.nodes[r],o=new ye;i.AddChildNode(o),this.ImportNode(e,n,o)}t.mesh!==void 0&&((t.children===void 0||t.children.length===0)&&i.SetType(fe.MeshNode),i.AddMeshIndex(t.mesh))}ImportProperties(e,t){if(t.properties!==void 0){let i=new Ae("Properties");e.AddPropertyGroup(i);for(let r of t.properties){let n=new L(_.Text,r.name,r.value);i.AddProperty(n)}}}GetTransformation(e){let t=new T(0,0,0),i=new Me(0,0,0,1),r=new T(1,1,1);e.translation!==void 0&&(t=Ke(e.translation)),e.rotation!==void 0&&(i=kt(e.rotation)),e.scale!==void 0&&(r=Ke(e.scale));let n=new U().ComposeTRS(t,i,r);return new q(n)}};var ys=class{constructor(e){this.mesh=e,this.globalToMeshVertices=new Map,this.globalToMeshVertexColors=new Map,this.globalToMeshNormals=new Map,this.globalToMeshUvs=new Map}AddVertex(e,t){return this.GetLocalIndex(e,t,this.globalToMeshVertices,i=>this.mesh.AddVertex(new T(i.x,i.y,i.z)))}AddVertexColor(e,t){return this.GetLocalIndex(e,t,this.globalToMeshVertexColors,i=>this.mesh.AddVertexColor(new D(i.r,i.g,i.b)))}AddNormal(e,t){return this.GetLocalIndex(e,t,this.globalToMeshNormals,i=>this.mesh.AddNormal(new T(i.x,i.y,i.z)))}AddUV(e,t){return this.GetLocalIndex(e,t,this.globalToMeshUvs,i=>this.mesh.AddTextureUV(new B(i.x,i.y)))}AddTriangle(e){this.mesh.AddTriangle(e)}GetLocalIndex(e,t,i,r){if(isNaN(e)||e<0||e>=t.length)return null;if(i.has(e))return i.get(e);{let n=t[e],o=r(n);return i.set(e,o),o}}};function Oi(s,e,t){return Re(parseFloat(s),parseFloat(e),parseFloat(t))}var Ar=class extends W{constructor(){super()}CanImportExtension(e){return e==="obj"}GetUpDirection(){return G.Y}ClearContent(){this.globalVertices=null,this.globalVertexColors=null,this.globalNormals=null,this.globalUvs=null,this.currentMeshConverter=null,this.currentMaterial=null,this.currentMaterialIndex=null,this.meshNameToConverter=null,this.materialNameToIndex=null}ResetContent(){this.globalVertices=[],this.globalVertexColors=[],this.globalNormals=[],this.globalUvs=[],this.currentMeshConverter=null,this.currentMaterial=null,this.currentMaterialIndex=null,this.meshNameToConverter=new Map,this.materialNameToIndex=new Map}ImportContent(e,t){let i=te(e);Ge(i,r=>{this.WasError()||this.ProcessLine(r)}),t()}ProcessLine(e){if(e[0]==="#")return;let t=Qe(e,"#");if(t.length===0)return;let i=t[0].toLowerCase();t.shift(),!this.ProcessMeshParameter(i,t,e)&&this.ProcessMaterialParameter(i,t,e)}AddNewMesh(e){if(this.meshNameToConverter.has(e))this.currentMeshConverter=this.meshNameToConverter.get(e);else{let t=new X;t.SetName(e),this.model.AddMeshToRootNode(t),this.currentMeshConverter=new ys(t),this.meshNameToConverter.set(e,this.currentMeshConverter)}}ProcessMeshParameter(e,t,i){if(e==="g"||e==="o"){if(t.length===0)return!0;let r=ot(i,e.length,"#");return this.AddNewMesh(r),!0}else{if(e==="v")return t.length<3||(this.globalVertices.push(new T(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),t.length>=6&&this.globalVertexColors.push(Oi(t[3],t[4],t[5]))),!0;if(e==="vn")return t.length<3||this.globalNormals.push(new T(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),!0;if(e==="vt")return t.length<2||this.globalUvs.push(new B(parseFloat(t[0]),parseFloat(t[1]))),!0;if(e==="f")return t.length<3||this.ProcessFace(t),!0}return!1}ProcessMaterialParameter(e,t,i){function r(n,o,l){let a=new Ze,h=ot(o,n.length,"#"),u=l.getTextureBuffer(h);return a.name=h,u!==null&&(a.url=u.url,a.buffer=u.buffer),a}if(e==="newmtl"){if(t.length===0)return!0;let n=new K,o=ot(i,e.length,"#"),l=this.model.AddMaterial(n);return n.name=o,this.currentMaterial=n,this.materialNameToIndex.set(o,l),!0}else if(e==="usemtl"){if(t.length===0)return!0;let n=ot(i,e.length,"#");return this.materialNameToIndex.has(n)&&(this.currentMaterialIndex=this.materialNameToIndex.get(n)),!0}else if(e==="mtllib"){if(t.length===0)return!0;let n=ot(i,e.length,"#"),o=this.callbacks.getFileBuffer(n);if(o!==null){let l=te(o);Ge(l,a=>{this.WasError()||this.ProcessLine(a)})}return!0}else{if(e==="map_kd")return this.currentMaterial===null||t.length===0||(this.currentMaterial.diffuseMap=r(e,i,this.callbacks),ce(this.currentMaterial)),!0;if(e==="map_ks")return this.currentMaterial===null||t.length===0||(this.currentMaterial.specularMap=r(e,i,this.callbacks)),!0;if(e==="map_bump"||e==="bump")return this.currentMaterial===null||t.length===0||(this.currentMaterial.bumpMap=r(e,i,this.callbacks)),!0;if(e==="ka")return this.currentMaterial===null||t.length<3||(this.currentMaterial.ambient=Oi(t[0],t[1],t[2])),!0;if(e==="kd")return this.currentMaterial===null||t.length<3||(this.currentMaterial.color=Oi(t[0],t[1],t[2])),!0;if(e==="ks")return this.currentMaterial===null||t.length<3||(this.currentMaterial.specular=Oi(t[0],t[1],t[2])),!0;if(e==="ns")return this.currentMaterial===null||t.length<1||(this.currentMaterial.shininess=parseFloat(t[0])/1e3),!0;if(e==="tr")return this.currentMaterial===null||t.length<1||(this.currentMaterial.opacity=1-parseFloat(t[0]),ce(this.currentMaterial)),!0;if(e==="d")return this.currentMaterial===null||t.length<1||(this.currentMaterial.opacity=parseFloat(t[0]),ce(this.currentMaterial)),!0}return!1}ProcessFace(e){function t(l,a){return l>0?l-1:a+l}let i=[],r=[],n=[],o=[];for(let l=0;l<e.length;l++){let a=e[l].split("/");i.push(t(parseInt(a[0],10),this.globalVertices.length)),this.globalVertices.length===this.globalVertexColors.length&&r.push(t(parseInt(a[0],10),this.globalVertices.length)),a.length>1&&a[1].length>0&&o.push(t(parseInt(a[1],10),this.globalUvs.length)),a.length>2&&a[2].length>0&&n.push(t(parseInt(a[2],10),this.globalNormals.length))}this.currentMeshConverter===null&&this.AddNewMesh("");for(let l=0;l<i.length-2;l++){let a=this.currentMeshConverter.AddVertex(i[0],this.globalVertices),h=this.currentMeshConverter.AddVertex(i[l+1],this.globalVertices),u=this.currentMeshConverter.AddVertex(i[l+2],this.globalVertices);if(a===null||h===null||u===null){this.SetError("Invalid vertex index.");break}let d=new z(a,h,u);if(r.length===i.length){let m=this.currentMeshConverter.AddVertexColor(r[0],this.globalVertexColors),f=this.currentMeshConverter.AddVertexColor(r[l+1],this.globalVertexColors),p=this.currentMeshConverter.AddVertexColor(r[l+2],this.globalVertexColors);if(m===null||f===null||p===null){this.SetError("Invalid vertex color index.");break}d.SetVertexColors(m,f,p)}if(n.length===i.length){let m=this.currentMeshConverter.AddNormal(n[0],this.globalNormals),f=this.currentMeshConverter.AddNormal(n[l+1],this.globalNormals),p=this.currentMeshConverter.AddNormal(n[l+2],this.globalNormals);if(m===null||f===null||p===null){this.SetError("Invalid normal index.");break}d.SetNormals(m,f,p)}if(o.length===i.length){let m=this.currentMeshConverter.AddUV(o[0],this.globalUvs),f=this.currentMeshConverter.AddUV(o[l+1],this.globalUvs),p=this.currentMeshConverter.AddUV(o[l+2],this.globalUvs);if(m===null||f===null||p===null){this.SetError("Invalid uv index.");break}d.SetTextureUVs(m,f,p)}this.currentMaterialIndex!==null&&(d.mat=this.currentMaterialIndex),this.currentMeshConverter.AddTriangle(d)}}};var Dr=class extends W{constructor(){super()}CanImportExtension(e){return e==="off"}GetUpDirection(){return G.Y}ClearContent(){this.mesh=null,this.status=null}ResetContent(){this.mesh=new X,this.model.AddMeshToRootNode(this.mesh),this.status={vertexCount:0,faceCount:0,foundVertex:0,foundFace:0}}ImportContent(e,t){let i=te(e);Ge(i,r=>{this.WasError()||this.ProcessLine(r)}),t()}ProcessLine(e){if(e[0]==="#")return;let t=Qe(e,"#");if(t.length!==0&&t[0]!=="OFF"){if(this.status.vertexCount===0&&this.status.faceCount===0){t.length>1&&(this.status.vertexCount=parseInt(t[0],10),this.status.faceCount=parseInt(t[1],10));return}if(this.status.foundVertex<this.status.vertexCount){t.length>=3&&(this.mesh.AddVertex(new T(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),this.status.foundVertex+=1);return}if(this.status.foundFace<this.status.faceCount){if(t.length>=4){let i=parseInt(t[0],10);if(t.length<i+1)return;for(let r=0;r<i-2;r++){let n=parseInt(t[1]),o=parseInt(t[r+2]),l=parseInt(t[r+3]),a=new z(n,o,l);this.mesh.AddTriangle(a)}this.status.foundFace+=1}return}}}};var lt={Ok:1,NoVertices:2,NoFaces:3,UnknownError:4},Ss=class{constructor(){this.format=null,this.elements=[]}SetFormat(e){this.format=e}AddElement(e,t){this.elements.push({name:e,count:t,format:[]})}GetElements(){return this.elements}AddSingleFormat(e,t){this.elements[this.elements.length-1].format.push({name:t,isSingle:!0,elemType:e})}AddListFormat(e,t,i){this.elements[this.elements.length-1].format.push({name:i,isSingle:!1,countType:e,elemType:t})}GetElement(e){for(let t=0;t<this.elements.length;t++){let i=this.elements[t];if(i.name===e)return i}return null}Check(){let e=this.GetElement("vertex");if(e===null||e.length===0||e.format.length<3)return lt.NoVertices;let t=this.GetElement("face");if(this.format==="ascii"){if(t===null||t.count===0||t.format.length<0)return lt.NoFaces}else if(this.format==="binary_little_endian"||this.format==="binary_big_endian"){let i=this.GetElement("tristrips"),r=t!==null&&t.count>0&&t.format.length>0,n=i!==null&&i.count>0&&i.format.length>0;if(!r&&!n)return lt.NoFaces}else return lt.UnknownError;return lt.Ok}},bs=class{constructor(e){this.model=e,this.colorToMaterial=new Map}GetMaterialIndexByColor(e){let t="Color "+ee(e[0])+ee(e[1])+ee(e[2])+ee(e[3]);if(this.colorToMaterial.has(t))return this.colorToMaterial.get(t);{let i=new K;i.name=t,i.color=new D(e[0],e[1],e[2]),i.opacity=e[3]/255,ce(i);let r=this.model.AddMaterial(i);return this.colorToMaterial.set(t,r),r}}},Gr=class extends W{constructor(){super()}CanImportExtension(e){return e==="ply"}GetUpDirection(){return G.Y}ClearContent(){this.mesh=null}ResetContent(){this.mesh=new X,this.model.AddMeshToRootNode(this.mesh)}ImportContent(e,t){let i=this.GetHeaderContent(e),r=this.ReadHeader(i),n=r.Check();if(n===lt.Ok)if(r.format==="ascii"){let o=te(e);o=o.substring(i.length),this.ReadAsciiContent(r,o)}else(r.format==="binary_little_endian"||r.format==="binary_big_endian")&&this.ReadBinaryContent(r,e,i.length);else n===lt.NoVertices?this.SetError("The model contains no vertices."):n===lt.NoFaces?this.SetError("The model contains no faces."):this.SetError("Invalid header information.");t()}GetHeaderContent(e){let t="",i=new Uint8Array(e),r=0;for(r=0;r<e.byteLength&&(t+=String.fromCharCode(i[r]),!t.endsWith("end_header"));r++);for(r+=1;r<e.byteLength;){let n=String.fromCharCode(i[r]);if(t+=n,r+=1,n===`
`)break}return t}ReadHeader(e){let t=new Ss;return Ge(e,i=>{let r=Qe(i,null);r.length===0||r[0]==="comment"||r[0]!=="ply"&&(r[0]==="format"&&r.length>=2?t.SetFormat(r[1]):r[0]==="element"&&r.length>=3?t.AddElement(r[1],parseInt(r[2],10)):r[0]==="property"&&r.length>=3&&(r[1]==="list"&&r.length>=5?t.AddListFormat(r[2],r[3],r[4]):t.AddSingleFormat(r[1],r[2])))}),t}ReadAsciiContent(e,t){let i=e.GetElement("vertex"),r=e.GetElement("face"),n=0,o=0;Ge(t,l=>{if(this.WasError())return;let a=Qe(l,null);if(!(a.length===0||a[0]==="comment")){if(n<i.count){a.length>=3&&(this.mesh.AddVertex(new T(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]))),n+=1);return}if(r!==null&&o<r.count){if(a.length>=4){let h=parseInt(a[0],10);if(a.length<h+1)return;for(let u=0;u<h-2;u++){let d=parseInt(a[1]),m=parseInt(a[u+2]),f=parseInt(a[u+3]),p=new z(d,m,f);this.mesh.AddTriangle(p)}o+=1}return}}})}ReadBinaryContent(e,t,i){function r(u,d){function m(f,p){return p==="char"||p==="int8"?f.ReadCharacter8():p==="uchar"||p==="uint8"?f.ReadUnsignedCharacter8():p==="short"||p==="int16"?f.ReadInteger16():p==="ushort"||p==="uint16"?f.ReadUnsignedInteger16():p==="int"||p==="int32"?f.ReadInteger32():p==="uint"||p==="uint32"?f.ReadUnsignedInteger32():p==="float"||p==="float32"?f.ReadFloat32():p==="double"||p==="double64"?f.ReadDouble64():null}if(d.isSingle)return m(u,d.elemType);{let f=[],p=m(u,d.countType);for(let c=0;c<p;c++)f.push(m(u,d.elemType));return f}}function n(u,d,m){for(let f=m;f<d.length;f++)r(u,d[f])}function o(u,d,m){let f=null,p=null,c=null,g=255;for(let x=m;x<d.length;x++){let C=d[x],M=r(u,C);C.name==="red"?f=M:C.name==="green"?p=M:C.name==="blue"?c=M:C.name==="alpha"&&(g=M)}return f!==null&&p!==null&&c!==null?[f,p,c,g]:null}let l=null;if(e.format==="binary_little_endian")l=new Pe(t,!0);else if(e.format==="binary_big_endian")l=new Pe(t,!1);else return;l.Skip(i);let a=new bs(this.model),h=e.GetElements();for(let u=0;u<h.length;u++){let d=h[u];if(d.name==="vertex")for(let m=0;m<d.count;m++){let f=r(l,d.format[0]),p=r(l,d.format[1]),c=r(l,d.format[2]),g=o(l,d.format,3);g!==null&&this.mesh.AddVertexColor(new D(g[0],g[1],g[2])),this.mesh.AddVertex(new T(f,p,c))}else if(d.name==="face")for(let m=0;m<d.count;m++){let f=r(l,d.format[0]),p=o(l,d.format,1);for(let c=0;c<f.length-2;c++){let g=f[0],x=f[c+1],C=f[c+2],M=new z(g,x,C);p!==null?M.mat=a.GetMaterialIndexByColor(p):this.mesh.VertexColorCount()>0&&M.SetVertexColors(g,x,C),this.mesh.AddTriangle(M)}}else if(d.name==="tristrips")for(let m=0;m<d.count;m++){let f=r(l,d.format[0]);n(l,d.format,1);let p=!0;for(let c=0;c<f.length-2;c++){let g=f[c],x=f[c+1],C=f[c+2];if(C===-1){c+=2,p=!0;continue}if(!p){let I=x;x=C,C=I}p=!p;let M=new z(g,x,C);this.mesh.AddTriangle(M)}}else n(l,d.format,0)}}};var Pr=class extends W{constructor(){super();this.worker=null}CanImportExtension(e){return e==="stp"||e==="step"}GetUpDirection(){return G.Y}ClearContent(){}ResetContent(){}ImportContent(e,t){if(this.worker===null){let n=$i("loaders/occt-import-js-worker-cdn.js");this.worker=new Worker(n)}let i=n=>{this.ImportStepContent(n.data,t),this.worker.removeEventListener("message",i)};this.worker.addEventListener("message",i),this.worker.addEventListener("error",n=>{this.worker=null,this.SetError("Failed to load occt-import-js."),t()});let r=new Uint8Array(e);this.worker.postMessage(r)}ImportStepContent(e,t){if(!e.success)return;let i=new vr(r=>{let n=new K;return n.name=ue(r).toUpperCase(),n.color=r,this.model.AddMaterial(n)});for(let r of e.meshes){let n=null;if(r.color){let l=Re(r.color[0],r.color[1],r.color[2]);n=i.GetMaterialIndex(l)}let o=Tt(r,n);if(r.name&&o.SetName(r.name),r.face_colors)for(let l of r.face_colors){let a=Re(l.color[0],l.color[1],l.color[2]),h=i.GetMaterialIndex(a);for(let u=l.first;u<=l.last;u++)o.GetTriangle(u).SetMaterial(h)}this.model.AddMeshToRootNode(o)}t()}};var _r=class extends W{constructor(){super()}CanImportExtension(e){return e==="stl"}GetUpDirection(){return G.Z}ClearContent(){this.mesh=null,this.triangle=null}ResetContent(){this.mesh=new X,this.model.AddMeshToRootNode(this.mesh),this.triangle=null}ImportContent(e,t){if(this.IsBinaryStlFile(e))this.ProcessBinary(e);else{let i=te(e);Ge(i,r=>{this.WasError()||this.ProcessLine(r)})}t()}IsBinaryStlFile(e){let t=e.byteLength;if(t<84)return!1;let i=new Pe(e,!0);i.Skip(80);let r=i.ReadUnsignedInteger32();return t===r*50+84}ProcessLine(e){if(e[0]==="#")return;let t=Qe(e,"#");if(t.length===0)return;let i=t[0];if(i==="solid"){if(t.length>1){let r=ot(e,i.length,"#");this.mesh.SetName(r)}return}if(i==="facet"){if(this.triangle=new z(-1,-1,-1),t.length>=5&&t[1]==="normal"){let r=new T(parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[4]));if(Ue(r.Length())){let n=this.mesh.AddNormal(r);this.triangle.SetNormals(n,n,n)}}return}if(i==="vertex"&&this.triangle!==null){if(t.length>=4){let r=this.mesh.AddVertex(new T(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])));this.triangle.v0===-1?this.triangle.v0=r:this.triangle.v1===-1?this.triangle.v1=r:this.triangle.v2===-1&&(this.triangle.v2=r)}return}if(i==="endfacet"&&this.triangle!==null){this.triangle.v0!==-1&&this.triangle.v1!==-1&&this.triangle.v2!==null&&this.mesh.AddTriangle(this.triangle),this.triangle=null;return}}ProcessBinary(e){function t(o){let l=new T;return l.x=o.ReadFloat32(),l.y=o.ReadFloat32(),l.z=o.ReadFloat32(),l}function i(o,l){let a=t(l);return o.AddVertex(a)}let r=new Pe(e,!0);r.Skip(80);let n=r.ReadUnsignedInteger32();for(let o=0;o<n;o++){let l=t(r),a=i(this.mesh,r),h=i(this.mesh,r),u=i(this.mesh,r);r.Skip(2);let d=new z(a,h,u);if(Ue(l.Length())){let m=this.mesh.AddNormal(l);d.SetNormals(m,m,m)}this.mesh.AddTriangle(d)}}};var Rr=class extends W{constructor(){super()}CanImportExtension(e){return e==="bim"}GetUpDirection(){return G.Z}ClearContent(){this.meshIdToMesh=null,this.colorToMaterialIndex=null}ResetContent(){this.meshIdToMesh=new Map,this.colorToMaterialIndex=new Map}ImportContent(e,t){let i=te(e),r=null;try{r=JSON.parse(i)}catch{this.SetError("Failed to parse bim file."),t();return}for(let n of r.meshes)this.meshIdToMesh.set(n.mesh_id,n);this.ImportProperties(r,this.model);for(let n of r.elements){let o=this.ImportElement(n);o.SetName(n.type),this.ImportProperties(n,o)}t()}ImportElement(e){let t=null;if(e.color){let m=ee(e.color.r)+ee(e.color.g)+ee(e.color.b)+ee(e.color.a);if(this.colorToMaterialIndex.has(m))t=this.colorToMaterialIndex.get(m);else{let f=new K;f.name=m,f.color=new D(e.color.r,e.color.g,e.color.b),e.color.a<255&&(f.opacity=e.color.a/255,ce(f)),t=this.model.AddMaterial(f),this.colorToMaterialIndex.set(m,t)}}let i=this.model.GetRootNode(),r=this.meshIdToMesh.get(e.mesh_id),n=this.ImportMesh(r,t),o=this.model.AddMesh(n),l=new ye;l.SetType(fe.MeshNode),l.AddMeshIndex(o);let a=new T(0,0,0);e.vector&&(a=new T(e.vector.x,e.vector.y,e.vector.z));let h=new Me(0,0,0,1);e.rotation&&(h=new Me(e.rotation.qx,e.rotation.qy,e.rotation.qz,e.rotation.qw));let u=new T(1,1,1),d=new U().ComposeTRS(a,h,u);return l.SetTransformation(new q(d)),i.AddChildNode(l),n}ImportMesh(e,t){let i=new X;for(let r=0;r<e.coordinates.length;r+=3)i.AddVertex(new T(e.coordinates[r+0],e.coordinates[r+1],e.coordinates[r+2]));for(let r=0;r<e.indices.length;r+=3){let n=new z(e.indices[r+0],e.indices[r+1],e.indices[r+2]);t!==null&&n.SetMaterial(t),i.AddTriangle(n)}return i}ImportProperties(e,t){function i(o,l,a){if(a==null)return;let h=new L(_.Text,l,a);o.AddProperty(h)}if(!e.info)return;let r=e.info,n=new Ae("Info");i(n,"Guid",e.guid),i(n,"Type",e.type);for(let o in r)Object.prototype.hasOwnProperty.call(r,o)&&typeof r[o]=="string"&&i(n,o,r[o]);t.AddPropertyGroup(n)}};var ei=class extends W{constructor(){super()}GetExternalLibraries(){return null}CreateLoader(e){return null}GetMainObject(e){return e}IsMeshVisible(e){return!0}ClearContent(){this.loader=null,this.materialIdToIndex=null,this.objectUrlToFileName=null}ResetContent(){this.loader=null,this.materialIdToIndex=new Map,this.objectUrlToFileName=new Map}ImportContent(e,t){async function i(n,o,l){try{for(let a=0;a<n.length;a++)await ge(n[a])}catch{l()}o()}let r=this.GetExternalLibraries();if(r===null){t();return}i(r,()=>{this.LoadModel(e,t)},()=>{this.SetError("Failed to load three.js loader."),t()})}LoadModel(e,t){let i=!1,r=new THREE.LoadingManager(()=>{i=!0}),n=gt(e);r.setURLModifier(l=>{if(l===n)return l;let a=re(l);if(Ve(l).length>0){let u=this.callbacks.getFileBuffer(l);if(u!==null){let d=gt(u);return this.objectUrlToFileName.set(d,a),d}}return l});let o=this.CreateLoader(r);if(o===null){t();return}o.load(n,l=>{Qn(()=>i?(this.OnThreeObjectsLoaded(l,t),!1):!0)},()=>{},l=>{this.SetError(l),t()})}OnThreeObjectsLoaded(e,t){function i(l){let a=new U().CreateIdentity();return l.updateMatrix(),l.matrix!==void 0&&l.matrix!==null&&a.Set(l.matrix.elements),new q(a)}function r(l,a,h,u){let d=new ye;h.name!==void 0&&d.SetName(h.name),d.SetTransformation(i(h)),u.AddChildNode(d);for(let m of h.children)r(l,a,m,d);if(h.isMesh&&l.IsMeshVisible(h)){h.children.length===0&&d.SetType(fe.MeshNode);let m=l.ConvertThreeMesh(h),f=a.AddMesh(m);d.AddMeshIndex(f)}}let n=this.GetMainObject(e),o=this.model.GetRootNode();o.SetTransformation(i(n));for(let l of n.children)r(this,this.model,l,o);t()}ConvertThreeMesh(e){let t=null;if(Array.isArray(e.material)){if(t=Tt(e.geometry,null),e.geometry.attributes.color===void 0||e.geometry.attributes.color===null){let i=[];for(let r=0;r<e.material.length;r++){let n=e.material[r],o=this.FindOrCreateMaterial(n);i.push(o)}for(let r=0;r<e.geometry.groups.length;r++){let n=e.geometry.groups[r],o=null;n.count===1/0?o=t.TriangleCount():o=n.start/3+n.count/3;for(let l=n.start/3;l<o;l++)t.GetTriangle(l).SetMaterial(i[n.materialIndex])}}}else{let i=this.FindOrCreateMaterial(e.material);t=Tt(e.geometry,i)}return e.name!==void 0&&e.name!==null&&t.SetName(e.name),t}FindOrCreateMaterial(e){if(this.materialIdToIndex.has(e.id))return this.materialIdToIndex.get(e.id);let t=this.ConvertThreeMaterial(e),i=this.model.AddMaterial(t);return this.materialIdToIndex.set(e.id,i),i}ConvertThreeMaterial(e){function t(r,n){function o(l){if(l.data!==void 0&&l.data!==null){let a=new ImageData(l.width,l.height),h=l.width*l.height*4;for(let u=0;u<h;u++)a.data[u]=l.data[u];return THREE.ImageUtils.getDataURL(a)}else return THREE.ImageUtils.getDataURL(l)}if(r==null||r.image===void 0||r.image===null)return null;try{let l=o(r.image),a=Kt(l),h=new Ze,u=null;return n.has(r.image.src)?u=n.get(r.image.src):r.name!==void 0&&r.name!==null?u=r.name+"."+Ot(a.mimeType):u="Embedded_"+r.id.toString()+"."+Ot(a.mimeType),h.name=u,h.url=l,h.buffer=a.buffer,h.rotation=r.rotation,h.offset.x=r.offset.x,h.offset.y=r.offset.y,h.scale.x=r.repeat.x,h.scale.y=r.repeat.y,h}catch{return null}}let i=new K;return i.name=e.name,i.color=Ni(e.color),i.opacity=e.opacity,i.transparent=e.transparent,i.alphaTest=e.alphaTest,e.type==="MeshPhongMaterial"&&(i.specular=Ni(e.specular),i.shininess=e.shininess/100),i.diffuseMap=t(e.map,this.objectUrlToFileName),i.normalMap=t(e.normalMap,this.objectUrlToFileName),i.bumpMap=t(e.bumpMap,this.objectUrlToFileName),i}},Fr=class extends ei{constructor(){super()}CanImportExtension(e){return e==="fbx"}GetUpDirection(){return G.Y}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/TGALoader.js","three_loaders/FBXLoader.js"]}CreateLoader(e){return e.addHandler(/\.tga$/i,new THREE.TGALoader(e)),new THREE.FBXLoader(e)}GetMainObject(e){return e}},Nr=class extends ei{constructor(){super()}CanImportExtension(e){return e==="dae"}GetUpDirection(){return G.Y}GetExternalLibraries(){return["three_loaders/TGALoader.js","three_loaders/ColladaLoader.js"]}CreateLoader(e){return e.addHandler(/\.tga$/i,new THREE.TGALoader(e)),new THREE.ColladaLoader(e)}GetMainObject(e){return e.scene}},Vr=class extends ei{constructor(){super()}CanImportExtension(e){return e==="wrl"}GetUpDirection(){return G.Y}GetExternalLibraries(){return["three_loaders/chevrotain.min.js","three_loaders/VRMLLoader.js"]}CreateLoader(e){return new THREE.VRMLLoader(e)}GetMainObject(e){return e}IsMeshVisible(e){let t=!0;if(Array.isArray(e.material)){for(let i=0;i<e.material.length;i++)if(e.material[i].side===THREE.BackSide){t=!1;break}}else t=e.material.side!==THREE.BackSide;return t}},Lr=class extends ei{constructor(){super()}CanImportExtension(e){return e==="3mf"}GetUpDirection(){return G.Z}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/3MFLoader.js"]}CreateLoader(e){return new THREE.ThreeMFLoader(e)}GetMainObject(e){return e}};var Wt=class{constructor(){this.defaultColor=new D(200,200,200)}},_e={NoImportableFile:1,FailedToLoadFile:2,ImportFailed:3,UnknownError:4},ti=class{constructor(e){this.code=e,this.mainFile=null,this.message=null}},ws=class{constructor(){this.model=null,this.mainFile=null,this.upVector=null,this.usedFiles=null,this.missingFiles=null}},Es=class{constructor(e){this.getBufferCallback=e,this.fileBuffers=new Map,this.textureBuffers=new Map}GetFileBuffer(e){let t=re(e);if(this.fileBuffers.has(t))return this.fileBuffers.get(t);let i=this.getBufferCallback(t);return this.fileBuffers.set(t,i),i}GetTextureBuffer(e){let t=re(e);if(this.textureBuffers.has(t))return this.textureBuffers.get(t);let i=null,r=this.getBufferCallback(t);return r!==null&&(i={url:gt(r),buffer:r}),this.textureBuffers.set(t,i),i}},Br=class{constructor(){this.importers=[new Ar,new _r,new Dr,new Gr,new Tr,new yr,new Er,new Rr,new Ir,new Sr,new Pr,new Fr,new Nr,new Vr,new Lr],this.fileList=new Pi,this.model=null,this.usedFiles=[],this.missingFiles=[]}AddImporter(e){this.importers.push(e)}ImportFiles(e,t,i,r){this.LoadFiles(e,t,()=>{r.onFilesLoaded(),Ct(()=>{this.ImportLoadedFiles(i,r)})})}LoadFiles(e,t,i){let r=new Pi;t===Z.Url?r.FillFromFileUrls(e):t===Z.File&&r.FillFromFileObjects(e);let n=!1;if(this.HasImportableFile(r))n=!0;else{let o=!1;for(let l=0;l<this.missingFiles.length;l++){let a=this.missingFiles[l];r.ContainsFileByPath(a)&&(o=!0)}if(!o)n=!0;else{let l=r.GetFiles();this.fileList.ExtendFromFileList(l),n=!1}}n&&(this.fileList=r),this.fileList.GetContent(()=>{this.DecompressArchives(this.fileList,()=>{i()})})}ImportLoadedFiles(e,t){let i=this.GetImportableFiles(this.fileList);if(i.length===0){t.onImportError(new ti(_e.NoImportableFile));return}if(i.length===1||!t.onSelectMainFile){let r=i[0];this.ImportLoadedMainFile(r,e,t)}else{let r=i.map(n=>n.file.name);t.onSelectMainFile(r,n=>{if(n===null){t.onImportError(new ti(_e.NoImportableFile));return}Ct(()=>{let o=i[n];this.ImportLoadedMainFile(o,e,t)})})}}ImportLoadedMainFile(e,t,i){if(e===null||e.file===null||e.file.content===null){let o=new ti(_e.FailedToLoadFile);e!==null&&e.file!==null&&(o.mainFile=e.file.name),i.onImportError(o);return}this.RevokeModelUrls(),this.model=null,this.usedFiles=[],this.missingFiles=[],this.usedFiles.push(e.file.name);let r=e.importer,n=new Es(o=>{let l=null,a=this.fileList.FindFileByPath(o);return a===null||a.content===null?(this.missingFiles.push(o),l=null):(this.usedFiles.push(o),l=a.content),l});r.Import(e.file.name,e.file.extension,e.file.content,{getDefaultMaterialColor:()=>t.defaultColor,getFileBuffer:o=>n.GetFileBuffer(o),getTextureBuffer:o=>n.GetTextureBuffer(o),onSuccess:()=>{this.model=r.GetModel();let o=new ws;o.mainFile=e.file.name,o.model=this.model,o.usedFiles=this.usedFiles,o.missingFiles=this.missingFiles,o.upVector=r.GetUpDirection(),i.onImportSuccess(o)},onError:()=>{let o=new ti(_e.ImportFailed);o.mainFile=e.file.name,o.message=r.GetErrorMessage(),i.onImportError(o)},onComplete:()=>{r.Clear()}})}DecompressArchives(e,t){let i=e.GetFiles(),r=[];for(let n of i)n.extension==="zip"&&r.push(n);if(r.length===0){t();return}ge("loaders/fflate.min.js").then(()=>{for(let n=0;n<r.length;n++){let o=r[n],l=new Uint8Array(o.content),a=fflate.unzipSync(l);for(let h in a)if(Object.prototype.hasOwnProperty.call(a,h)){let u=new Gi(h,Z.Decompressed);u.SetContent(a[h].buffer),e.AddFile(u)}}t()}).catch(()=>{t()})}GetFileList(){return this.fileList}HasImportableFile(e){return this.GetImportableFiles(e).length>0}GetImportableFiles(e){function t(n,o){for(let l=0;l<o.length;l++){let a=o[l];if(a.CanImportExtension(n.extension))return a}return null}let i=[],r=e.GetFiles();for(let n=0;n<r.length;n++){let o=r[n],l=t(o,this.importers);l!==null&&i.push({file:o,importer:l})}return i}RevokeModelUrls(){if(this.model!==null)for(let e=0;e<this.model.MaterialCount();e++)this.model.GetMaterial(e).EnumerateTextureMaps(i=>{i.url!==null&&Fn(i.url)})}};function As(s,e,t){let i=e/t,r=i*i;return s*(r/(2*(r-i)+1))}function ki(s,e,t,i){let r=oe(e,s).Normalize(),n=Ne(s,e),o=[];for(let l=0;l<t;l++){let a=i(n,l,t-1);o.push(s.Clone().Offset(r,a))}return o}var Ds=class{constructor(){this.prev=new B(0,0),this.curr=new B(0,0),this.diff=new B(0,0),this.buttons=[]}Down(e,t){this.buttons.push(t.which),this.curr=this.GetPositionFromEvent(e,t),this.prev=this.curr.Clone()}Move(e,t){this.curr=this.GetPositionFromEvent(e,t),this.diff=tr(this.curr,this.prev),this.prev=this.curr.Clone()}Up(e,t){let i=this.buttons.indexOf(t.which);i!==-1&&this.buttons.splice(i,1),this.curr=this.GetPositionFromEvent(e,t)}Leave(e,t){this.buttons=[],this.curr=this.GetPositionFromEvent(e,t)}IsButtonDown(){return this.buttons.length>0}GetButton(){let e=this.buttons.length;return e===0?0:this.buttons[e-1]}GetPosition(){return this.curr}GetMoveDiff(){return this.diff}GetPositionFromEvent(e,t){return ft(e,t.clientX,t.clientY)}},Gs=class{constructor(){this.prevPos=new B(0,0),this.currPos=new B(0,0),this.diffPos=new B(0,0),this.prevDist=0,this.currDist=0,this.diffDist=0,this.fingers=0}Start(e,t){t.touches.length!==0&&(this.fingers=t.touches.length,this.currPos=this.GetPositionFromEvent(e,t),this.prevPos=this.currPos.Clone(),this.currDist=this.GetTouchDistanceFromEvent(e,t),this.prevDist=this.currDist)}Move(e,t){t.touches.length!==0&&(this.currPos=this.GetPositionFromEvent(e,t),this.diffPos=tr(this.currPos,this.prevPos),this.prevPos=this.currPos.Clone(),this.currDist=this.GetTouchDistanceFromEvent(e,t),this.diffDist=this.currDist-this.prevDist,this.prevDist=this.currDist)}End(e,t){t.touches.length!==0&&(this.fingers=0,this.currPos=this.GetPositionFromEvent(e,t),this.currDist=this.GetTouchDistanceFromEvent(e,t))}IsFingerDown(){return this.fingers!==0}GetFingerCount(){return this.fingers}GetPosition(){return this.currPos}GetMoveDiff(){return this.diffPos}GetDistanceDiff(){return this.diffDist}GetPositionFromEvent(e,t){let i=null;if(t.touches.length!==0){let r=t.touches[0];i=ft(e,r.pageX,r.pageY)}return i}GetTouchDistanceFromEvent(e,t){if(t.touches.length!==2)return 0;let i=t.touches[0],r=t.touches[1];return ir(ft(e,i.pageX,i.pageY),ft(e,r.pageX,r.pageY))}},Ps=class{constructor(){this.isClick=!1,this.startPosition=null}Start(e){this.isClick=!0,this.startPosition=e}Move(e){!this.isClick||(this.startPosition!==null?ir(this.startPosition,e)>3&&this.Cancel():this.Cancel())}End(){this.startPosition=null}Cancel(){this.isClick=!1,this.startPosition=null}IsClick(){return this.isClick}},be={None:0,Orbit:1,Pan:2,Zoom:3},Or=class{constructor(e,t,i){this.canvas=e,this.camera=t,this.callbacks=i,this.fixUpVector=!0,this.mouse=new Ds,this.touch=new Gs,this.clickDetector=new Ps,this.onMouseClick=null,this.onMouseMove=null,this.onContext=null,this.canvas.addEventListener&&(this.canvas.addEventListener("mousedown",this.OnMouseDown.bind(this)),this.canvas.addEventListener("wheel",this.OnMouseWheel.bind(this)),this.canvas.addEventListener("touchstart",this.OnTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this.OnTouchMove.bind(this)),this.canvas.addEventListener("touchcancel",this.OnTouchEnd.bind(this)),this.canvas.addEventListener("touchend",this.OnTouchEnd.bind(this)),this.canvas.addEventListener("contextmenu",this.OnContextMenu.bind(this))),document.addEventListener&&(document.addEventListener("mousemove",this.OnMouseMove.bind(this)),document.addEventListener("mouseup",this.OnMouseUp.bind(this)),document.addEventListener("mouseleave",this.OnMouseLeave.bind(this)))}SetMouseClickHandler(e){this.onMouseClick=e}SetMouseMoveHandler(e){this.onMouseMove=e}SetContextMenuHandler(e){this.onContext=e}IsFixUpVector(){return this.fixUpVector}SetFixUpVector(e){this.fixUpVector=e}GetCamera(){return this.camera}SetCamera(e){this.camera=e}MoveCamera(e,t){function i(r,n,o,l){r.camera.eye=n.eye[l],r.camera.center=n.center[l],r.camera.up=n.up[l],r.Update(),l<o-1&&requestAnimationFrame(()=>{i(r,n,o,l+1)})}if(e!==null){if(t===0||jn(this.camera,e))this.camera=e;else{let r=As,n={eye:ki(this.camera.eye,e.eye,t,r),center:ki(this.camera.center,e.center,t,r),up:ki(this.camera.up,e.up,t,r)};requestAnimationFrame(()=>{i(this,n,t,0)})}this.Update()}}GetFitToSphereCamera(e,t,i){if(Xt(t))return null;let r=this.camera.Clone(),n=oe(r.center,e);r.eye=oe(r.eye,n),r.center=e.Clone();let o=oe(r.eye,r.center).Normalize(),l=i/2;this.canvas.width<this.canvas.height&&(l=l*this.canvas.width/this.canvas.height);let a=t/Math.sin(l*Nt);return r.eye=r.center.Clone().Offset(o,a),r}OnMouseDown(e){e.preventDefault(),this.mouse.Down(this.canvas,e),this.clickDetector.Start(this.mouse.GetPosition())}OnMouseMove(e){if(this.mouse.Move(this.canvas,e),this.clickDetector.Move(this.mouse.GetPosition()),this.onMouseMove){let n=ft(this.canvas,e.clientX,e.clientY);this.onMouseMove(n)}if(!this.mouse.IsButtonDown())return;let t=this.mouse.GetMoveDiff(),i=this.mouse.GetButton(),r=be.None;if(i===1?e.ctrlKey?r=be.Zoom:e.shiftKey?r=be.Pan:r=be.Orbit:(i===2||i===3)&&(r=be.Pan),r===be.Orbit){let n=.5;this.Orbit(t.x*n,t.y*n)}else if(r===be.Pan){let n=Ne(this.camera.eye,this.camera.center),o=.001*n;this.Pan(t.x*o,t.y*o)}else if(r===be.Zoom){let n=.005;this.Zoom(-t.y*n)}this.Update()}OnMouseUp(e){if(this.mouse.Up(this.canvas,e),this.clickDetector.End(),this.clickDetector.IsClick()){let t=this.mouse.GetPosition();this.Click(e.which,t)}}OnMouseLeave(e){this.mouse.Leave(this.canvas,e),this.clickDetector.Cancel()}OnTouchStart(e){e.preventDefault(),this.touch.Start(this.canvas,e),this.clickDetector.Start(this.touch.GetPosition())}OnTouchMove(e){if(e.preventDefault(),this.touch.Move(this.canvas,e),this.clickDetector.Move(this.touch.GetPosition()),!this.touch.IsFingerDown())return;let t=this.touch.GetMoveDiff(),i=this.touch.GetDistanceDiff(),r=this.touch.GetFingerCount(),n=be.None;if(r===1?n=be.Orbit:r===2&&(n=be.Pan),n===be.Orbit){let o=.5;this.Orbit(t.x*o,t.y*o)}else if(n===be.Pan){let o=.005;this.Zoom(i*o);let l=.001*Ne(this.camera.eye,this.camera.center);this.Pan(t.x*l,t.y*l)}this.Update()}OnTouchEnd(e){if(e.preventDefault(),this.touch.End(this.canvas,e),this.clickDetector.End(),this.clickDetector.IsClick()){let t=this.touch.GetPosition();this.touch.GetFingerCount()===1&&this.Click(1,t)}}OnMouseWheel(e){let t=e||window.event;t.preventDefault();let i=-t.deltaY/40,r=.1;i<0&&(r=r*-1),this.Zoom(r),this.Update()}OnContextMenu(e){e.preventDefault(),this.clickDetector.IsClick()&&(this.Context(e.clientX,e.clientY),this.clickDetector.Cancel())}Orbit(e,t){let i=e*Nt,r=t*Nt,n=oe(this.camera.center,this.camera.eye).Normalize(),o=Ye(n,this.camera.up).Normalize();if(this.fixUpVector){let a=Wn(n,this.camera.up)+r;bn(a,0)&&pi(a,Math.PI)&&this.camera.eye.Rotate(o,-r,this.camera.center),this.camera.eye.Rotate(this.camera.up,-i,this.camera.center)}else{let l=Ye(o,n).Normalize();this.camera.eye.Rotate(o,-r,this.camera.center),this.camera.eye.Rotate(l,-i,this.camera.center),this.camera.up=l}}Pan(e,t){let i=oe(this.camera.center,this.camera.eye).Normalize(),r=Ye(i,this.camera.up).Normalize(),n=Ye(r,i).Normalize();this.camera.eye.Offset(r,-e),this.camera.center.Offset(r,-e),this.camera.eye.Offset(n,t),this.camera.center.Offset(n,t)}Zoom(e){let t=oe(this.camera.center,this.camera.eye),r=t.Length()*e;this.camera.eye.Offset(t,r)}Update(){this.callbacks.onUpdate()}Click(e,t){this.onMouseClick&&this.onMouseClick(e,t)}Context(e,t){if(this.onContext){let i={x:e,y:t},r=ft(this.canvas,e,t);this.onContext(i,r)}}};function _s(s,e){function t(i,r){for(let n of i)n.polygonOffset=r,n.polygonOffsetUnit=1,n.polygonOffsetFactor=1}t(s.material,e),s.userData.threeMaterials&&t(s.userData.threeMaterials,e)}var kr=class{constructor(e){this.scene=e,this.mainObject=null,this.mainEdgeObject=null,this.edgeSettings={showEdges:!1,edgeColor:new D(0,0,0),edgeThreshold:1}}SetMainObject(e){this.mainObject=e,this.scene.add(this.mainObject),this.edgeSettings.showEdges&&this.GenerateMainEdgeObject()}UpdateWorldMatrix(){this.mainObject!==null&&this.mainObject.updateWorldMatrix(!0,!0)}SetEdgeSettings(e,t,i){let r=!1;if(e&&(!this.edgeSettings.showEdges||this.edgeSettings.edgeThreshold!==i)&&(r=!0),this.edgeSettings.showEdges=e,this.edgeSettings.edgeThreshold=i,this.edgeSettings.edgeColor=t,this.mainObject!==null)if(this.edgeSettings.showEdges)if(r)this.ClearMainEdgeObject(),this.GenerateMainEdgeObject();else{let n=De(this.edgeSettings.edgeColor);this.EnumerateEdges(o=>{o.material.color=n})}else this.ClearMainEdgeObject()}GenerateMainEdgeObject(){let e=De(this.edgeSettings.edgeColor);this.mainEdgeObject=new THREE.Object3D,this.UpdateWorldMatrix(),this.EnumerateMeshes(t=>{_s(t,!0);let i=new THREE.EdgesGeometry(t.geometry,this.edgeSettings.edgeThreshold),r=new THREE.LineSegments(i,new THREE.LineBasicMaterial({color:e}));r.applyMatrix4(t.matrixWorld),r.userData=t.userData,r.visible=t.visible,this.mainEdgeObject.add(r)}),this.scene.add(this.mainEdgeObject)}GetBoundingBox(e){let t=!1,i=new THREE.Box3;return this.EnumerateMeshes(r=>{e(r.userData)&&(i.union(new THREE.Box3().setFromObject(r)),t=!0)}),t?i:null}GetBoundingSphere(e){let t=this.GetBoundingBox(e);if(t===null)return null;let i=new THREE.Sphere;return t.getBoundingSphere(i),i}Clear(){this.ClearMainObject(),this.ClearMainEdgeObject()}ClearMainObject(){this.mainObject!==null&&(this.EnumerateMeshes(e=>{e.geometry.dispose()}),this.scene.remove(this.mainObject),this.mainObject=null)}ClearMainEdgeObject(){this.mainEdgeObject!==null&&(this.EnumerateMeshes(e=>{_s(e,!1)}),this.EnumerateEdges(e=>{e.geometry.dispose()}),this.scene.remove(this.mainEdgeObject),this.mainEdgeObject=null)}EnumerateMeshes(e){this.mainObject!==null&&this.mainObject.traverse(t=>{t.isMesh&&e(t)})}EnumerateEdges(e){this.mainEdgeObject!==null&&this.mainEdgeObject.traverse(t=>{t.isLineSegments&&e(t)})}GetMeshIntersectionUnderMouse(e,t,i,r){if(this.mainObject===null)return null;let n=new THREE.Raycaster,o=new THREE.Vector2;o.x=e.x/i*2-1,o.y=-(e.y/r)*2+1,n.setFromCamera(o,t);let l=n.intersectObject(this.mainObject,!0);for(let a=0;a<l.length;a++){let h=l[a];if(h.object.type==="Mesh"&&h.object.visible)return h}return null}},Ur=class{constructor(e){this.scene=e,this.mainObject=null}AddObject(e){this.mainObject===null&&(this.mainObject=new THREE.Object3D,this.scene.add(this.mainObject)),this.mainObject.add(e)}Clear(){this.mainObject!==null&&(this.mainObject.traverse(e=>{(e.isMesh||e.isLineSegments)&&e.geometry.dispose()}),this.scene.remove(this.mainObject),this.mainObject=null)}};function Rs(s){return s===G.X?new Je(new T(2,-3,1.5),new T(0,0,0),new T(1,0,0)):s===G.Y?new Je(new T(-1.5,2,3),new T(0,0,0),new T(0,1,0)):s===G.Z?new Je(new T(-1.5,-3,2),new T(0,0,0),new T(0,0,1)):null}function Fs(s,e){if(!e(s))return!1;for(let t of s.children)if(!Fs(t,e))return!1;return!0}function go(s){let e=null;return Fs(s,t=>{if(t.isMesh)for(let i of t.material)return i.type==="MeshPhongMaterial"?e=me.Phong:i.type==="MeshStandardMaterial"&&(e=me.Physical),!1;return!0}),e}var Ns=class{constructor(){this.direction=G.Z,this.isFixed=!0,this.isFlipped=!1}SetDirection(e,t){this.direction=e,this.isFlipped=!1;let i=Rs(this.direction),r=oe(i.eye,i.center),n=Ne(t.center,t.eye),o=t.center.Clone().Offset(r,n),l=t.Clone();return this.direction===G.X?(l.up=new T(1,0,0),l.eye=o):this.direction===G.Y?(l.up=new T(0,1,0),l.eye=o):this.direction===G.Z&&(l.up=new T(0,0,1),l.eye=o),l}SetFixed(e,t){return this.isFixed=e,this.isFixed?this.SetDirection(this.direction,t):null}Flip(e){this.isFlipped=!this.isFlipped;let t=e.Clone();return t.up.MultiplyScalar(-1),t}},Vs=class{constructor(e){this.scene=e,this.type=me.Phong,this.ambientLight=new THREE.AmbientLight(8947848),this.directionalLight=new THREE.DirectionalLight(8947848),this.environment=null,this.backgroundIsEnvMap=!1,this.scene.add(this.ambientLight),this.scene.add(this.directionalLight)}SetType(e){this.type=e,this.UpdateShading()}UpdateShading(){this.type===me.Phong?(this.ambientLight.color.set(8947848),this.directionalLight.color.set(8947848),this.scene.environment=null,this.scene.background=null):this.type===me.Physical&&(this.ambientLight.color.set(0),this.directionalLight.color.set(5592405),this.scene.environment=this.environment,this.backgroundIsEnvMap?this.scene.background=this.environment:this.scene.background=null)}SetEnvironment(e,t,i){let r=new THREE.CubeTextureLoader;this.environment=r.load(e,()=>{i()}),this.backgroundIsEnvMap=t}UpdateByCamera(e){let t=oe(e.eye,e.center);this.directionalLight.position.set(t.x,t.y,t.z)}CreateHighlightMaterial(e,t){let i=null;return this.type===me.Phong?i=new THREE.MeshPhongMaterial({color:e,side:THREE.DoubleSide}):this.type===me.Physical&&(i=new THREE.MeshStandardMaterial({color:e,side:THREE.DoubleSide})),i!==null&&t&&(i.polygonOffset=!0,i.polygonOffsetUnit=1,i.polygonOffsetFactor=1),i}},ii=class{constructor(){this.canvas=null,this.renderer=null,this.scene=null,this.geometry=null,this.extraGeometry=null,this.camera=null,this.shading=null,this.navigation=null,this.upVector=null,this.settings={animationSteps:40}}Init(e){this.canvas=e,this.canvas.id="viewer";let t={canvas:this.canvas,antialias:!0};this.renderer=new THREE.WebGLRenderer(t),window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setClearColor("#ffffff",1),this.renderer.setSize(this.canvas.width,this.canvas.height),this.scene=new THREE.Scene,this.geometry=new kr(this.scene),this.extraGeometry=new Ur(this.scene),this.InitNavigation(),this.InitShading(),this.Render()}SetMouseClickHandler(e){this.navigation.SetMouseClickHandler(e)}SetMouseMoveHandler(e){this.navigation.SetMouseMoveHandler(e)}SetContextMenuHandler(e){this.navigation.SetContextMenuHandler(e)}SetEnvironmentMapSettings(e,t){this.shading.SetEnvironment(e,t,()=>{this.Render()}),this.shading.UpdateShading(),this.Render()}SetBackgroundColor(e){let t="#"+ue(e);this.renderer.setClearColor(t,1),this.Render()}SetEdgeSettings(e,t,i){this.geometry.SetEdgeSettings(e,t,i),this.Render()}GetCanvas(){return this.canvas}GetCamera(){return this.navigation.GetCamera()}SetCamera(e){this.navigation.SetCamera(e),this.Render()}Resize(e,t){let i=An(this.canvas,e,t);this.ResizeRenderer(i.width,i.height)}ResizeRenderer(e,t){window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.Render()}FitSphereToWindow(e,t){if(e===null)return;let i=new T(e.center.x,e.center.y,e.center.z),r=e.radius,n=this.camera.fov,o=this.navigation.GetFitToSphereCamera(i,r,n);this.navigation.MoveCamera(o,t?this.settings.animationSteps:0)}AdjustClippingPlanesToSphere(e){e!==null&&(e.radius<10?(this.camera.near=.01,this.camera.far=100):e.radius<100?(this.camera.near=.1,this.camera.far=1e3):e.radius<1e3?(this.camera.near=10,this.camera.far=1e4):(this.camera.near=100,this.camera.far=1e6),this.camera.updateProjectionMatrix(),this.Render())}IsFixUpVector(){return this.navigation.IsFixUpVector()}SetFixUpVector(e){let t=this.navigation.GetCamera(),i=this.upVector.SetFixed(e,t);this.navigation.SetFixUpVector(e),i!==null&&this.navigation.MoveCamera(i,this.settings.animationSteps),this.Render()}SetUpVector(e,t){let i=this.navigation.GetCamera(),r=this.upVector.SetDirection(e,i),n=t?this.settings.animationSteps:0;this.navigation.MoveCamera(r,n),this.Render()}FlipUpVector(){let e=this.navigation.GetCamera(),t=this.upVector.Flip(e);this.navigation.MoveCamera(t,0),this.Render()}Render(){let e=this.navigation.GetCamera();this.camera.position.set(e.eye.x,e.eye.y,e.eye.z),this.camera.up.set(e.up.x,e.up.y,e.up.z),this.camera.lookAt(new THREE.Vector3(e.center.x,e.center.y,e.center.z)),this.shading.UpdateByCamera(e),this.renderer.render(this.scene,this.camera)}SetMainObject(e){let t=go(e);this.geometry.SetMainObject(e),this.shading.SetType(t),this.Render()}AddExtraObject(e){this.extraGeometry.AddObject(e),this.Render()}Clear(){this.geometry.Clear(),this.extraGeometry.Clear(),this.Render()}ClearExtra(){this.extraGeometry.Clear(),this.Render()}SetMeshesVisibility(e){this.geometry.EnumerateMeshes(t=>{let i=e(t.userData);t.visible!==i&&(t.visible=i)}),this.geometry.EnumerateEdges(t=>{let i=e(t.userData);t.visible!==i&&(t.visible=i)}),this.Render()}SetMeshesHighlight(e,t){function i(n,o){let l=[];for(let a=0;a<n.length;a++)l.push(o);return l}let r=this.CreateHighlightMaterial(e);this.geometry.EnumerateMeshes(n=>{t(n.userData)?n.userData.threeMaterials===null&&(n.userData.threeMaterials=n.material,n.material=i(n.material,r)):n.userData.threeMaterials!==null&&(n.material=n.userData.threeMaterials,n.userData.threeMaterials=null)}),this.Render()}CreateHighlightMaterial(e){let t=this.geometry.edgeSettings.showEdges;return this.shading.CreateHighlightMaterial(e,t)}GetMeshUserDataUnderMouse(e){let t=this.GetMeshIntersectionUnderMouse(e);return t===null?null:t.object.userData}GetMeshIntersectionUnderMouse(e){let t=this.GetCanvasSize(),i=this.geometry.GetMeshIntersectionUnderMouse(e,this.camera,t.width,t.height);return i===null?null:i}GetBoundingBox(e){return this.geometry.GetBoundingBox(e)}GetBoundingSphere(e){return this.geometry.GetBoundingSphere(e)}EnumerateMeshesUserData(e){this.geometry.EnumerateMeshes(t=>{e(t.userData)})}InitNavigation(){this.camera=new THREE.PerspectiveCamera(45,this.canvas.width/this.canvas.height,.1,1e3),this.scene.add(this.camera);let e=this.renderer.domElement,t=Rs(G.Z);this.navigation=new Or(e,t,{onUpdate:()=>{this.Render()}}),this.upVector=new Ns}InitShading(){this.shading=new Vs(this.scene)}GetShadingType(){return this.shading.type}GetImageSize(){let e=new THREE.Vector2;return this.renderer.getSize(e),{width:parseInt(e.x,10),height:parseInt(e.y,10)}}GetCanvasSize(){let e=this.canvas.width,t=this.canvas.height;return window.devicePixelRatio&&(e/=window.devicePixelRatio,t/=window.devicePixelRatio),{width:e,height:t}}GetImageAsDataUrl(e,t){let i=this.GetImageSize(),r=e,n=t;window.devicePixelRatio&&(r/=window.devicePixelRatio,n/=window.devicePixelRatio),this.ResizeRenderer(r,n),this.Render();let o=this.renderer.domElement.toDataURL();return this.ResizeRenderer(i.width,i.height),o}};var ri=class{constructor(){this.skipNextEvent=!1,this.eventListener=null}SetEventListener(e){this.eventListener=e,window.onhashchange=this.OnChange.bind(this)}SkipNextEventHandler(){this.skipNextEvent=!0}HasHash(){return this.GetHash().length>0}ClearHash(){this.SetHash("")}GetModelFilesFromHash(){return xt(this.GetHash()).GetModelUrls()}SetModelFilesToHash(e){let t=Ai(e);this.SetHash(t)}GetCameraFromHash(){return xt(this.GetHash()).GetCamera()}GetBackgroundFromHash(){return xt(this.GetHash()).GetBackgroundColor()}GetEnvironmentSettingsFromHash(){return xt(this.GetHash()).GetEnvironmentSettings()}GetDefaultColorFromHash(){return xt(this.GetHash()).GetDefaultColor()}GetEdgeSettingsFromHash(){return xt(this.GetHash()).GetEdgeSettings()}GetHash(){return window.location.hash.substring(1)}SetHash(e){window.location.hash=e}OnChange(){if(this.skipNextEvent){this.skipNextEvent=!1;return}this.eventListener()}};var Hr=class{constructor(){this.forceMediumpForMaterials=!1}},zr=class{constructor(){this.defaultMaterial=null}},Ls=class{constructor(e){this.callbacks=e,this.texturesNeeded=0,this.texturesLoaded=0,this.threeObject=null}OnTextureNeeded(){this.texturesNeeded+=1}OnTextureLoaded(){this.texturesLoaded+=1,this.callbacks.onTextureLoaded(),this.Finish()}OnModelLoaded(e){this.threeObject=e,this.Finish()}Finish(){this.threeObject!==null&&this.texturesNeeded===this.texturesLoaded&&this.callbacks.onModelLoaded(this.threeObject)}},Bs=class{constructor(e,t){this.meshInstances=[],this.AddNode(e,t)}AddNode(e,t){let i=e.GetTransformation().GetMatrix(),r=new THREE.Matrix4().fromArray(i.Get());t.applyMatrix4(r);for(let n of e.GetChildNodes()){let o=new THREE.Object3D;t.add(o),this.AddNode(n,o)}for(let n of e.GetMeshIndices())this.meshInstances.push({node:e,threeNode:t,meshIndex:n})}GetMeshInstances(){return this.meshInstances}};function Os(s,e,t,i){function r(m,f,p,c,g,x){function C(b,A){A.wrapS=THREE.RepeatWrapping,A.wrapT=THREE.RepeatWrapping,A.rotation=b.rotation,A.offset.x=b.offset.x,A.offset.y=b.offset.y,A.repeat.x=b.scale.x,A.repeat.y=b.scale.y}function M(b,A,k,R){if(k===null||!k.IsValid())return;let N=new THREE.TextureLoader;b.OnTextureNeeded(),N.load(k.url,V=>{C(k,V),A.needsUpdate=!0,R(V),b.OnTextureLoaded()},null,V=>{b.OnTextureLoaded()})}let I=f.GetMaterial(p),S=De(I.color);I.vertexColors&&S.setRGB(1,1,1);let w={color:S,vertexColors:I.vertexColors,opacity:I.opacity,transparent:I.transparent,alphaTest:I.alphaTest,side:THREE.DoubleSide};g.forceMediumpForMaterials&&(w.precision="mediump");let y=null;if(c===me.Phong){if(y=new THREE.MeshPhongMaterial(w),I.type===Y.Phong){let b=De(I.specular);J(I.shininess,0)&&b.setRGB(0,0,0),y.specular=b,y.shininess=I.shininess*100,M(m,y,I.specularMap,A=>{y.specularMap=A})}}else c===me.Physical&&(y=new THREE.MeshStandardMaterial(w),I.type===Y.Physical&&(y.metalness=I.metalness,y.roughness=I.roughness,M(m,y,I.metalnessMap,b=>{y.metalness=1,y.roughness=1,y.metalnessMap=b,y.roughnessMap=b})));let E=De(I.emissive);return y.emissive=E,M(m,y,I.diffuseMap,b=>{I.multiplyDiffuseMap||y.color.setRGB(1,1,1),y.map=b}),M(m,y,I.bumpMap,b=>{y.bumpMap=b}),M(m,y,I.normalMap,b=>{y.normalMap=b}),M(m,y,I.emissiveMap,b=>{y.emissiveMap=b}),I.isDefault&&(x.defaultMaterial=y),y}function n(m,f,p){let c=m.GetMesh(f.meshIndex),g=c.TriangleCount(),x=[];for(let V=0;V<g;V++)x.push(V);x.sort((V,ae)=>{let H=c.GetTriangle(V),Ie=c.GetTriangle(ae);return H.mat-Ie.mat});let C=new THREE.BufferGeometry,M=[],I=[],S=new Map,w=[],y=[],E=[],b=[],A=[];A.push({start:0,end:-1});let k=c.VertexColorCount()>0,R=c.TextureUVCount()>0;for(let V=0;V<x.length;V++){let ae=x[V],H=c.GetTriangle(ae),Ie=c.GetVertex(H.v0),ke=c.GetVertex(H.v1),fi=c.GetVertex(H.v2);if(w.push(Ie.x,Ie.y,Ie.z,ke.x,ke.y,ke.z,fi.x,fi.y,fi.z),H.HasVertexColors()){let j=De(c.GetVertexColor(H.c0)),Rt=De(c.GetVertexColor(H.c1)),Ft=De(c.GetVertexColor(H.c2));y.push(j.r,j.g,j.b,Rt.r,Rt.g,Rt.b,Ft.r,Ft.g,Ft.b)}else k&&y.push(0,0,0,0,0,0,0,0,0);let Pt=c.GetNormal(H.n0),_t=c.GetNormal(H.n1),ut=c.GetNormal(H.n2);if(E.push(Pt.x,Pt.y,Pt.z,_t.x,_t.y,_t.z,ut.x,ut.y,ut.z),H.HasTextureUVs()){let j=c.GetTextureUV(H.u0),Rt=c.GetTextureUV(H.u1),Ft=c.GetTextureUV(H.u2);b.push(j.x,j.y,Rt.x,Rt.y,Ft.x,Ft.y)}else R&&b.push(0,0,0,0,0,0);let ne=H.mat;S.has(ne)||(S.set(ne,M.length),M.push(p[ne]),I.push(ne),V>0&&(A[A.length-1].end=V-1,A.push({start:A[A.length-1].end+1,end:-1})))}A[A.length-1].end=g-1,C.setAttribute("position",new THREE.Float32BufferAttribute(w,3)),y.length!==0&&C.setAttribute("color",new THREE.Float32BufferAttribute(y,3)),C.setAttribute("normal",new THREE.Float32BufferAttribute(E,3)),b.length!==0&&C.setAttribute("uv",new THREE.Float32BufferAttribute(b,2));for(let V=0;V<A.length;V++){let ae=A[V];C.addGroup(ae.start*3,(ae.end-ae.start+1)*3,V)}let N=new THREE.Mesh(C,M);return N.userData={originalMeshId:f,originalMaterials:I,threeMaterials:null},N}function o(m,f,p,c){let g=f.GetMesh(p.meshIndex);if(Ht(g)===rt.TriangleMesh){let C=n(f,p,c);m.add(C)}}function l(m,f,p,c){let g=f.GetRootNode(),C=new Bs(g,m).GetMeshInstances();Zn(C.length,100,{runTask:(M,I,S)=>{for(let w=M;w<=I;w++){let y=C[w],E=y.node,b=y.threeNode,A=new st(E.GetId(),y.meshIndex);o(b,f,A,p)}S()},onReady:()=>{c.OnModelLoaded(m)}})}let a=new Ls(i),h=us(s),u=[];for(let m=0;m<s.MaterialCount();m++){let f=r(a,s,m,h,e,t);u.push(f)}let d=new THREE.Object3D;l(d,s,u,a)}var Wr=class{constructor(){this.importer=new Br,this.inProgress=!1,this.defaultMaterial=null,this.hasHighpDriverIssue=hs()}InProgress(){return this.inProgress}LoadModel(e,t,i,r){this.inProgress||(this.inProgress=!0,r.onLoadStart(),this.importer.ImportFiles(e,t,i,{onFilesLoaded:()=>{r.onImportStart()},onSelectMainFile:(n,o)=>{r.onSelectMainFile?r.onSelectMainFile(n,o):o(0)},onImportSuccess:n=>{r.onVisualizationStart();let o=new Hr;o.forceMediumpForMaterials=this.hasHighpDriverIssue;let l=new zr;Os(n.model,o,l,{onTextureLoaded:()=>{r.onTextureLoaded()},onModelLoaded:a=>{if(this.defaultMaterial=l.defaultMaterial,n.upVector===G.X){let h=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,0,1),Math.PI/2);a.quaternion.multiply(h)}else if(n.upVector===G.Z){let h=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);a.quaternion.multiply(h)}r.onModelFinished(n,a),this.inProgress=!1}})},onImportError:n=>{r.onLoadError(n),this.inProgress=!1}}))}GetImporter(){return this.importer}GetDefaultMaterial(){return this.defaultMaterial}ReplaceDefaultMaterialColor(e){this.defaultMaterial!==null&&!this.defaultMaterial.vertexColors&&(this.defaultMaterial.color=De(e))}};var ks=class{constructor(){this.modalDiv=Ce("ov_modal"),this.overlayDiv=null,this.resizeHandler=null,this.positionCalculator=null,this.closeHandler=null,this.isOpen=!1,this.closeable=!0}GetContentDiv(){return this.modalDiv}SetCloseable(e){this.closeable=e}SetPositionCalculator(e){this.positionCalculator=e}SetCloseHandler(e){this.closeHandler=e}Open(){this.overlayDiv=v(document.body,"ov_modal_overlay"),document.body.appendChild(this.modalDiv),this.resizeHandler=this.Resize.bind(this),window.addEventListener("resize",this.resizeHandler),this.closeable&&(this.overlayDiv.addEventListener("click",e=>{e.preventDefault(),this.Close()}),this.overlayDiv.addEventListener("contextmenu",e=>{e.preventDefault(),this.Close()})),this.isOpen=!0,this.Resize()}Close(){!this.isOpen||(window.removeEventListener("resize",this.resizeHandler),this.closeHandler!==null&&this.closeHandler(),this.modalDiv.remove(),this.overlayDiv.remove(),this.overlayDiv=null,this.resizeHandler=null,this.isOpen=!1)}IsOpen(){return this.isOpen}Resize(){let e=window.innerWidth,t=window.innerHeight,i=(e-this.modalDiv.offsetWidth)/2,r=(t-this.modalDiv.offsetHeight)/3;if(this.positionCalculator!==null){let n=this.positionCalculator();i=n.x,r=n.y}this.modalDiv.style.left=i+"px",this.modalDiv.style.top=r+"px"}},Ui=class{constructor(){this.modal=new ks}GetContentDiv(){return this.modal.GetContentDiv()}SetCloseable(e){this.modal.SetCloseable(e)}SetCloseHandler(e){this.modal.SetCloseHandler(e)}SetPositionCalculator(e){this.modal.SetPositionCalculator(e)}Show(){this.modal.Open()}Hide(){this.modal.Close()}},ni=class extends Ui{constructor(){super();this.modal.SetCloseable(!1),this.textDiv=null}Init(e){let t=this.modal.GetContentDiv();t.classList.add("ov_progress"),v(t,"ov_progress_img",'<svg><use href="assets/images/frisqoo_3d_logo.svg#logo"></use></svg>'),this.textDiv=v(t,"ov_progress_text"),this.SetText(e)}SetText(e){this.textDiv.innerHTML=e}},Be=class extends Ui{constructor(){super()}Init(e,t){function i(a,h){let u=v(h,"ov_button ov_dialog_button",a.name);a.subClass&&u.classList.add(a.subClass),u.addEventListener("click",()=>{a.onClick()})}let r=this.modal.GetContentDiv();r.classList.add("ov_dialog"),v(r,"ov_dialog_title",e);let n=v(r,"ov_dialog_content"),o=v(r,"ov_dialog_buttons"),l=v(o,"ov_dialog_buttons_inner");for(let a=0;a<t.length;a++)i(t[a],l);return n}},Hi=class extends Ui{constructor(){super()}Init(e){let t=this.modal.GetContentDiv();return t.classList.add("ov_popup"),this.modal.SetPositionCalculator(e),t}},jr=class extends Hi{constructor(){super();this.listDiv=null}Init(e){let t=super.Init(e);return this.listDiv=v(t,"ov_popup_list ov_thin_scrollbar"),t}AddListItem(e,t){let i=v(this.listDiv,"ov_popup_list_item");if(e.icon&&ie(i,e.icon,"left_inline"),e.color){let r=v(i,"ov_popup_list_item_icon"),n=yi(e.color);r.appendChild(n)}v(i,"ov_popup_list_item_name",e.name),i.addEventListener("click",t.onClick),lr()&&t.onHoverStart&&t.onHoverStop&&(i.addEventListener("mouseover",()=>{t.onHoverStart()}),i.addEventListener("mouseout",()=>{t.onHoverStop()}))}};function $e(s,e,t){let i=new Be,r=i.Init(s,[{name:"OK",onClick(){i.Hide()}}]);return v(r,"ov_dialog_message",e),t!==null&&v(r,"ov_dialog_submessage",t),i.Show(),i}function jt(s,e){if(s.length===0)return null;let t=new jr;t.Init(()=>e.calculatePosition(t.GetContentDiv()));for(let i=0;i<s.length;i++){let r=s[i];t.AddListItem(r,{onHoverStart:function(){e.onHoverStart&&e.onHoverStart(i)},onHoverStop:function(){e.onHoverStop&&e.onHoverStop(i)},onClick:function(){t.Hide(),e.onClick(i)}})}return t.Show(),t}function Us(s,e){let t=s.getBoundingClientRect();return{x:t.left-e.offsetWidth,y:t.top}}function zi(s,e){let t=s.getBoundingClientRect();return{x:t.left+s.offsetWidth,y:t.top+s.offsetHeight-e.offsetHeight}}function Hs(s,e){let t=window.innerWidth,i=window.innerHeight,r=s.x,n=s.y,o=r+e.offsetWidth,l=n+e.offsetHeight;return o>t&&(r=r-(o-t)),l>i&&(n=n-(l-i)),{x:r,y:n}}var si=class{constructor(){this.modelLoader=new Wr,this.modalDialog=null}LoadModel(e,t,i,r){if(this.modelLoader.InProgress())return;let n=null;this.modelLoader.LoadModel(e,t,i,{onLoadStart:()=>{this.CloseDialogIfOpen(),r.onStart(),n=new ni,n.Init("Loading Model"),n.Show()},onSelectMainFile:(o,l)=>{n.Hide(),this.modalDialog=this.ShowFileSelectorDialog(o,a=>{n.Show(),l(a)})},onImportStart:()=>{n.SetText("Importing Model")},onVisualizationStart:()=>{n.SetText("Visualizing Model")},onModelFinished:(o,l)=>{n.Hide(),r.onFinish(o,l)},onTextureLoaded:()=>{r.onRender()},onLoadError:o=>{n.Hide(),r.onError(o),this.modalDialog=this.ShowErrorDialog(o)}})}GetModelLoader(){return this.modelLoader}GetImporter(){return this.modelLoader.GetImporter()}ShowErrorDialog(e){return e.code===_e.NoImportableFile?$e("Something went wrong","No importable file found.",null):e.code===_e.FailedToLoadFile?$e("Something went wrong","Failed to load file for import.","The remote server refused to fulfill the request. Check if the url is correct, and make sure that CORS requests are allowed on the remote server."):e.code===_e.ImportFailed?$e("Something went wrong","Failed to import model.",e.message):$e("Something went wrong","Unknown error.",null)}ShowFileSelectorDialog(e,t){let i=new Be,r=i.Init("Select Model",[{name:"Cancel",subClass:"outline",onClick(){i.Hide()}}]);i.SetCloseHandler(()=>{t(null)}),v(r,"ov_dialog_message","Multiple importable models found. Select the model you would like to import from the list below.");let o=v(r,"ov_dialog_section"),l=v(o,"ov_dialog_import_file_list ov_thin_scrollbar");for(let a=0;a<e.length;a++){let h=e[a],u=v(l,"ov_dialog_file_link");ie(u,"meshes","ov_file_link_img"),v(u,"ov_dialog_file_link_text",h),u.addEventListener("click",()=>{i.SetCloseHandler(null),i.Hide(),t(a)})}return i.Show(),i}CloseDialogIfOpen(){this.modalDialog!==null&&(this.modalDialog.Hide(),this.modalDialog=null)}};var qr=class{constructor(e){this.parameters=e,this.viewer=new ii,this.hashHandler=new ri,this.modelLoaderUI=new si}Load(){let e=Q(this.parameters.viewerDiv,"canvas");if(this.viewer.Init(e),this.Resize(),this.hashHandler.HasHash()){let t=this.hashHandler.GetModelFilesFromHash();if(t===null)return;Di(t);let i="fishermans_bastion",r=!1,n=this.hashHandler.GetEnvironmentSettingsFromHash();n!==null&&(i=n.environmentMapName,r=n.backgroundIsEnvMap);let o="assets/envmaps/"+i+"/",l=[o+"posx.jpg",o+"negx.jpg",o+"posy.jpg",o+"negy.jpg",o+"posz.jpg",o+"negz.jpg"];this.viewer.SetEnvironmentMapSettings(l,r);let a=this.hashHandler.GetBackgroundFromHash();a!==null&&this.viewer.SetBackgroundColor(a);let h=this.hashHandler.GetEdgeSettingsFromHash();h!==null&&this.viewer.SetEdgeSettings(h.showEdges,h.edgeColor,h.edgeThreshold);let u=new Wt,d=this.hashHandler.GetDefaultColorFromHash();d!==null&&(u.defaultColor=d),this.modelLoaderUI.LoadModel(t,Z.Url,u,{onStart:()=>{},onFinish:(p,c)=>{this.OnModelFinished(c)},onRender:()=>{this.viewer.Render()},onError:p=>{}});let m=Ai(t),f=this.parameters.websiteLinkDiv.getAttribute("href")+"#"+m;this.parameters.websiteLinkDiv.setAttribute("href",f)}window.addEventListener("resize",()=>{this.Resize()})}Resize(){let e=window.innerWidth,t=window.innerHeight;this.viewer.Resize(e,t)}OnModelFinished(e){this.viewer.SetMainObject(e);let t=this.viewer.GetBoundingSphere(r=>!0);this.viewer.AdjustClippingPlanesToSphere(t);let i=this.hashHandler.GetCameraFromHash();i!==null?this.viewer.SetCamera(i):(this.viewer.SetUpVector(G.Y,!1),this.viewer.FitSphereToWindow(t,!1))}};var oi=class{constructor(e){this.parentDiv=e,this.panelDiv=v(e),O(this.panelDiv,!1),this.visible=!1}GetName(){return null}GetIcon(){return null}IsVisible(){return this.visible}Show(e){this.visible!==e&&(this.visible=e,O(this.panelDiv,this.visible))}Resize(){}Clear(){}},li=class{constructor(e){this.parentDiv=e,this.menuDiv=v(e,"ov_panel_set_menu"),this.contentDiv=v(e,"ov_panel_set_content ov_thin_scrollbar"),this.panels=[],this.panelButtons=[],this.panelsVisible=!0,this.panelsPrevWidth=null,this.callbacks=null}Init(e){this.callbacks=e}GetContentDiv(){return this.contentDiv}AddPanel(e){this.panels.push(e);let t=ie(this.menuDiv,e.GetIcon(),"ov_panel_set_menu_button");t.setAttribute("alt",e.GetName()),t.setAttribute("title",e.GetName()),this.panelButtons.push(t),t.addEventListener("click",()=>{e===this.GetVisiblePanel()?this.ShowPanels(!1):(this.ShowPanels(!0),this.ShowPanel(e))})}IsPanelsVisible(){return this.panelsVisible}ShowPanels(e){if(!!this.IsParentVisible()&&this.panelsVisible!==e){if(this.panelsVisible=e,this.panelsVisible)O(this.contentDiv,!0),Lt(this.parentDiv,this.menuDiv.offsetWidth+this.panelsPrevWidth);else{for(let t of this.panelButtons)t.classList.remove("selected");for(let t of this.panels)t.Show(!1);this.panelsPrevWidth=this.contentDiv.offsetWidth,Lt(this.parentDiv,this.menuDiv.offsetWidth),O(this.contentDiv,!1)}this.callbacks.onShowHidePanels(this.panelsVisible),this.callbacks.onResize()}}ShowPanel(e){if(e===this.GetVisiblePanel())return;let t=this.GetPanelButton(e);for(let i of this.panelButtons)i!==t&&i.classList.remove("selected");t.classList.add("selected");for(let i of this.panels)i!==e&&i.Show(!1);e.Show(!0),e.Resize()}GetVisiblePanel(){if(!this.panelsVisible)return null;for(let e of this.panels)if(e.IsVisible())return e;return null}SetPanelIcon(e,t){let i=this.GetPanelButton(e);Xe(i,t)}GetPanelButton(e){let t=this.panels.indexOf(e);return this.panelButtons[t]}Resize(){let e=this.parentDiv.offsetHeight;if(xe(this.menuDiv,e),xe(this.contentDiv,e),this.panelsVisible)for(let t of this.panels)t.IsVisible()&&t.Resize()}IsParentVisible(){return Gn(this.parentDiv)}Clear(){for(let e of this.panels)e.Clear()}};function zs(s){s.scrollIntoView({behavior:"smooth",block:"nearest"})}var at=class{constructor(e){this.imagePath=e,this.mainElement=Jt(this.imagePath,"ov_tree_item_button"),this.mainElement.setAttribute("src",this.imagePath)}SetImage(e){this.imagePath=e,Xe(this.mainElement,this.imagePath)}OnClick(e){this.mainElement.addEventListener("click",t=>{t.stopPropagation(),e(t)})}GetDomElement(){return this.mainElement}},Xr=class{constructor(e,t){if(this.name=e,this.parent=null,this.mainElement=Ce("ov_tree_item"),this.mainElement.setAttribute("title",this.name),this.nameElement=v(this.mainElement,"ov_tree_item_name",this.name),zt(t)){let i=Jt(t,"ov_tree_item_icon");ct(i,this.nameElement)}}OnClick(e){this.mainElement.classList.add("clickable"),this.mainElement.style.cursor="pointer",this.mainElement.addEventListener("click",e)}SetParent(e){this.parent=e}AddDomElements(e){e.appendChild(this.mainElement)}},yt=class extends Xr{constructor(e,t){super(e,t);this.selected=!1}SetSelected(e){if(this.selected=e,this.selected){this.mainElement.classList.add("selected");let t=this.parent;if(t===null)zs(this.mainElement);else for(;t!==null;)t.ShowChildren(!0),zs(this.mainElement),t=t.parent}else this.mainElement.classList.remove("selected")}},ai=class extends yt{constructor(e,t){super(e,t);this.buttonsDiv=Ce("ov_tree_item_button_container"),ct(this.buttonsDiv,this.nameElement)}AppendButton(e){this.buttonsDiv.appendChild(e.GetDomElement())}},St=class extends Xr{constructor(e,t){super(e,t);this.children=[],this.isVisible=!0,this.isChildrenVisible=!1,this.childrenDiv=null,this.openButtonIcon="arrow_down",this.closeButtonIcon="arrow_right",this.openCloseButton=Jt(this.openButtonIcon,"ov_tree_item_icon"),ct(this.openCloseButton,this.nameElement)}AddChild(e){this.CreateChildrenDiv(),this.children.push(e),e.SetParent(this),e.AddDomElements(this.childrenDiv)}ExpandAll(e){for(let t of this.children)t instanceof St&&(t.ShowChildren(e),t.ExpandAll(e))}Show(e){this.isVisible=e,this.childrenDiv!==null&&(this.isVisible?(O(this.mainElement,!0),this.childrenDiv.classList.add("ov_tree_view_children")):(O(this.mainElement,!1),this.childrenDiv.classList.remove("ov_tree_view_children")))}ShowChildren(e){this.isChildrenVisible=e,this.childrenDiv!==null&&(e?(Xe(this.openCloseButton,this.openButtonIcon),O(this.childrenDiv,!0)):(Xe(this.openCloseButton,this.closeButtonIcon),O(this.childrenDiv,!1)))}CreateChildrenDiv(){return this.childrenDiv===null&&(this.childrenDiv=Ce("ov_tree_view_children"),Dn(this.childrenDiv,this.mainElement),this.Show(this.isVisible),this.ShowChildren(this.isChildrenVisible),this.OnClick(e=>{this.isChildrenVisible=!this.isChildrenVisible,this.ShowChildren(this.isChildrenVisible)})),this.childrenDiv}},Yr=class extends St{constructor(e,t){super(e,t);this.buttonsDiv=Ce("ov_tree_item_button_container"),ct(this.buttonsDiv,this.nameElement)}AppendButton(e){this.buttonsDiv.appendChild(e.GetDomElement())}},Kr=class{constructor(e){this.mainDiv=v(e,"ov_tree_view"),this.children=[]}AddClass(e){this.mainDiv.classList.add(e)}AddChild(e){e.AddDomElements(this.mainDiv),this.children.push(e)}Clear(){Te(this.mainDiv),this.children=[]}};var hi=class{constructor(e){this.parentDiv=e,this.callbacks=null,this.popup=null,this.button=v(this.parentDiv,"ov_panel_button"),this.buttonText=v(this.button,"ov_panel_button_text"),ie(this.button,"arrow_right","ov_panel_button_icon"),this.button.addEventListener("click",()=>{this.OnButtonClick()})}Init(e){this.callbacks=e}OnButtonClick(){}Clear(){this.popup!==null&&(this.popup.Hide(),this.popup=null)}},bt=class extends oi{constructor(e){super(e);this.callbacks=null,this.titleDiv=v(this.panelDiv,"ov_navigator_tree_title"),this.treeDiv=v(this.panelDiv,"ov_navigator_tree_panel ov_thin_scrollbar"),this.treeView=new Kr(this.treeDiv);let t=this.GetName();this.titleDiv.innerHTML=t,this.titleDiv.setAttribute("title",t)}Clear(){this.treeView.Clear()}GetName(){return null}Init(e){this.callbacks=e}Fill(e){}};var Jr=class extends bt{constructor(e){super(e)}GetName(){return"Files"}GetIcon(){return"files"}Resize(){let e=et(this.titleDiv),t=this.parentDiv.offsetHeight;xe(this.treeDiv,t-e)}Clear(){super.Clear()}Fill(e){super.Fill(e);let t=e.usedFiles,i=e.missingFiles;if(i.length>0){let r=new St("Missing Files",null);r.ShowChildren(!0),this.treeView.AddChild(r);for(let o=0;o<i.length;o++){let l=i[o],a=new ai(l),h=new at("open");h.OnClick(()=>{this.callbacks.onFileBrowseButtonClicked()}),a.AppendButton(h),r.AddChild(a)}let n=new St("Available Files",null);n.ShowChildren(!0),this.treeView.AddChild(n);for(let o=0;o<t.length;o++){let l=t[o],a=new yt(l);n.AddChild(a)}}else for(let r=0;r<t.length;r++){let n=t[r],o=new yt(n);this.treeView.AddChild(o)}}};var ve={No:0,Parents:1,Children:2,All:3},Zr=class extends yt{constructor(e,t,i){super(e);this.OnClick(()=>{i.onSelected(t)})}},qt=class extends ai{constructor(e,t,i,r){super(e,t);this.meshInstanceId=i,this.visible=!0,this.fitToWindowButton=new at("fit"),this.fitToWindowButton.OnClick(()=>{r.onFitToWindow(this.meshInstanceId)}),this.AppendButton(this.fitToWindowButton),this.showHideButton=new at("visible"),this.showHideButton.OnClick(()=>{r.onShowHide(this.meshInstanceId)}),this.AppendButton(this.showHideButton),this.OnClick(()=>{r.onSelected(this.meshInstanceId)})}GetMeshInstanceId(){return this.meshInstanceId}IsVisible(){return this.visible}SetVisible(e,t){if(this.visible!==e&&(this.visible=e,this.visible?this.showHideButton.SetImage("visible"):this.showHideButton.SetImage("hidden"),t===ve.Parents&&this.parent instanceof We)){let i=this.parent.CalculateIsVisible();this.parent.SetVisible(i,ve.Parents)}}},We=class extends Yr{constructor(e,t,i){super(e,null);this.nodeId=t,this.callbacks=i,this.visible=!0,this.fitToWindowButton=new at("fit"),this.fitToWindowButton.OnClick(()=>{this.callbacks.onFitToWindow(t)}),this.AppendButton(this.fitToWindowButton),this.showHideButton=new at("visible"),this.showHideButton.OnClick(()=>{this.callbacks.onShowHide(t)}),this.AppendButton(this.showHideButton)}GetNodeId(){return this.nodeId}IsVisible(){return this.visible}CalculateIsVisible(){let e=!1;for(let t of this.children)if((t instanceof We||t instanceof qt)&&t.IsVisible()){e=!0;break}return e}SetVisible(e,t){if(this.visible!==e){if(this.visible=e,this.visible?this.showHideButton.SetImage("visible"):this.showHideButton.SetImage("hidden"),zt(this.callbacks.onVisibilityChanged)&&this.callbacks.onVisibilityChanged(this.visible),t===ve.Children||t===ve.All)for(let i of this.children)(i instanceof We||i instanceof qt)&&i.SetVisible(this.visible,ve.Children);if((t===ve.Parents||t===ve.All)&&this.parent instanceof We){let i=this.parent.CalculateIsVisible();this.parent.SetVisible(i,ve.Parents)}}}EnumerateMeshItems(e){for(let t of this.children)t instanceof We?t.EnumerateMeshItems(e):t instanceof qt&&e(t)}};var Ws=class extends hi{constructor(e){super(e);this.meshInfoArray=null}Update(e){if(this.meshInfoArray=e,this.meshInfoArray===null)return;let t="Meshes ("+this.meshInfoArray.length+")";this.buttonText.innerHTML=t}OnButtonClick(){if(this.meshInfoArray===null)return;let e=[];for(let t=0;t<this.meshInfoArray.length;t++){let i=this.meshInfoArray[t];e.push({name:Ii(i.name)})}e.length!==0&&(this.popup=jt(e,{calculatePosition:t=>zi(this.button,t),onHoverStart:t=>{let i=this.meshInfoArray[t];this.callbacks.onMeshHover(i.meshId)},onHoverStop:t=>{this.callbacks.onMeshHover(null)},onClick:t=>{let i=this.meshInfoArray[t];this.callbacks.onMeshSelected(i.meshId)}}))}},Qr=class extends bt{constructor(e){super(e);this.callbacks=null,this.materialIndexToItem=new Map,this.popupDiv=v(this.panelDiv,"ov_navigator_info_panel"),this.meshesButton=new Ws(this.popupDiv)}GetName(){return"Materials"}GetIcon(){return"materials"}Resize(){let e=et(this.titleDiv),t=et(this.popupDiv),i=this.parentDiv.offsetHeight;xe(this.treeDiv,i-e-t)}Clear(){super.Clear(),this.meshesButton.Clear(),this.materialIndexToItem=new Map}Init(e){super.Init(e),this.meshesButton.Init({onMeshHover:t=>{this.callbacks.onMeshTemporarySelected(t)},onMeshSelected:t=>{this.callbacks.onMeshSelected(t)}})}Fill(e){super.Fill(e);let t=e.model;for(let i=0;i<t.MaterialCount();i++){let r=t.GetMaterial(i),n=Ti(r.name),o=new Zr(n,i,{onSelected:l=>{this.callbacks.onMaterialSelected(l)}});this.materialIndexToItem.set(i,o),this.treeView.AddChild(o)}}GetMaterialItem(e){return this.materialIndexToItem.get(e)}SelectMaterialItem(e,t){this.GetMaterialItem(e).SetSelected(t)}UpdateMeshList(e){this.meshesButton.Update(e)}};var js=class extends hi{constructor(e){super(e);this.materialInfoArray=null}Update(e){if(this.materialInfoArray=e,this.materialInfoArray===null)return;let t="Materials ("+this.materialInfoArray.length+")";this.buttonText.innerHTML=t}OnButtonClick(){if(this.materialInfoArray===null)return;let e=[];for(let t=0;t<this.materialInfoArray.length;t++){let i=this.materialInfoArray[t];e.push({name:Ti(i.name),color:i.color})}e.length!==0&&(this.popup=jt(e,{calculatePosition:t=>zi(this.button,t),onClick:t=>{let i=this.materialInfoArray[t];this.callbacks.onMaterialSelected(i.index)}}))}},$r=class extends bt{constructor(e){super(e);this.callbacks=null,this.nodeIdToItem=new Map,this.meshInstanceIdToItem=new Map,this.rootItem=null,this.showTree=!1,this.buttons=null,this.titleDiv.classList.add("nomargin"),this.treeView.AddClass("tight"),this.buttonsDiv=Ce("ov_navigator_buttons"),ct(this.buttonsDiv,this.treeDiv),this.popupDiv=v(this.panelDiv,"ov_navigator_info_panel"),this.materialsButton=new js(this.popupDiv)}GetName(){return"Meshes"}GetIcon(){return"meshes"}Resize(){let e=this.titleDiv.offsetHeight,t=et(this.buttonsDiv),i=et(this.popupDiv),r=this.parentDiv.offsetHeight;xe(this.treeDiv,r-e-t-i)}Clear(){this.ClearMeshTree(),Te(this.buttonsDiv),this.buttons=null}ClearMeshTree(){super.Clear(),this.materialsButton.Clear(),this.nodeIdToItem=new Map,this.meshInstanceIdToItem=new Map,this.rootItem=null}Init(e){super.Init(e),this.materialsButton.Init({onMeshHover:t=>{this.callbacks.onMeshTemporarySelected(t)},onMeshSelected:t=>{this.callbacks.onMeshSelected(t)},onMaterialSelected:t=>{this.callbacks.onMaterialSelected(t)}})}Fill(e){super.Fill(e);let t=e.model;this.FillButtons(e),this.FillMeshTree(t),this.Resize()}FillButtons(e){function t(l,a,h,u){a.div=v(l,"ov_navigator_button"),a.div.setAttribute("alt",a.name),a.div.setAttribute("title",a.name),h&&a.div.classList.add(h),a.iconDiv=ie(a.div,a.icon),a.div.addEventListener("click",()=>{u()})}function i(l,a,h){a?(l.flatList.iconDiv.classList.remove("selected"),l.treeView.iconDiv.classList.add("selected")):(l.flatList.iconDiv.classList.add("selected"),l.treeView.iconDiv.classList.remove("selected"));let u=a&&h;O(l.separator,u),O(l.expandAll.div,u),O(l.collapseAll.div,u)}function r(l,a,h){let u=[];l.EnumerateMeshItems(d=>(d.IsVisible()||u.push(d.GetMeshInstanceId()),!0)),l.ClearMeshTree(),l.FillMeshTree(a.model);for(let d of u)l.GetMeshItem(d).SetVisible(!1,ve.Parents);i(l.buttons,l.showTree,h),l.callbacks.onViewTypeChanged()}this.buttons={flatList:{name:"Flat list",icon:"flat_list",div:null,iconDiv:null},treeView:{name:"Tree view",icon:"tree_view",div:null,iconDiv:null},separator:null,expandAll:{name:"Expand all",icon:"expand",div:null,iconDiv:null},collapseAll:{name:"Collapse all",icon:"collapse",div:null,iconDiv:null},showHideMeshes:{name:"Show/hide meshes",icon:"visible",div:null,iconDiv:null},fitToWindow:{name:"Fit meshes to window",icon:"fit",div:null,iconDiv:null}};let n=e.model.GetRootNode(),o=!1;for(let l of n.GetChildNodes())if(l.GetType()===fe.GroupNode){o=!0;break}t(this.buttonsDiv,this.buttons.flatList,null,()=>{!this.showTree||(this.showTree=!1,r(this,e,o))}),t(this.buttonsDiv,this.buttons.treeView,null,()=>{this.showTree||(this.showTree=!0,r(this,e,o))}),this.buttons.separator=v(this.buttonsDiv,"ov_navigator_buttons_separator"),t(this.buttonsDiv,this.buttons.expandAll,null,()=>{this.rootItem.ExpandAll(!0)}),t(this.buttonsDiv,this.buttons.collapseAll,null,()=>{this.rootItem.ExpandAll(!1)}),t(this.buttonsDiv,this.buttons.showHideMeshes,"right",()=>{let l=this.rootItem.GetNodeId();this.callbacks.onNodeShowHide(l)}),t(this.buttonsDiv,this.buttons.fitToWindow,"right",()=>{let l=this.rootItem.GetNodeId();this.callbacks.onNodeFitToWindow(l)}),i(this.buttons,this.showTree,o)}FillMeshTree(e){function t(l,a,h,u,d,m){let f=a.GetMesh(u),p=Ii(f.GetName()),c=new st(h.GetId(),u),g=m?"tree_mesh":null,x=new qt(p,g,c,{onShowHide:C=>{l.callbacks.onMeshShowHide(C)},onFitToWindow:C=>{l.callbacks.onMeshFitToWindow(C)},onSelected:C=>{l.callbacks.onMeshSelected(C)}});l.meshInstanceIdToItem.set(c.GetKey(),x),d.AddChild(x)}function i(l,a){let h=Vn(a.GetName()),u=a.GetId(),d=new We(h,u,{onShowHide:m=>{l.callbacks.onNodeShowHide(m)},onFitToWindow:m=>{l.callbacks.onNodeFitToWindow(m)}});return l.nodeIdToItem.set(u,d),d}function r(l,a){let h=a.GetId(),u=new We(null,h,{onVisibilityChanged:d=>{d?Xe(l.buttons.showHideMeshes.iconDiv,"visible"):Xe(l.buttons.showHideMeshes.iconDiv,"hidden")}});return u.Show(!1),u.ShowChildren(!0),l.treeView.AddChild(u),l.nodeIdToItem.set(h,u),u}function n(l,a,h,u,d){let m=[];for(let f of h.GetChildNodes())if(d)if(f.GetType()===fe.GroupNode){let p=i(l,f);u.AddChild(p),n(l,a,f,p,d)}else f.GetType()===fe.MeshNode&&m.push(f);else n(l,a,f,u,d);for(let f of m)n(l,a,f,u,d);for(let f of h.GetMeshIndices())t(l,a,h,f,u,d)}let o=e.GetRootNode();this.rootItem=r(this,o),n(this,e,o,this.rootItem,this.showTree)}UpdateMaterialList(e){this.materialsButton.Update(e)}GetNodeItem(e){return this.nodeIdToItem.get(e)}MeshItemCount(){return this.meshInstanceIdToItem.size}GetMeshItem(e){return this.meshInstanceIdToItem.get(e.GetKey())}EnumerateNodeItems(e){for(let t of this.nodeIdToItem.values())if(!e(t))break}EnumerateMeshItems(e){for(let t of this.meshInstanceIdToItem.values())if(!e(t))break}IsMeshVisible(e){return this.GetMeshItem(e).IsVisible()}HasHiddenMesh(){let e=!1;return this.EnumerateMeshItems(t=>t.IsVisible()?!0:(e=!0,!1)),e}ShowAllMeshes(e){this.EnumerateNodeItems(t=>(t.SetVisible(e,ve.No),!0)),this.EnumerateMeshItems(t=>(t.SetVisible(e,ve.No),!0))}ToggleNodeVisibility(e){let t=this.GetNodeItem(e);t.SetVisible(!t.IsVisible(),ve.All)}ToggleMeshVisibility(e){let t=this.GetMeshItem(e);t.SetVisible(!t.IsVisible(),ve.Parents)}IsMeshIsolated(e){let t=!0;return this.EnumerateMeshItems(i=>!i.GetMeshInstanceId().IsEqual(e)&&i.IsVisible()?(t=!1,!1):!0),t}IsolateMesh(e){this.ShowAllMeshes(!1),this.ToggleMeshVisibility(e)}};var le={Material:1,Mesh:2},wt=class{constructor(e,t){this.type=e,this.materialIndex=null,this.meshInstanceId=null,this.type===le.Material?this.materialIndex=t:this.type===le.Mesh&&(this.meshInstanceId=t)}IsEqual(e){if(this.type!==e.type)return!1;if(this.type===le.Material)return this.materialIndex===e.materialIndex;if(this.type===le.Mesh)return this.meshInstanceId.IsEqual(e.meshInstanceId)}},en=class{constructor(e,t){this.mainDiv=e,this.splitterDiv=t,this.panelSet=new li(e),this.callbacks=null,this.selection=null,this.tempSelectedMeshId=null,this.filesPanel=new Jr(this.panelSet.GetContentDiv()),this.materialsPanel=new Qr(this.panelSet.GetContentDiv()),this.meshesPanel=new $r(this.panelSet.GetContentDiv()),this.panelSet.AddPanel(this.filesPanel),this.panelSet.AddPanel(this.materialsPanel),this.panelSet.AddPanel(this.meshesPanel),this.panelSet.ShowPanel(this.meshesPanel)}ShowPanels(e){this.panelSet.ShowPanels(e)}Init(e){this.callbacks=e,this.panelSet.Init({onResize:()=>{O(this.splitterDiv,this.panelSet.IsPanelsVisible()),this.callbacks.onResize()},onShowHidePanels:t=>{this.callbacks.onShowHidePanels(t)}}),this.filesPanel.Init({onFileBrowseButtonClicked:()=>{this.callbacks.openFileBrowserDialog()}}),this.materialsPanel.Init({onMaterialSelected:t=>{this.SetSelection(new wt(le.Material,t))},onMeshTemporarySelected:t=>{this.tempSelectedMeshId=t,this.callbacks.updateMeshesSelection()},onMeshSelected:t=>{this.SetSelection(new wt(le.Mesh,t))}}),this.meshesPanel.Init({onMeshSelected:t=>{this.SetSelection(new wt(le.Mesh,t))},onMeshShowHide:t=>{this.ToggleMeshVisibility(t)},onMeshFitToWindow:t=>{this.FitMeshToWindow(t)},onNodeShowHide:t=>{this.ToggleNodeVisibility(t)},onNodeFitToWindow:t=>{this.FitNodeToWindow(t)},onMaterialSelected:t=>{this.SetSelection(new wt(le.Material,t))},onViewTypeChanged:()=>{this.SetSelection(null)}}),Si(this.splitterDiv,this.mainDiv,!1,()=>{this.callbacks.onResize()})}GetWidth(){let e=Bt(this.mainDiv),t=0;return this.panelSet.IsPanelsVisible()&&(t=this.splitterDiv.offsetWidth),e+t}Resize(e){tt(this.mainDiv,e),xe(this.splitterDiv,e),this.panelSet.Resize()}FillTree(e){this.filesPanel.Fill(e),e.missingFiles.length===0?this.panelSet.SetPanelIcon(this.filesPanel,"files"):this.panelSet.SetPanelIcon(this.filesPanel,"missing_files"),this.materialsPanel.Fill(e),this.meshesPanel.Fill(e),this.OnSelectionChanged()}MeshItemCount(){return this.meshesPanel.MeshItemCount()}IsMeshVisible(e){return this.meshesPanel.IsMeshVisible(e)}HasHiddenMesh(){return this.meshesPanel.HasHiddenMesh()}ShowAllMeshes(e){this.meshesPanel.ShowAllMeshes(e),this.callbacks.updateMeshesVisibility()}ToggleNodeVisibility(e){this.meshesPanel.ToggleNodeVisibility(e),this.callbacks.updateMeshesVisibility()}ToggleMeshVisibility(e){this.meshesPanel.ToggleMeshVisibility(e),this.callbacks.updateMeshesVisibility()}IsMeshIsolated(e){return this.meshesPanel.IsMeshIsolated(e)}IsolateMesh(e){this.meshesPanel.IsolateMesh(e),this.callbacks.updateMeshesVisibility()}GetSelectedMeshId(){return this.tempSelectedMeshId!==null?this.tempSelectedMeshId:this.selection===null||this.selection.type!==le.Mesh?null:this.selection.meshInstanceId}SetSelection(e){function t(n,o,l){o.type===le.Material?(l&&n.panelSet.IsPanelsVisible()&&n.panelSet.ShowPanel(n.materialsPanel),n.materialsPanel.SelectMaterialItem(o.materialIndex,l)):o.type===le.Mesh&&(l&&n.panelSet.IsPanelsVisible()&&n.panelSet.ShowPanel(n.meshesPanel),n.meshesPanel.GetMeshItem(o.meshInstanceId).SetSelected(l))}function i(n,o){n.selection=o,n.OnSelectionChanged()}let r=this.selection;r!==null&&t(this,r,!1),i(this,e),this.tempSelectedMeshId=null,this.selection!==null&&(r!==null&&r.IsEqual(this.selection)?(t(this,this.selection,!1),i(this,null)):t(this,this.selection,!0)),this.callbacks.updateMeshesSelection()}OnSelectionChanged(){this.selection===null?this.callbacks.onModelSelected():this.selection.type===le.Material?this.callbacks.onMaterialSelected(this.selection.materialIndex):this.selection.type===le.Mesh&&this.callbacks.onMeshSelected(this.selection.meshInstanceId),this.UpdatePanels()}UpdatePanels(){let e=null,t=null;this.selection!==null&&(this.selection.type===le.Material?e=this.selection.materialIndex:this.selection.type===le.Mesh&&(t=this.selection.meshInstanceId));let i=this.callbacks.getMeshesForMaterial(e);this.materialsPanel.UpdateMeshList(i);let r=this.callbacks.getMaterialsForMesh(t);this.meshesPanel.UpdateMaterialList(r)}FitNodeToWindow(e){let t=new Set;this.meshesPanel.GetNodeItem(e).EnumerateMeshItems(r=>{t.add(r.GetMeshInstanceId())}),this.callbacks.fitMeshesToWindow(t)}FitMeshToWindow(e){this.callbacks.fitMeshToWindow(e)}Clear(){this.panelSet.Clear(),this.selection=null}};function Et(s,e){let t=new Date,i=365;t.setTime(t.getTime()+i*24*60*60*1e3),document.cookie=s+"="+e+"; expires="+t.toUTCString()+";"}function At(s,e){let i=decodeURIComponent(document.cookie).split(";");for(let r=0;r<i.length;r++){let n=i[r].trim();if(n.startsWith(s+"="))return n.substring(s.length+1)}return e}function Dt(s,e){let t=At(s,null);return t===null?e:t==="true"}function Gt(s,e){Et(s,e?"true":"false")}function tn(s,e){let t=At(s,null);return t===null?e:parseInt(t,10)}function rn(s,e){Et(s,e.toString())}function Wi(s,e){let t=At(s,null);return t===null?e:de.StringToColor(t)}function ji(s,e){Et(s,de.ColorToString(e))}var pe={Light:1,Dark:2},ui=class{constructor(){this.environmentMapName="fishermans_bastion",this.backgroundIsEnvMap=!1,this.backgroundColor=new D(255,255,255),this.defaultColor=new D(200,200,200),this.showEdges=!1,this.edgeColor=new D(0,0,0),this.edgeThreshold=1,this.themeId=pe.Light}LoadFromCookies(){this.environmentMapName=At("ov_environment_map","fishermans_bastion"),this.backgroundIsEnvMap=Dt("ov_background_is_envmap",!1),this.backgroundColor=Wi("ov_background_color",new D(255,255,255)),this.defaultColor=Wi("ov_default_color",new D(200,200,200)),this.showEdges=Dt("ov_show_edges",!1),this.edgeColor=Wi("ov_edge_color",new D(0,0,0)),this.edgeThreshold=tn("ov_edge_threshold",1),this.themeId=tn("ov_theme_id",pe.Light)}SaveToCookies(){Et("ov_environment_map",this.environmentMapName),Gt("ov_background_is_envmap",this.backgroundIsEnvMap),ji("ov_background_color",this.backgroundColor),ji("ov_default_color",this.defaultColor),Gt("ov_show_edges",this.showEdges),ji("ov_edge_color",this.edgeColor),rn("ov_edge_threshold",this.edgeThreshold),rn("ov_theme_id",this.themeId)}};function xo(s,e,t){let i=Ne(s,e),r=Ne(e,t),n=Ne(s,t),o=(i+r+n)/2,l=o*(o-i)*(o-r)*(o-n);return l<0?0:Math.sqrt(l)}function Co(s,e,t){return ur(s,Ye(e,t))/6}function qs(s){let e=0;return s.EnumerateTriangleVertices((t,i,r)=>{e+=Co(t,i,r)}),e}function Xs(s){let e=0;return s.EnumerateTriangleVertices((t,i,r)=>{e+=xo(t,i,r)}),e}var di=class extends oi{constructor(e){super(e);this.callbacks=null,this.titleDiv=null,this.HasTitle()&&(this.titleDiv=v(this.panelDiv,"ov_sidebar_title"),v(this.titleDiv,"ov_sidebar_title_text",this.GetName()),this.titleDiv.setAttribute("title",this.GetName())),this.contentDiv=v(this.panelDiv,"ov_sidebar_content ov_thin_scrollbar")}GetName(){return null}HasTitle(){return!0}Clear(){Te(this.contentDiv)}Init(e){this.callbacks=e}};var nn=class extends di{constructor(e){super(e)}GetName(){return"Details"}GetIcon(){return"details"}AddObject3DProperties(e){this.Clear();let t=v(this.contentDiv,"ov_property_table"),i=gr(e),r=oe(i.max,i.min);if(this.AddProperty(t,new L(_.Integer,"Vertices",e.VertexCount())),this.AddProperty(t,new L(_.Integer,"Triangles",e.TriangleCount())),this.AddProperty(t,new L(_.Number,"Size X",r.x)),this.AddProperty(t,new L(_.Number,"Size Y",r.y)),this.AddProperty(t,new L(_.Number,"Size Z",r.z)),this.AddCalculatedProperty(t,"Volume",()=>{if(!os(e))return null;let n=qs(e);return new L(_.Number,null,n)}),this.AddCalculatedProperty(t,"Surface",()=>{let n=Xs(e);return new L(_.Number,null,n)}),e.PropertyGroupCount()>0){let n=v(this.contentDiv,"ov_property_table ov_property_table_custom");for(let o=0;o<e.PropertyGroupCount();o++){let l=e.GetPropertyGroup(o);this.AddPropertyGroup(n,l);for(let a=0;a<l.PropertyCount();a++){let h=l.GetProperty(a);this.AddPropertyInGroup(n,h)}}}this.Resize()}AddMaterialProperties(e){function t(n,o,l,a){if(a===null||a.name===null)return;let h=re(a.name);n.AddProperty(o,new L(_.Text,l,h))}this.Clear();let i=v(this.contentDiv,"ov_property_table"),r=null;e.type===Y.Phong?r="Phong":e.type===Y.Physical&&(r="Physical"),this.AddProperty(i,new L(_.Text,"Source",e.isDefault?"Default":"Model")),this.AddProperty(i,new L(_.Text,"Type",r)),e.vertexColors?this.AddProperty(i,new L(_.Text,"Color","Vertex colors")):(this.AddProperty(i,new L(_.Color,"Color",e.color)),e.type===Y.Phong&&(this.AddProperty(i,new L(_.Color,"Ambient",e.ambient)),this.AddProperty(i,new L(_.Color,"Specular",e.specular)))),e.type===Y.Physical&&(this.AddProperty(i,new L(_.Percent,"Metalness",e.metalness)),this.AddProperty(i,new L(_.Percent,"Roughness",e.roughness))),this.AddProperty(i,new L(_.Percent,"Opacity",e.opacity)),t(this,i,"Diffuse Map",e.diffuseMap),t(this,i,"Bump Map",e.bumpMap),t(this,i,"Normal Map",e.normalMap),t(this,i,"Emissive Map",e.emissiveMap),e.type===Y.Phong?t(this,i,"Specular Map",e.specularMap):e.type===Y.Physical&&t(this,i,"Metallic Map",e.metalnessMap),this.Resize()}AddPropertyGroup(e,t){v(e,"ov_property_table_row group",t.name).setAttribute("title",t.name)}AddProperty(e,t){let i=v(e,"ov_property_table_row"),r=v(i,"ov_property_table_cell ov_property_table_name",t.name+":"),n=v(i,"ov_property_table_cell ov_property_table_value");return r.setAttribute("title",t.name),this.DisplayPropertyValue(t,n),i}AddPropertyInGroup(e,t){this.AddProperty(e,t).classList.add("ingroup")}AddCalculatedProperty(e,t,i){let r=v(e,"ov_property_table_row"),n=v(r,"ov_property_table_cell ov_property_table_name",t+":"),o=v(r,"ov_property_table_cell ov_property_table_value");n.setAttribute("title",t),v(o,"ov_property_table_button","Calculate...").addEventListener("click",()=>{Te(o),o.innerHTML="Please wait...",Ct(()=>{let a=i();a===null?o.innerHTML="-":this.DisplayPropertyValue(a,o)})})}DisplayPropertyValue(e,t){Te(t);let i=null;if(e.type===_.Text)i=e.value;else if(e.type===_.Integer)i=e.value.toLocaleString();else if(e.type===_.Number)i=e.value.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});else if(e.type===_.Boolean)i=e.value?"True":"False";else if(e.type===_.Percent)i=parseInt(e.value*100,10).toString()+"%";else if(e.type===_.Color){let r="#"+ue(e.value),n=yi(e.value);t.appendChild(n),Q(t,"span",null,r)}i!==null&&(t.innerHTML=i,t.setAttribute("title",i))}};var Ys={EnvironmentMap:!1};function sn(s,e,t,i){let r=Pickr.create({el:s,theme:"monolith",position:"left-start",swatches:t,comparison:!1,default:"#"+ue(e),components:{preview:!1,opacity:!1,hue:!0,interaction:{hex:!1,rgba:!1,hsla:!1,hsva:!1,cmyk:!1,input:!0,clear:!1,save:!1}}});return r.on("change",(n,o,l)=>{let a=n.toRGBA(),h=new D(parseInt(a[0],10),parseInt(a[1],10),parseInt(a[2],10));i(h)}),r}var Ks=class extends Hi{constructor(){super()}ShowPopup(e,t,i){let r=super.Init(()=>Us(e,r)),n=[{element:null,name:"fishermans_bastion"},{element:null,name:"citadella"},{element:null,name:"maskonaive"},{element:null,name:"teide"},{element:null,name:"ice_river"},{element:null,name:"park"}];for(let l of n)l.element=Q(r,"img","ov_environment_map_preview"),l.element.setAttribute("src","assets/envmaps/"+l.name+".jpg"),l.name===t.environmentMapName&&l.element.classList.add("selected"),l.element.addEventListener("click",()=>{for(let a of n)a.element.classList.remove("selected");l.element.classList.add("selected"),t.environmentMapName=l.name,i.onEnvironmentMapChange()});let o=Ci(r,"use_as_background","Use as background",t.backgroundIsEnvMap,()=>{t.backgroundIsEnvMap=o.checked,i.onEnvironmentMapChange()});r.classList.add("sidebar"),this.Show()}},qi=class{constructor(e,t){this.parentDiv=e,this.contentDiv=v(this.parentDiv,"ov_sidebar_settings_section"),v(this.contentDiv,"ov_sidebar_title",t)}Init(e,t){}Update(e){}Clear(){}},Js=class extends qi{constructor(e){super(e,"Model Display");this.environmentMapButton=null,this.environmentMapPopup=null,this.backgroundColorPicker=null,this.edgeDisplayToggle=null,this.edgeColorPicker=null,this.thresholdSlider=null,this.thresholdSliderValue=null,this.edgeSettingsDiv=null}Init(e,t){Ys.EnvironmentMap&&(this.environmentMapButton=v(this.contentDiv,"ov_panel_button"),ie(this.environmentMapButton,"arrow_left","ov_panel_button_left_icon"),v(this.environmentMapButton,"ov_panel_button_text","Environment Map"),this.environmentMapButton.addEventListener("click",()=>{this.environmentMapPopup=new Ks,this.environmentMapPopup.ShowPopup(this.environmentMapButton,e,{onEnvironmentMapChange:()=>{t.onEnvironmentMapChange()}})}));let i=v(this.contentDiv,"ov_sidebar_parameter"),r=v(i,"ov_color_picker");v(i,null,"Background Color");let n=["#ffffff","#e3e3e3","#c9c9c9","#898989","#5f5f5f","#494949","#383838","#0f0f0f"];this.backgroundColorPicker=sn(r,e.backgroundColor,n,d=>{e.backgroundColor=d,t.onBackgroundColorChange()});let o=v(this.contentDiv,"ov_sidebar_parameter");this.edgeDisplayToggle=nr(o,"ov_sidebar_parameter_toggle"),v(o,"ov_sidebar_parameter_text","Show Edges"),this.edgeSettingsDiv=v(this.contentDiv,"ov_sidebar_settings_padded"),this.edgeDisplayToggle.OnChange(()=>{O(this.edgeSettingsDiv,this.edgeDisplayToggle.GetStatus()),e.showEdges=this.edgeDisplayToggle.GetStatus(),t.onShowEdgesChange()});let l=v(this.edgeSettingsDiv,"ov_sidebar_settings_row"),a=["#ffffff","#e3e3e3","#c9c9c9","#898989","#5f5f5f","#494949","#383838","#0f0f0f"],h=v(l,"ov_color_picker");this.edgeColorPicker=sn(h,e.edgeColor,a,d=>{e.edgeColor=d,t.onEdgeColorChange()}),v(l,null,"Edge Color");let u=v(this.edgeSettingsDiv,"ov_sidebar_settings_row large");this.thresholdSlider=_n(u,0,90),this.thresholdSlider.setAttribute("title","Edge Angle Threshold"),this.thresholdSliderValue=Q(u,"span","ov_slider_label"),this.thresholdSlider.addEventListener("input",()=>{this.thresholdSliderValue.innerHTML=this.thresholdSlider.value}),this.thresholdSlider.addEventListener("change",()=>{e.edgeThreshold=this.thresholdSlider.value,t.onEdgeThresholdChange()}),this.thresholdSlider.value=e.edgeThreshold,this.thresholdSliderValue.innerHTML=e.edgeThreshold,this.edgeDisplayToggle.SetStatus(e.showEdges),O(this.edgeSettingsDiv,e.showEdges)}UpdateVisibility(e){this.environmentMapButton!==null&&O(this.environmentMapButton,e)}Update(e){this.backgroundColorPicker!==null&&this.backgroundColorPicker.setColor("#"+ue(e.backgroundColor)),this.edgeDisplayToggle!==null&&(this.edgeDisplayToggle.SetStatus(e.showEdges),O(this.edgeSettingsDiv,e.showEdges),this.edgeColorPicker.setColor("#"+ue(e.edgeColor)),this.thresholdSlider.value=e.edgeThreshold,this.thresholdSliderValue.innerHTML=e.edgeThreshold)}Clear(){this.environmentMapPopup!==null&&(this.environmentMapPopup.Hide(),this.environmentMapPopup=null),this.backgroundColorPicker!==null&&this.backgroundColorPicker.hide(),this.edgeColorPicker!==null&&this.edgeColorPicker.hide()}},Zs=class extends qi{constructor(e){super(e,"Import Settings");this.defaultColorPicker=null}Init(e,t){let i=v(this.contentDiv,"ov_sidebar_parameter"),r=v(i,"ov_color_picker");v(i,null,"Default Color");let n=["#ffffff","#e3e3e3","#cc3333","#fac832","#4caf50","#3393bd","#9b27b0","#fda4b8"];this.defaultColorPicker=sn(r,e.defaultColor,n,o=>{e.defaultColor=o,t.onDefaultColorChange()})}Update(e){this.defaultColorPicker!==null&&this.defaultColorPicker.setColor("#"+ue(e.defaultColor))}UpdateVisibility(e){this.contentDiv!==null&&O(this.contentDiv,e)}Clear(){this.defaultColorPicker!==null&&this.defaultColorPicker.hide()}},Qs=class extends qi{constructor(e){super(e,"Appearance");this.darkModeToggle=null}Init(e,t){let i=v(this.contentDiv,"ov_sidebar_parameter");this.darkModeToggle=nr(i,"ov_sidebar_parameter_toggle"),this.darkModeToggle.OnChange(()=>{e.themeId=this.darkModeToggle.GetStatus()?pe.Dark:pe.Light,t.onThemeChange()}),v(i,null,"Dark Mode");let r=e.themeId===pe.Dark;this.darkModeToggle.SetStatus(r)}Update(e){if(this.darkModeToggle!==null){let t=e.themeId===pe.Dark;this.darkModeToggle.SetStatus(t)}}},on=class extends di{constructor(e,t){super(e);this.settings=t,this.sectionsDiv=v(this.contentDiv,"ov_sidebar_settings_sections ov_thin_scrollbar"),this.modelDisplaySection=new Js(this.sectionsDiv),this.importParametersSection=new Zs(this.sectionsDiv),this.appearanceSection=new Qs(this.sectionsDiv),this.resetToDefaultsButton=v(this.contentDiv,"ov_button ov_panel_button outline","Reset to Default"),this.resetToDefaultsButton.addEventListener("click",()=>{this.ResetToDefaults()})}GetName(){return"Settings"}HasTitle(){return!1}GetIcon(){return"settings"}Clear(){this.modelDisplaySection.Clear(),this.importParametersSection.Clear(),this.appearanceSection.Clear()}Init(e){super.Init(e),this.modelDisplaySection.Init(this.settings,{onEnvironmentMapChange:()=>{e.onEnvironmentMapChange()},onBackgroundColorChange:()=>{e.onBackgroundColorChange()},onShowEdgesChange:()=>{e.onEdgeDisplayChange()},onEdgeColorChange:()=>{e.onEdgeDisplayChange()},onEdgeThresholdChange:()=>{e.onEdgeDisplayChange()}}),this.importParametersSection.Init(this.settings,{onDefaultColorChange:()=>{e.onDefaultColorChange()}}),this.appearanceSection.Init(this.settings,{onThemeChange:()=>{this.settings.themeId===pe.Light?(this.settings.backgroundColor=new D(255,255,255),this.settings.defaultColor=new D(200,200,200)):this.settings.themeId===pe.Dark&&(this.settings.backgroundColor=new D(42,43,46),this.settings.defaultColor=new D(200,200,200)),this.modelDisplaySection.Update(this.settings),this.importParametersSection.Update(this.settings),e.onThemeChange()}})}UpdateSettings(e,t){this.modelDisplaySection.UpdateVisibility(e),this.importParametersSection.UpdateVisibility(t),this.Resize()}ResetToDefaults(){let e=new ui;this.settings.environmentMapName=e.environmentMapName,this.settings.backgroundIsEnvMap=e.backgroundIsEnvMap,this.settings.backgroundColor=e.backgroundColor,this.settings.defaultColor=e.defaultColor,this.settings.showEdges=e.showEdges,this.settings.edgeColor=e.edgeColor,this.settings.edgeThreshold=e.edgeThreshold,this.settings.themeId=e.themeId,this.modelDisplaySection.Update(this.settings),this.importParametersSection.Update(this.settings),this.appearanceSection.Update(this.settings),this.callbacks.onEnvironmentMapChange(),this.callbacks.onThemeChange()}Resize(){let e=this.resetToDefaultsButton.offsetHeight,t=this.parentDiv.offsetHeight;tt(this.sectionsDiv,t-e)}};var ln=class{constructor(e,t,i){this.mainDiv=e,this.splitterDiv=t,this.panelSet=new li(e),this.detailsPanel=new nn(this.panelSet.GetContentDiv()),this.settingsPanel=new on(this.panelSet.GetContentDiv(),i),this.panelSet.AddPanel(this.detailsPanel),this.panelSet.AddPanel(this.settingsPanel),this.panelSet.ShowPanel(this.detailsPanel)}IsPanelsVisible(){return this.panelSet.IsPanelsVisible()}ShowPanels(e){this.panelSet.ShowPanels(e)}Init(e){this.callbacks=e,this.panelSet.Init({onResize:()=>{O(this.splitterDiv,this.panelSet.IsPanelsVisible()),this.callbacks.onResize()},onShowHidePanels:t=>{this.callbacks.onShowHidePanels(t)}}),this.settingsPanel.Init({onEnvironmentMapChange:()=>{this.callbacks.onEnvironmentMapChange()},onBackgroundColorChange:()=>{this.callbacks.onBackgroundColorChange()},onDefaultColorChange:()=>{this.callbacks.onDefaultColorChange()},onEdgeDisplayChange:()=>{this.callbacks.onEdgeDisplayChange()},onThemeChange:()=>{this.callbacks.onThemeChange()}}),Si(this.splitterDiv,this.mainDiv,!0,()=>{this.callbacks.onResize()})}UpdateSettings(e,t){this.settingsPanel.UpdateSettings(e,t)}Resize(e){tt(this.mainDiv,e),xe(this.splitterDiv,e),this.panelSet.Resize()}GetWidth(){let e=Bt(this.mainDiv),t=0;return this.panelSet.IsPanelsVisible()&&(t=this.splitterDiv.offsetWidth),e+t}DecreaseWidth(e){let t=this.mainDiv.offsetWidth;Lt(this.mainDiv,t-e)}Clear(){this.panelSet.Clear()}AddObject3DProperties(e){this.detailsPanel.AddObject3DProperties(e)}AddMaterialProperties(e){this.detailsPanel.AddMaterialProperties(e)}};var an=class{constructor(){this.css={"--ov_foreground_color":{},"--ov_background_color":{},"--ov_button_color":{},"--ov_button_hover_color":{},"--ov_button_text_color":{},"--ov_outline_button_color":{},"--ov_outline_button_hover_color":{},"--ov_outline_button_text_color":{},"--ov_icon_color":{},"--ov_light_icon_color":{},"--ov_selected_icon_color":{},"--ov_disabled_icon_color":{},"--ov_hover_color":{},"--ov_hover_text_color":{},"--ov_logo_text_color":{},"--ov_logo_border_color":{},"--ov_toolbar_background_color":{},"--ov_toolbar_selected_color":{},"--ov_toolbar_separator_color":{},"--ov_treeview_selected_color":{},"--ov_dialog_foreground_color":{},"--ov_dialog_background_color":{},"--ov_border_color":{},"--ov_shadow":{}};let e=document.querySelector(":root"),t=window.getComputedStyle(e);for(let i in this.css)Object.prototype.hasOwnProperty.call(this.css,i)&&(this.css[i].light=t.getPropertyValue(i),this.css[i].dark=t.getPropertyValue(i+"_dark"))}SwitchTheme(e){let t=null;if(e===pe.Light)t="light";else if(e===pe.Dark)t="dark";else return;let i=document.querySelector(":root");for(let r in this.css)if(Object.prototype.hasOwnProperty.call(this.css,r)){let n=this.css[r][t];n!==void 0&&i.style.setProperty(r,n)}}};var hn=class{constructor(e,t,i){this.image=e,this.imageTitle=t,this.selected=!1,this.buttonDiv=Ce("ov_toolbar_button"),this.buttonImg=ie(this.buttonDiv,this.image),i!==null&&this.buttonDiv.addEventListener("click",i),this.buttonDiv.setAttribute("alt",this.imageTitle),Mi(this.buttonDiv,this.imageTitle)}AddDomElements(e){e.appendChild(this.buttonDiv)}AddClass(e){this.buttonDiv.classList.add(e)}RemoveClass(e){this.buttonDiv.classList.remove(e)}AddImageClass(e){this.buttonImg.classList.add(e)}RemoveImageClass(e){this.buttonImg.classList.remove(e)}IsSelected(){return this.selected}SetSelected(e){this.selected=e,this.selected?this.buttonDiv.classList.add("selected"):this.buttonDiv.classList.remove("selected")}},un=class{constructor(e){this.mainDiv=v(e,"ov_toolbar")}AddImageButton(e,t,i){let r=new hn(e,t,i);return r.AddDomElements(this.mainDiv),r}AddImagePushButton(e,t,i,r){let n=new hn(e,t,()=>{n.SetSelected(!n.IsSelected()),r(n.IsSelected())});return n.AddDomElements(this.mainDiv),n.SetSelected(i),n}AddImageRadioButton(e,t,i){let r=[];for(let n=0;n<e.length;n++){let o=e[n],l=this.AddImageButton(o.image,o.title,()=>{for(let a=0;a<r.length;a++){let h=r[a];a===n?h.SetSelected(!0):h.SetSelected(!1)}i(n)});t===n&&l.SetSelected(!0),r.push(l)}return r}AddSeparator(){return v(this.mainDiv,"ov_toolbar_separator")}};var $s=class{constructor(){this.indices=[],this.vertices=[],this.colors=[],this.normals=[],this.uvs=[],this.material=null}GetBounds(){let e=[1/0,1/0,1/0],t=[-1/0,-1/0,-1/0];for(let i=0;i<this.vertices.length/3;i++)for(let r=0;r<3;r++)e[r]=Math.min(e[r],this.vertices[i*3+r]),t[r]=Math.max(t[r],this.vertices[i*3+r]);return{min:e,max:t}}GetByteLength(e,t){let i=this.indices.length,r=this.vertices.length+this.colors.length+this.normals.length+this.uvs.length;return i*e+r*t}},eo=class{constructor(){this.primitives=[]}PrimitiveCount(){return this.primitives.length}GetPrimitive(e){return this.primitives[e]}GetByteLength(e,t){let i=0;for(let r=0;r<this.primitives.length;r++)i+=this.primitives[r].GetByteLength(e,t);return i}};function Xi(s){function e(l,a,h,u){function d(c,g,x){return g!==null?c.GetVertexColor(g):x?new D(0,0,0):null}function m(c,g,x){return g!==null?c.GetTextureUV(g):x?new B(0,0):null}function f(c,g,x){let C=c.VertexColorCount()>0,M=c.TextureUVCount()>0,I=c.GetVertex(g.vertex),S=c.GetNormal(g.normal),w=x.vertices.length/3;x.indices.push(w),x.vertices.push(I.x,I.y,I.z);let y=d(c,g.color,C);y!==null&&x.colors.push(y.r/255,y.g/255,y.b/255),x.normals.push(S.x,S.y,S.z);let E=m(c,g.uv,M);return E!==null&&x.uvs.push(E.x,E.y),{index:w,color:y,normal:S,uv:E}}function p(c,g,x){function C(S,w,y){if(y===null&&w===null)return!0;let E=d(S,w,!0);return pt(y,E)}function M(S,w,y){let E=S.GetNormal(w);return Fe(y,E)}function I(S,w,y){if(y===null&&w===null)return!0;let E=m(S,w,!0);return mt(y,E)}for(let S=0;S<g.length;S++){let w=g[S],y=C(c,x.color,w.color),E=M(c,x.normal,w.normal),b=I(c,x.uv,w.uv);if(y&&E&&b)return w}return null}if(u.has(a.vertex)){let c=u.get(a.vertex),g=p(l,c,a);if(g!==null)h.indices.push(g.index);else{let x=f(l,a,h);c.push(x)}}else{let c=f(l,a,h);u.set(a.vertex,[c])}}let t=new eo,i=s.TriangleCount();if(i===0)return null;let r=[];for(let l=0;l<i;l++)r.push(l);r.sort((l,a)=>{let h=s.GetTriangle(l),u=s.GetTriangle(a);return h.mat-u.mat});let n=null,o=null;for(let l=0;l<r.length;l++){let a=r[l],h=s.GetTriangle(a);(n===null||n.material!==h.mat)&&(n=new $s,n.material=h.mat,o=new Map,t.primitives.push(n));let u={vertex:h.v0,color:h.c0,normal:h.n0,uv:h.u0},d={vertex:h.v1,color:h.c1,normal:h.n1,uv:h.u1},m={vertex:h.v2,color:h.c2,normal:h.n2,uv:h.u2};e(s,u,n,o),e(s,d,n,o),e(s,m,n,o)}return t}var $=class{constructor(e){this.name=e,this.content=null}GetName(){return this.name}SetName(e){this.name=e}GetTextContent(){return te(this.content)}GetBufferContent(){return this.content}SetTextContent(e){let t=vi(e);this.content=t}SetBufferContent(e){this.content=e}},we=class{constructor(){}CanExport(e,t){return!1}Export(e,t,i){let r=[];this.ExportContent(e,t,r,()=>{i(r)})}ExportContent(e,t,i,r){}GetExportedMaterialName(e){return this.GetExportedName(e,"Material")}GetExportedMeshName(e){return this.GetExportedName(e,"Mesh")}GetExportedName(e,t){return e.length===0?t:e}};var dn=class extends we{constructor(){super();this.rhino=null}CanExport(e,t){return e===F.Binary&&t==="3dm"}ExportContent(e,t,i,r){this.rhino===null?ge("loaders/rhino3dm.min.js").then(()=>{rhino3dm().then(n=>{this.rhino=n,this.ExportRhinoContent(e,i,r)})}).catch(()=>{r()}):this.ExportRhinoContent(e,i,r)}ExportRhinoContent(e,t,i){function r(h){return{r:h.r,g:h.g,b:h.b,a:255}}let n=new $("model.3dm");t.push(n);let o=new this.rhino.File3dm;e.EnumerateTransformedMeshes(h=>{let u=Xi(h);for(let d=0;d<u.PrimitiveCount();d++){let m=u.GetPrimitive(d),f={data:{attributes:{position:{itemSize:3,type:"Float32Array",array:m.vertices},normal:{itemSize:3,type:"Float32Array",array:m.normals}},index:{type:"Uint16Array",array:m.indices}}},p=e.GetMaterial(m.material),c=new this.rhino.Material;c.name=this.GetExportedMaterialName(p.name),p.type===Y.Phong&&(c.ambientColor=r(p.ambient),c.specularColor=r(p.specular)),c.diffuseColor=r(p.color),c.transparency=1-p.opacity;let g=o.materials().count();o.materials().add(c);let x=new this.rhino.Mesh.createFromThreejsJSON(f),C=new this.rhino.ObjectAttributes;C.name=this.GetExportedMeshName(h.GetName()),C.materialSource=this.rhino.ObjectMaterialSource.MaterialFromObject,C.materialIndex=g,o.objects().add(x,C)}});let l=new this.rhino.File3dmWriteOptions;l.version=6;let a=o.toByteArray(l);n.SetBufferContent(a),i()}};var ht=class{constructor(e,t){this.arrayBuffer=new ArrayBuffer(e),this.dataView=new DataView(this.arrayBuffer),this.isLittleEndian=t,this.position=0}GetPosition(){return this.position}SetPosition(e){this.position=e}End(){return this.position>=this.arrayBuffer.byteLength}GetBuffer(){return this.arrayBuffer}WriteArrayBuffer(e){let t=new Uint8Array(e);new Uint8Array(this.arrayBuffer).set(t,this.position),this.position+=e.byteLength}WriteBoolean8(e){this.dataView.setInt8(this.position,e?1:0),this.position=this.position+1}WriteCharacter8(e){this.dataView.setInt8(this.position,e),this.position=this.position+1}WriteUnsignedCharacter8(e){this.dataView.setUint8(this.position,e),this.position=this.position+1}WriteInteger16(e){this.dataView.setInt16(this.position,e,this.isLittleEndian),this.position=this.position+2}WriteUnsignedInteger16(e){this.dataView.setUint16(this.position,e,this.isLittleEndian),this.position=this.position+2}WriteInteger32(e){this.dataView.setInt32(this.position,e,this.isLittleEndian),this.position=this.position+4}WriteUnsignedInteger32(e){this.dataView.setUint32(this.position,e,this.isLittleEndian),this.position=this.position+4}WriteFloat32(e){this.dataView.setFloat32(this.position,e,this.isLittleEndian),this.position=this.position+4}WriteDouble64(e){this.dataView.setFloat64(this.position,e,this.isLittleEndian),this.position=this.position+8}};var mn=class extends we{constructor(){super();this.components={index:{type:5125,size:4},number:{type:5126,size:4}}}CanExport(e,t){return e===F.Text&&t==="gltf"||e===F.Binary&&t==="glb"}ExportContent(e,t,i,r){t===F.Text?this.ExportAsciiContent(e,i):t===F.Binary&&this.ExportBinaryContent(e,i),r()}ExportAsciiContent(e,t){let i=new $("model.gltf"),r=new $("model.bin");t.push(i),t.push(r);let n=this.GetMeshData(e),o=this.GetMainBuffer(n),l=this.GetMainJson(n);l.buffers.push({uri:r.GetName(),byteLength:o.byteLength});let a=new Map;this.ExportMaterials(e,l,h=>{let u=re(h.name);if(a.has(u))return a.get(u);{let d=new $(u);d.SetBufferContent(h.buffer),t.push(d);let m=l.textures.length;return a.set(u,m),l.images.push({uri:u}),l.textures.push({source:m}),m}}),i.SetTextContent(JSON.stringify(l,null,4)),r.SetBufferContent(o)}ExportBinaryContent(e,t){function i(I){let S=I%4;return S===0?I:I+(4-S)}function r(I,S,w){for(let y=0;y<w;y++)I.WriteUnsignedCharacter8(S)}let n=new $("model.glb");t.push(n);let o=this.GetMeshData(e),l=this.GetMainBuffer(o),a=this.GetMainJson(o),h=[],u=l.byteLength,d=new Map;this.ExportMaterials(e,a,I=>{let S=re(I.name),w=Ve(I.name);if(d.has(S))return d.get(S);{let y=a.bufferViews.length,E=a.textures.length;d.set(S,E);let b=I.buffer;return h.push(b),a.bufferViews.push({buffer:0,byteOffset:u,byteLength:b.byteLength}),u+=b.byteLength,a.images.push({bufferView:y,mimeType:"image/"+w}),a.textures.push({source:E}),E}});let m=l.byteLength;for(let I=0;I<h.length;I++)m+=h[I].byteLength;let f=i(m);a.buffers.push({byteLength:f});let p=JSON.stringify(a),c=vi(p),g=c.byteLength,x=i(g),C=12+8+x+8+f,M=new ht(C,!0);M.WriteUnsignedInteger32(1179937895),M.WriteUnsignedInteger32(2),M.WriteUnsignedInteger32(C),M.WriteUnsignedInteger32(x),M.WriteUnsignedInteger32(1313821514),M.WriteArrayBuffer(c),r(M,32,x-g),M.WriteUnsignedInteger32(f),M.WriteUnsignedInteger32(5130562),M.WriteArrayBuffer(l);for(let I=0;I<h.length;I++){let S=h[I];M.WriteArrayBuffer(S)}r(M,0,f-m),n.SetBufferContent(M.GetBuffer())}GetMeshData(e){let t=[];return e.EnumerateTransformedMeshes(i=>{let r=Xi(i);t.push({name:i.GetName(),buffer:r,offsets:[],sizes:[]})}),t}GetMainBuffer(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].buffer.GetByteLength(this.components.index.size,this.components.number.size);let i=new ht(t,!0);for(let r=0;r<e.length;r++){let n=e[r];for(let o=0;o<n.buffer.PrimitiveCount();o++){let l=n.buffer.GetPrimitive(o),a=i.GetPosition();for(let h=0;h<l.indices.length;h++)i.WriteUnsignedInteger32(l.indices[h]);for(let h=0;h<l.vertices.length;h++)i.WriteFloat32(l.vertices[h]);for(let h=0;h<l.colors.length;h++)i.WriteFloat32(it(l.colors[h]));for(let h=0;h<l.normals.length;h++)i.WriteFloat32(l.normals[h]);for(let h=0;h<l.uvs.length;h++){let u=l.uvs[h];h%2===1&&(u*=-1),i.WriteFloat32(u)}n.offsets.push(a),n.sizes.push(i.GetPosition()-a)}}return i.GetBuffer()}GetMainJson(e){class t{constructor(n,o){this.mainJson=n,this.byteOffset=o}AddBufferView(n){return this.mainJson.bufferViews.push({buffer:0,byteOffset:this.byteOffset,byteLength:n}),this.byteOffset+=n,this.mainJson.bufferViews.length-1}}let i={asset:{generator:"https://3d.frisqoo.com",version:"2.0"},scene:0,scenes:[{nodes:[]}],nodes:[],materials:[],meshes:[],buffers:[],bufferViews:[],accessors:[]};for(let r=0;r<e.length;r++){let n=e[r];i.scenes[0].nodes.push(r),i.nodes.push({mesh:r});let o={name:this.GetExportedMeshName(n.name),primitives:[]},l=n.buffer.primitives;for(let a=0;a<l.length;a++){let h=l[a],u=new t(i,n.offsets[a]),d=u.AddBufferView(h.indices.length*this.components.index.size),m=u.AddBufferView(h.vertices.length*this.components.number.size),f=null;h.colors.length>0&&(f=u.AddBufferView(h.colors.length*this.components.number.size));let p=u.AddBufferView(h.normals.length*this.components.number.size),c=null;h.uvs.length>0&&(c=u.AddBufferView(h.uvs.length*this.components.number.size));let g={attributes:{},mode:4,material:h.material},x=h.GetBounds();i.accessors.push({bufferView:d,byteOffset:0,componentType:this.components.index.type,count:h.indices.length,type:"SCALAR"}),g.indices=i.accessors.length-1,i.accessors.push({bufferView:m,byteOffset:0,componentType:this.components.number.type,count:h.vertices.length/3,min:x.min,max:x.max,type:"VEC3"}),g.attributes.POSITION=i.accessors.length-1,f!==null&&(i.accessors.push({bufferView:f,byteOffset:0,componentType:this.components.number.type,count:h.colors.length/3,type:"VEC3"}),g.attributes.COLOR_0=i.accessors.length-1),i.accessors.push({bufferView:p,byteOffset:0,componentType:this.components.number.type,count:h.normals.length/3,type:"VEC3"}),g.attributes.NORMAL=i.accessors.length-1,c!==null&&(i.accessors.push({bufferView:c,byteOffset:0,componentType:this.components.number.type,count:h.uvs.length/2,type:"VEC2"}),g.attributes.TEXCOORD_0=i.accessors.length-1),o.primitives.push(g)}i.meshes.push(o)}return i}ExportMaterials(e,t,i){function r(n,o,l,a){function h(g,x){return[it(g.r/255),it(g.g/255),it(g.b/255),x]}function u(g){return[it(g.r/255),it(g.g/255),it(g.b/255)]}function d(g,x,C){if(x===null||!x.IsValid())return null;g.images===void 0&&(g.images=[]),g.textures===void 0&&(g.textures=[]);let I={index:C(x)};if(x.HasTransformation()){let S="KHR_texture_transform";g.extensionsUsed===void 0&&(g.extensionsUsed=[]),g.extensionsUsed.indexOf(S)===-1&&g.extensionsUsed.push(S),I.extensions={KHR_texture_transform:{offset:[x.offset.x,-x.offset.y],scale:[x.scale.x,x.scale.y],rotation:-x.rotation}}}return I}let m={name:n.GetExportedMaterialName(l.name),pbrMetallicRoughness:{baseColorFactor:h(l.color,l.opacity)},emissiveFactor:u(l.emissive),doubleSided:!0,alphaMode:"OPAQUE"};l.transparent&&(m.alphaMode="BLEND");let f=d(o,l.diffuseMap,a);if(f!==null&&(l.multiplyDiffuseMap||(m.pbrMetallicRoughness.baseColorFactor=h(new D(255,255,255),l.opacity)),m.pbrMetallicRoughness.baseColorTexture=f),l.type===Y.Physical){let g=d(o,l.metalnessMap,a);g!==null?m.pbrMetallicRoughness.metallicRoughnessTexture=g:(m.pbrMetallicRoughness.metallicFactor=l.metalness,m.pbrMetallicRoughness.roughnessFactor=l.roughness)}let p=d(o,l.normalMap,a);p!==null&&(m.normalTexture=p);let c=d(o,l.emissiveMap,a);c!==null&&(m.emissiveTexture=c),o.materials.push(m)}for(let n=0;n<e.MaterialCount();n++){let o=e.GetMaterial(n);r(this,t,o,i)}}};var Yi=class{constructor(e){this.transformation=new q,this.isMeshVisible=t=>!0,Li(e,this)}},mi=class{constructor(e,t){this.model=e,this.settings=t||new Yi}MaterialCount(){return this.model.MaterialCount()}GetMaterial(e){return this.model.GetMaterial(e)}VertexCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.VertexCount()}),e}TriangleCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=t.TriangleCount()}),e}MeshInstanceCount(){let e=0;return this.EnumerateMeshInstances(t=>{e+=1}),e}EnumerateMeshInstances(e){this.model.EnumerateMeshInstances(t=>{this.settings.isMeshVisible(t.GetId())&&e(t)})}EnumerateTransformedMeshes(e){this.EnumerateMeshInstances(t=>{let i=t.GetTransformation();this.settings.transformation.IsIdentity()||i.Append(this.settings.transformation);let n=t.GetMesh().Clone();i.IsIdentity()||nt(n,i),e(n)})}EnumerateVerticesAndTriangles(e){let t=[];this.EnumerateTransformedMeshes(r=>{t.push(r)});for(let r of t)r.EnumerateVertices(n=>{e.onVertex(n.x,n.y,n.z)});let i=0;for(let r of t)r.EnumerateTriangleVertexIndices((n,o,l)=>{e.onTriangle(n+i,o+i,l+i)}),i+=r.VertexCount()}EnumerateTrianglesWithNormals(e){this.EnumerateTransformedMeshes(t=>{t.EnumerateTriangleVertices((i,r,n)=>{let o=Zt(i,r,n);e(i,r,n,o)})})}};var Oe=class{constructor(){this.text="",this.indentation=0}GetText(){return this.text}Indent(e){this.indentation+=e}WriteArrayLine(e){this.WriteLine(e.join(" "))}WriteLine(e){this.WriteIndentation(),this.Write(e+`
`)}WriteIndentation(){for(let e=0;e<this.indentation;e++)this.Write("  ")}Write(e){this.text+=e}};var fn=class extends we{constructor(){super()}CanExport(e,t){return e===F.Text&&t==="obj"}ExportContent(e,t,i,r){function n(p,c,g,x){if(g===null||!g.IsValid())return;let C=re(g.name);if(p.WriteArrayLine([c,C]),x.findIndex(I=>I.GetName()===C)===-1){let I=new $(C);I.SetBufferContent(g.buffer),x.push(I)}}let o=new $("model.mtl"),l=new $("model.obj");i.push(o),i.push(l);let a=new Oe;a.WriteLine(this.GetHeaderText());for(let p=0;p<e.MaterialCount();p++){let c=e.GetMaterial(p);a.WriteArrayLine(["newmtl",this.GetExportedMaterialName(c.name)]),a.WriteArrayLine(["Kd",c.color.r/255,c.color.g/255,c.color.b/255]),a.WriteArrayLine(["d",c.opacity]),c.type===Y.Phong&&(a.WriteArrayLine(["Ka",c.ambient.r/255,c.ambient.g/255,c.ambient.b/255]),a.WriteArrayLine(["Ks",c.specular.r/255,c.specular.g/255,c.specular.b/255]),a.WriteArrayLine(["Ns",c.shininess*1e3])),n(a,"map_Kd",c.diffuseMap,i),c.type===Y.Phong&&n(a,"map_Ks",c.specularMap,i),n(a,"bump",c.bumpMap,i)}o.SetTextContent(a.GetText());let h=new Oe;h.WriteLine(this.GetHeaderText()),h.WriteArrayLine(["mtllib",o.GetName()]);let u=0,d=0,m=0,f=null;e.EnumerateTransformedMeshes(p=>{h.WriteArrayLine(["g",this.GetExportedMeshName(p.GetName())]);for(let c=0;c<p.VertexCount();c++){let g=p.GetVertex(c);h.WriteArrayLine(["v",g.x,g.y,g.z])}for(let c=0;c<p.NormalCount();c++){let g=p.GetNormal(c);h.WriteArrayLine(["vn",g.x,g.y,g.z])}for(let c=0;c<p.TextureUVCount();c++){let g=p.GetTextureUV(c);h.WriteArrayLine(["vt",g.x,g.y])}for(let c=0;c<p.TriangleCount();c++){let g=p.GetTriangle(c),x=g.v0+u+1,C=g.v1+u+1,M=g.v2+u+1,I=g.n0+d+1,S=g.n1+d+1,w=g.n2+d+1;if(g.mat!==null){let A=e.GetMaterial(g.mat),k=this.GetExportedMaterialName(A.name);k!==f&&(h.WriteArrayLine(["usemtl",k]),f=k)}let y="",E="",b="";g.HasTextureUVs()&&(y=g.u0+m+1,E=g.u1+m+1,b=g.u2+m+1),h.WriteArrayLine(["f",[x,y,I].join("/"),[C,E,S].join("/"),[M,b,w].join("/")])}u+=p.VertexCount(),d+=p.NormalCount(),m+=p.TextureUVCount()}),l.SetTextContent(h.GetText()),r()}GetHeaderText(){return"# exported by https://3d.frisqoo.com"}};var cn=class extends we{constructor(){super()}CanExport(e,t){return e===F.Text&&t==="off"}ExportContent(e,t,i,r){let n=new $("model.off");i.push(n);let o=new Oe;o.WriteLine("OFF"),o.WriteArrayLine([e.VertexCount(),e.TriangleCount(),0]),e.EnumerateVerticesAndTriangles({onVertex:function(l,a,h){o.WriteArrayLine([l,a,h])},onTriangle:function(l,a,h){o.WriteArrayLine([3,l,a,h])}}),n.SetTextContent(o.GetText()),r()}};var pn=class extends we{constructor(){super()}CanExport(e,t){return(e===F.Text||e===F.Binary)&&t==="ply"}ExportContent(e,t,i,r){t===F.Text?this.ExportText(e,i):this.ExportBinary(e,i),r()}ExportText(e,t){let i=new $("model.ply");t.push(i);let r=new Oe,n=e.VertexCount(),o=e.TriangleCount(),l=this.GetHeaderText("ascii",n,o);r.Write(l),e.EnumerateVerticesAndTriangles({onVertex:function(a,h,u){r.WriteArrayLine([a,h,u])},onTriangle:function(a,h,u){r.WriteArrayLine([3,a,h,u])}}),i.SetTextContent(r.GetText())}ExportBinary(e,t){let i=new $("model.ply");t.push(i);let r=e.VertexCount(),n=e.TriangleCount(),o=this.GetHeaderText("binary_little_endian",r,n),l=o.length+r*3*4+n*(1+3*4),a=new ht(l,!0);for(let h=0;h<o.length;h++)a.WriteUnsignedCharacter8(o.charCodeAt(h));e.EnumerateVerticesAndTriangles({onVertex:function(h,u,d){a.WriteFloat32(h),a.WriteFloat32(u),a.WriteFloat32(d)},onTriangle:function(h,u,d){a.WriteUnsignedCharacter8(3),a.WriteInteger32(h),a.WriteInteger32(u),a.WriteInteger32(d)}}),i.SetBufferContent(a.GetBuffer())}GetHeaderText(e,t,i){let r=new Oe;return r.WriteLine("ply"),r.WriteLine("format "+e+" 1.0"),r.WriteLine("element vertex "+t),r.WriteLine("property float x"),r.WriteLine("property float y"),r.WriteLine("property float z"),r.WriteLine("element face "+i),r.WriteLine("property list uchar int vertex_index"),r.WriteLine("end_header"),r.GetText()}};var gn=class extends we{constructor(){super()}CanExport(e,t){return(e===F.Text||e===F.Binary)&&t==="stl"}ExportContent(e,t,i,r){t===F.Text?this.ExportText(e,i):this.ExportBinary(e,i),r()}ExportText(e,t){let i=new $("model.stl");t.push(i);let r=new Oe;r.WriteLine("solid Model"),e.EnumerateTrianglesWithNormals((n,o,l,a)=>{r.WriteArrayLine(["facet","normal",a.x,a.y,a.z]),r.Indent(1),r.WriteLine("outer loop"),r.Indent(1),r.WriteArrayLine(["vertex",n.x,n.y,n.z]),r.WriteArrayLine(["vertex",o.x,o.y,o.z]),r.WriteArrayLine(["vertex",l.x,l.y,l.z]),r.Indent(-1),r.WriteLine("endloop"),r.Indent(-1),r.WriteLine("endfacet")}),r.WriteLine("endsolid Model"),i.SetTextContent(r.GetText())}ExportBinary(e,t){let i=new $("model.stl");t.push(i);let r=e.TriangleCount(),n=80,o=n+4+r*50,l=new ht(o,!0);for(let a=0;a<n;a++)l.WriteUnsignedCharacter8(0);l.WriteUnsignedInteger32(r),e.EnumerateTrianglesWithNormals((a,h,u,d)=>{l.WriteFloat32(d.x),l.WriteFloat32(d.y),l.WriteFloat32(d.z),l.WriteFloat32(a.x),l.WriteFloat32(a.y),l.WriteFloat32(a.z),l.WriteFloat32(h.x),l.WriteFloat32(h.y),l.WriteFloat32(h.z),l.WriteFloat32(u.x),l.WriteFloat32(u.y),l.WriteFloat32(u.z),l.WriteUnsignedInteger16(0)}),i.SetBufferContent(l.GetBuffer())}};var xn=class{constructor(){this.exporters=[new fn,new gn,new pn,new cn,new mn,new dn]}AddExporter(e){this.exporters.push(e)}Export(e,t,i,r,n){let o=null;for(let a=0;a<this.exporters.length;a++){let h=this.exporters[a];if(h.CanExport(i,r)){o=h;break}}if(o===null){n.onError();return}let l=new mi(e,t);o.Export(l,i,a=>{a.length===0?n.onError():n.onSuccess(a)})}};var Ki={Model:0,Image:1},Cn=class{constructor(e){this.name=e}GetType(){return null}GetName(){return this.name}GenerateParametersUI(e){}AddSelectItem(e,t,i,r){let n=v(e,"ov_dialog_row");v(n,"ov_dialog_row_name",t);let o=v(n,"ov_dialog_row_value");return rr(o,i,r)}},je=class extends Cn{constructor(e,t,i){super(e);this.format=t,this.extension=i,this.visibleOnlySelect=null,this.rotationSelect=null}GetType(){return Ki.Model}GenerateParametersUI(e){this.visibleOnlySelect=this.AddSelectItem(e,"Scope",["Entire Model","Visible Only"],1),this.rotationSelect=this.AddSelectItem(e,"Rotation",["No Rotation","-90 Degrees","90 Degrees"],0)}ExportModel(e,t){let i=new Yi;if(this.visibleOnlySelect.selectedIndex===1&&(i.isMeshVisible=o=>t.isMeshVisible(o)),this.rotationSelect.selectedIndex===1){let o=new U().CreateRotationAxisAngle(new T(1,0,0),-Math.PI/2);i.transformation.SetMatrix(o)}else if(this.rotationSelect.selectedIndex===2){let o=new U().CreateRotationAxisAngle(new T(1,0,0),Math.PI/2);i.transformation.SetMatrix(o)}if(new mi(e,i).MeshInstanceCount()===0){let o=$e("Export Failed","The model doesn't contain any meshes.",null);t.onDialog(o);return}let n=new ni;n.Init("Exporting Model"),n.Show(),Ct(()=>{new xn().Export(e,i,this.format,this.extension,{onError:()=>{n.Hide()},onSuccess:l=>{if(l.length===0)n.Hide();else if(l.length===1){n.Hide();let a=l[0];hr(a.GetBufferContent(),a.GetName())}else l.length>1&&ge("loaders/fflate.min.js").then(()=>{let a={};for(let d of l)a[d.name]=new Uint8Array(d.content);let u=fflate.zipSync(a).buffer;n.Hide(),hr(u,"model.zip")}).catch(()=>{n.Hide()})}})})}},to=class extends Cn{constructor(e,t){super(e);this.extension=t,this.sizeSelect=null,this.sizes=[{name:"Current size",value:null},{name:"1280 x 720",value:[1280,720]},{name:"1920 x 1080",value:[1920,1080]}]}GetType(){return Ki.Image}GenerateParametersUI(e){let t=this.sizes.map(i=>i.name);this.sizeSelect=this.AddSelectItem(e,"Image size",t,1)}ExportImage(e){let t=this.sizes[this.sizeSelect.selectedIndex],i=null;if(t.value===null){let r=e.GetImageSize();i=e.GetImageAsDataUrl(r.width,r.height)}else i=e.GetImageAsDataUrl(t.value[0],t.value[1]);ar(i,"model."+this.extension)}},vn=class{constructor(e){this.callbacks=e,this.selectedExporter=null,this.parametersDiv=null,this.exporters=[new je("Wavefront (.obj)",F.Text,"obj"),new je("Stereolithography Text (.stl)",F.Text,"stl"),new je("Stereolithography Binary (.stl)",F.Binary,"stl"),new je("Polygon File Format Text (.ply)",F.Text,"ply"),new je("Polygon File Format Binary (.ply)",F.Binary,"ply"),new je("glTF Text (.gltf)",F.Text,"gltf"),new je("glTF Binary (.glb)",F.Binary,"glb"),new je("Object File Format Text (.off)",F.Text,"off"),new je("Rhinoceros 3D (.3dm)",F.Binary,"3dm"),new to("PNG Image (.png)","png")]}Show(e,t){let i=new Be,r=i.Init("Export",[{name:"Close",subClass:"outline",onClick(){i.Hide()}},{name:"Export",onClick:()=>{i.Hide(),this.ExportFormat(e,t)}}]);v(r,"ov_dialog_section","Select the format from the list below, and adjust the settings of the selected format.");let o=v(r,"ov_dialog_row");this.parametersDiv=v(r);let l=this.exporters.map(u=>u.GetName()),a=At("ov_last_export_format","glTF Binary (.glb)"),h=l.indexOf(a);h===-1&&(h=6),rr(o,l,h,u=>{Et("ov_last_export_format",l[u]),this.OnFormatSelected(u)}),this.OnFormatSelected(h),i.Show(),this.callbacks.onDialog(i)}OnFormatSelected(e){Te(this.parametersDiv),this.selectedExporter=this.exporters[e],this.selectedExporter.GenerateParametersUI(this.parametersDiv)}ExportFormat(e,t){this.selectedExporter.GetType()===Ki.Model?(this.selectedExporter.ExportModel(e,{isMeshVisible:i=>this.callbacks.isMeshVisible(i),onDialog:i=>{this.callbacks.onDialog(i)}}),se("model_exported",this.selectedExporter.GetName())):this.selectedExporter.GetType()===Ki.Image&&this.selectedExporter.ExportImage(t)}};function io(s){let e=new Be,t=Vt("textarea","ov_dialog_textarea"),i=e.Init("Open Model from Url",[{name:"Cancel",subClass:"outline",onClick(){e.Hide()}},{name:"OK",onClick(){let n=[];Ge(t.value,o=>{n.push(o)}),e.Hide(),s(n)}}]);return v(i,"ov_dialog_section","Here you can load models based on their urls. You can add more lines if your model builds up from multiple files."),i.appendChild(t),e.Show(),t.focus(),e}function ro(s,e,t){function i(d,m,f,p){let c=v(d,"ov_dialog_row"),g=Ci(c,f,m,!0,()=>{p(g.checked)})}function r(d,m){let f="Copy",p="Copied",c=v(d,"ov_dialog_copyable_input"),g=Q(c,"input","ov_dialog_text");g.readOnly=!0;let x=v(c,"ov_button outline ov_dialog_copyable_input_button",f);return x.addEventListener("click",()=>{On(m()),x.innerHTML=p,setTimeout(()=>{x.innerHTML=f},2e3)}),g}function n(d,m){function f(g){let x=Ei();x.AddModelUrls(g);let C=x.GetParameterList();return"https://3d.frisqoo.com#"+C}let p=v(d,"ov_dialog_section");v(p,"ov_dialog_inner_title","Sharing Link");let c=r(p,()=>(se("model_shared","sharing_link"),f(m)));c.value=f(m)}function o(d,m,f,p){function c(I,S,w,y){let E=Ei();if(E.AddModelUrls(I),S){E.AddCamera(y);let k={environmentMapName:w.environmentMapName,backgroundIsEnvMap:w.backgroundIsEnvMap};E.AddEnvironmentSettings(k),E.AddBackgroundColor(w.backgroundColor),E.AddDefaultColor(w.defaultColor);let R={showEdges:w.showEdges,edgeColor:w.edgeColor,edgeThreshold:w.edgeThreshold};E.AddEdgeSettings(R)}let b=E.GetParameterList(),A="";return A+="<iframe",A+=' width="640" height="480"',A+=' style="border:1px solid #eeeeee;"',A+=' src="https://3d.frisqoo.com/embed.html#'+b+'">',A+="</iframe>",A}let g=!0,x=v(d,"ov_dialog_section");x.style.marginTop="20px",v(x,"ov_dialog_inner_title","Embedding Code");let C=v(x,"ov_dialog_section"),M=r(x,()=>(se("model_shared","embedding_code"),c(m,g,f,p)));i(C,"Use customized settings","embed_current_settings",I=>{g=I,M.value=c(m,g,f,p)}),M.value=c(m,g,f,p)}if(!s.IsOnlyUrlSource())return $e("Sharing Failed","Sharing works only if you load files by url. Please upload your model files to a web server, open them by url, and try embedding again.",null);let l=s.GetFiles(),a=[];for(let d=0;d<l.length;d++){let m=l[d];m.source===Z.Url&&a.push(m.fileUrl)}let h=new Be,u=h.Init("Share",[{name:"Close",onClick(){h.Hide()}}]);return n(u,a),o(u,a,e,t),h.Show(),h}function In(s){let e=new THREE.Matrix4;s.object.updateWorldMatrix(!0,!1),e.extractRotation(s.object.matrixWorld);let t=s.face.normal.clone();return t.applyMatrix4(e),t}function so(){return new THREE.LineBasicMaterial({color:2503224,depthTest:!1})}function Ji(s,e){let t=new THREE.BufferGeometry().setFromPoints(s);return new THREE.Line(t,e)}var oo=class{constructor(e,t){this.intersection=null,this.markerObject=new THREE.Object3D;let i=so(),r=new THREE.EllipseCurve(0,0,t,t,0,2*Math.PI,!1,0);this.markerObject.add(Ji(r.getPoints(50),i)),this.markerObject.add(Ji([new THREE.Vector3(-t,0,0),new THREE.Vector3(t,0,0)],i)),this.markerObject.add(Ji([new THREE.Vector3(0,-t,0),new THREE.Vector3(0,t,0)],i)),this.UpdatePosition(e)}UpdatePosition(e){this.intersection=e;let t=In(this.intersection);this.markerObject.updateMatrixWorld(!0),this.markerObject.position.set(0,0,0),this.markerObject.lookAt(t),this.markerObject.position.set(this.intersection.point.x,this.intersection.point.y,this.intersection.point.z)}Show(e){this.markerObject.visible=e}GetIntersection(){return this.intersection}GetObject(){return this.markerObject}};function vo(s,e){let t=s.GetIntersection(),i=e.GetIntersection(),r={pointsDistance:null,parallelFacesDistance:null,facesAngle:null},n=In(t),o=In(i);if(r.pointsDistance=t.point.distanceTo(i.point),r.facesAngle=n.angleTo(o),er(r.facesAngle,0,1e-4)||er(r.facesAngle,Math.PI,1e-4)){let l=new THREE.Plane().setFromNormalAndCoplanarPoint(n,t.point);r.parallelFacesDistance=Math.abs(l.distanceToPoint(i.point))}return r}var Tn=class{constructor(e,t){this.viewer=e,this.settings=t,this.isActive=!1,this.markers=[],this.tempMarker=null,this.panel=null,this.button=null}SetButton(e){this.button=e}IsActive(){return this.isActive}SetActive(e){this.isActive!==e&&(this.isActive=e,this.button.SetSelected(e),this.isActive?(this.panel=v(document.body,"ov_measure_panel"),this.UpdatePanel(),this.Resize()):(this.ClearMarkers(),this.panel.remove()))}Click(e){let t=this.viewer.GetMeshIntersectionUnderMouse(e);if(t===null){this.ClearMarkers(),this.UpdatePanel();return}this.markers.length===2&&this.ClearMarkers(),this.AddMarker(t),this.UpdatePanel()}MouseMove(e){let t=this.viewer.GetMeshIntersectionUnderMouse(e);if(t===null){this.tempMarker!==null&&(this.tempMarker.Show(!1),this.viewer.Render());return}this.tempMarker===null&&(this.tempMarker=this.GenerateMarker(t)),this.tempMarker.UpdatePosition(t),this.tempMarker.Show(!0),this.viewer.Render()}AddMarker(e){let t=this.GenerateMarker(e);if(this.markers.push(t),this.markers.length===2){let i=so(),r=this.markers[0].GetIntersection().point,n=this.markers[1].GetIntersection().point;this.viewer.AddExtraObject(Ji([r,n],i))}}GenerateMarker(e){let i=this.viewer.GetBoundingSphere(n=>!0).radius/20,r=new oo(e,i);return this.viewer.AddExtraObject(r.GetObject()),r}UpdatePanel(){function e(t,i,r,n){let o=ie(t,i,"left_inline");o.title=r,v(t,"ov_measure_value",n)}if(Te(this.panel),kn(this.settings.backgroundColor)?this.panel.style.color="#000000":this.panel.style.color="#ffffff",this.markers.length===0)this.panel.innerHTML="Select a point.";else if(this.markers.length===1)this.panel.innerHTML="Select another point.";else{let t=vo(this.markers[0],this.markers[1]);if(t.pointsDistance!==null&&e(this.panel,"measure_distance","Distance of points",t.pointsDistance.toFixed(3)),t.parallelFacesDistance!==null&&e(this.panel,"measure_distance_parallel","Distance of parallel faces",t.parallelFacesDistance.toFixed(3)),t.facesAngle!==null){let i=t.facesAngle*Sn;e(this.panel,"measure_angle","Angle of faces",i.toFixed(1)+"\xB0")}}}Resize(){if(!this.isActive)return;let t=this.viewer.GetCanvas().getBoundingClientRect();this.panel.style.left=t.left+"px",this.panel.style.top=t.top+"px",this.panel.style.width=t.right-t.left+"px"}ClearMarkers(){this.viewer.ClearExtra(),this.markers=[],this.tempMarker=null}};var qe={Undefined:0,Intro:1,Model:2,Loading:3},Mn=class{constructor(e){this.parameters=e,this.settings=new ui,this.viewer=new ii,this.measureTool=new Tn(this.viewer,this.settings),this.hashHandler=new ri,this.toolbar=new un(this.parameters.toolbarDiv),this.navigator=new en(this.parameters.navigatorDiv,this.parameters.navigatorSplitterDiv),this.sidebar=new ln(this.parameters.sidebarDiv,this.parameters.sidebarSplitterDiv,this.settings),this.modelLoaderUI=new si,this.themeHandler=new an,this.highlightColor=new THREE.Color(9357808),this.uiState=qe.Undefined,this.model=null,this.dialog=null}Load(){this.settings.LoadFromCookies(),this.SwitchTheme(this.settings.themeId,!1),se("theme_on_load",this.settings.themeId===pe.Light?"light":"dark"),this.InitViewer(),this.InitToolbar(),this.InitDragAndDrop(),this.InitSidebar(),this.InitNavigator(),this.InitCookieConsent(),this.viewer.SetMouseClickHandler(this.OnModelClicked.bind(this)),this.viewer.SetMouseMoveHandler(this.OnModelMouseMoved.bind(this)),this.viewer.SetContextMenuHandler(this.OnModelContextMenu.bind(this)),this.Resize(),this.SetUIState(qe.Intro),this.hashHandler.SetEventListener(this.OnHashChange.bind(this)),this.OnHashChange(),Ln(()=>{this.OnSmallWidthChanged()}),window.addEventListener("resize",()=>{this.Resize()})}Resize(){let e=window.innerWidth,t=window.innerHeight,i=this.parameters.headerDiv.offsetHeight,r=0,n=0,o=0;Bn()||(r=this.navigator.GetWidth(),n=this.sidebar.GetWidth(),o=1);let l=50,a=e-r-n;a<l&&(this.sidebar.DecreaseWidth(l-a),a=l);let h=t-i;tt(this.parameters.introDiv,h),this.navigator.Resize(h),this.sidebar.Resize(h),this.viewer.Resize(a-o,h),this.measureTool.Resize()}OnSmallWidthChanged(){this.uiState===qe.Model&&this.UpdatePanelsVisibility()}HasLoadedModel(){return this.model!==null}SetUIState(e){function t(i){document.querySelector(":root").style.setProperty("--ov_only_on_model_display",i?"inherit":"none")}this.uiState!==e&&(this.uiState=e,this.uiState===qe.Intro?(O(this.parameters.introDiv,!0),O(this.parameters.mainDiv,!1),t(!1)):this.uiState===qe.Model?(O(this.parameters.introDiv,!1),O(this.parameters.mainDiv,!0),t(!0),this.UpdatePanelsVisibility()):this.uiState===qe.Loading&&(O(this.parameters.introDiv,!1),O(this.parameters.mainDiv,!1),t(!1)),this.Resize())}ClearModel(){this.HidePopups(),this.model=null,this.viewer.Clear(),this.parameters.fileNameDiv.innerHTML="",this.navigator.Clear(),this.sidebar.Clear(),this.measureTool.SetActive(!1)}OnModelLoaded(e,t){this.model=e.model,this.parameters.fileNameDiv.innerHTML=e.mainFile,this.viewer.SetMainObject(t),this.viewer.SetUpVector(G.Y,!1),this.navigator.FillTree(e),this.UpdateSidebar(),this.FitModelToWindow(!0)}OnModelClicked(e,t){if(e!==1)return;if(this.measureTool.IsActive()){this.measureTool.Click(t);return}let i=this.viewer.GetMeshUserDataUnderMouse(t);i===null?this.navigator.SetSelection(null):this.navigator.SetSelection(new wt(le.Mesh,i.originalMeshId))}OnModelMouseMoved(e){if(this.measureTool.IsActive()){this.measureTool.MouseMove(e);return}}OnModelContextMenu(e,t){let i=this.viewer.GetMeshUserDataUnderMouse(t),r=[];if(i===null)r.push({name:"Fit model to window",icon:"fit",onClick:()=>{this.FitModelToWindow(!1)}}),this.navigator.HasHiddenMesh()&&r.push({name:"Show all meshes",icon:"visible",onClick:()=>{this.navigator.ShowAllMeshes(!0)}});else if(r.push({name:"Hide mesh",icon:"hidden",onClick:()=>{this.navigator.ToggleMeshVisibility(i.originalMeshId)}}),r.push({name:"Fit mesh to window",icon:"fit",onClick:()=>{this.navigator.FitMeshToWindow(i.originalMeshId)}}),this.navigator.MeshItemCount()>1){let n=this.navigator.IsMeshIsolated(i.originalMeshId);r.push({name:n?"Remove isolation":"Isolate mesh",icon:n?"deisolate":"isolate",onClick:()=>{n?this.navigator.ShowAllMeshes(!0):this.navigator.IsolateMesh(i.originalMeshId)}})}this.dialog=jt(r,{calculatePosition:n=>Hs(e,n),onClick:n=>{r[n].onClick()}})}OnHashChange(){if(this.hashHandler.HasHash()){let e=this.hashHandler.GetModelFilesFromHash();if(e===null)return;Di(e);let t=new Wt;t.defaultColor=this.settings.defaultColor;let i=this.hashHandler.GetDefaultColorFromHash();i!==null&&(t.defaultColor=i),se("model_load_started","hash"),this.LoadModelFromUrlList(e,t)}else this.ClearModel(),this.SetUIState(qe.Intro)}HidePopups(){this.dialog!==null&&(this.dialog.Hide(),this.dialog=null)}OpenFileBrowserDialog(){this.parameters.fileInput.click()}FitModelToWindow(e){let t=!e,i=this.viewer.GetBoundingSphere(r=>this.navigator.IsMeshVisible(r.originalMeshId));e&&this.viewer.AdjustClippingPlanesToSphere(i),this.viewer.FitSphereToWindow(i,t)}FitMeshToWindow(e){let t=this.viewer.GetBoundingSphere(i=>i.originalMeshId.IsEqual(e));this.viewer.FitSphereToWindow(t,!0)}FitMeshesToWindow(e){let t=new Set;for(let r of e)t.add(r.GetKey());let i=this.viewer.GetBoundingSphere(r=>t.has(r.originalMeshId.GetKey()));this.viewer.FitSphereToWindow(i,!0)}UpdateSidebar(){let t=this.viewer.GetShadingType()===me.Physical,i=ls(this.model);this.sidebar.UpdateSettings(t,i)}UpdateMeshesVisibility(){this.viewer.SetMeshesVisibility(e=>this.navigator.IsMeshVisible(e.originalMeshId))}UpdateMeshesSelection(){let e=this.navigator.GetSelectedMeshId();this.viewer.SetMeshesHighlight(this.highlightColor,t=>!!(e!==null&&t.originalMeshId.IsEqual(e)))}LoadModelFromUrlList(e,t){this.LoadModel(e,Z.Url,t),this.ClearHashIfNotOnlyUrlList()}LoadModelFromFileList(e){let t=new Wt;t.defaultColor=this.settings.defaultColor,this.LoadModel(e,Z.File,t),this.ClearHashIfNotOnlyUrlList()}LoadModel(e,t,i){this.modelLoaderUI.LoadModel(e,t,i,{onStart:()=>{this.SetUIState(qe.Loading),this.ClearModel()},onFinish:(r,n)=>{this.SetUIState(qe.Model),this.OnModelLoaded(r,n);let o=Ve(r.mainFile);se("model_loaded",o)},onRender:()=>{this.viewer.Render()},onError:r=>{this.SetUIState(qe.Intro);let n=null;if(r.mainFile!==null)n=Ve(r.mainFile);else{let o=[],a=this.modelLoaderUI.GetImporter().GetFileList().GetFiles();for(let h=0;h<a.length;h++){let u=a[h].extension;o.push(u)}n=o.join(",")}r.code===_e.NoImportableFile?se("no_importable_file",n):r.code===_e.FailedToLoadFile?se("failed_to_load_file",n):r.code===_e.ImportFailed&&se("import_failed",n,{error_message:r.message})}})}ClearHashIfNotOnlyUrlList(){!this.modelLoaderUI.GetImporter().GetFileList().IsOnlyUrlSource()&&this.hashHandler.HasHash()&&(this.hashHandler.SkipNextEventHandler(),this.hashHandler.ClearHash())}UpdateEdgeDisplay(){this.settings.SaveToCookies(),this.viewer.SetEdgeSettings(this.settings.showEdges,this.settings.edgeColor,this.settings.edgeThreshold)}UpdateEnvironmentMap(){let e="assets/envmaps/"+this.settings.environmentMapName+"/",t=[e+"posx.jpg",e+"negx.jpg",e+"posy.jpg",e+"negy.jpg",e+"posz.jpg",e+"negz.jpg"];this.viewer.SetEnvironmentMapSettings(t,this.settings.backgroundIsEnvMap)}SwitchTheme(e,t){if(this.settings.themeId=e,this.themeHandler.SwitchTheme(this.settings.themeId),this.settings.SaveToCookies(),t){this.viewer.SetBackgroundColor(this.settings.backgroundColor);let i=this.modelLoaderUI.GetModelLoader();i.GetDefaultMaterial()!==null&&(xr(this.model,this.settings.defaultColor),i.ReplaceDefaultMaterialColor(this.settings.defaultColor))}}InitViewer(){let e=Q(this.parameters.viewerDiv,"canvas");this.viewer.Init(e),this.viewer.SetEdgeSettings(this.settings.showEdges,this.settings.edgeColor,this.settings.edgeThreshold),this.viewer.SetBackgroundColor(this.settings.backgroundColor),this.UpdateEnvironmentMap()}InitToolbar(){function e(l,a,h,u,d){let m=l.AddImageButton(a,h,()=>{d()});for(let f of u)m.AddClass(f);return m}function t(l,a,h,u,d){let m=l.AddImagePushButton(a,h,!1,f=>{d(f)});for(let f of u)m.AddClass(f);return m}function i(l,a,h,u,d,m){let f=[];for(let c=0;c<a.length;c++){let g=a[c],x=h[c];f.push({image:g,title:x})}let p=l.AddImageRadioButton(f,u,c=>{m(c)});for(let c of d)for(let g of p)g.AddClass(c)}function r(l,a){let h=l.AddSeparator();if(a!==null)for(let u of a)h.classList.add(u)}let n=this.modelLoaderUI.GetImporter();e(this.toolbar,"open","Open model from your device",[],()=>{this.OpenFileBrowserDialog()}),e(this.toolbar,"open_url","Open model from a url",[],()=>{this.dialog=io(l=>{l.length>0&&this.hashHandler.SetModelFilesToHash(l)})}),r(this.toolbar,["only_on_model"]),e(this.toolbar,"fit","Fit model to window",["only_on_model"],()=>{this.FitModelToWindow(!1)}),e(this.toolbar,"up_y","Set Y axis as up vector",["only_on_model"],()=>{this.viewer.SetUpVector(G.Y,!0)}),e(this.toolbar,"up_z","Set Z axis as up vector",["only_on_model"],()=>{this.viewer.SetUpVector(G.Z,!0)}),e(this.toolbar,"flip","Flip up vector",["only_on_model"],()=>{this.viewer.FlipUpVector()}),r(this.toolbar,["only_on_model"]),i(this.toolbar,["fix_up_on","fix_up_off"],["Fixed up vector","Free orbit"],0,["only_on_model"],l=>{l===0?this.viewer.SetFixUpVector(!0):l===1&&this.viewer.SetFixUpVector(!1)}),r(this.toolbar,["only_full_width","only_on_model"]);let o=t(this.toolbar,"measure","Measure",["only_full_width","only_on_model"],l=>{se("measure_tool_activated",l?"on":"off"),this.navigator.SetSelection(null),this.measureTool.SetActive(l)});this.measureTool.SetButton(o),r(this.toolbar,["only_full_width","only_on_model"]),e(this.toolbar,"export","Export model",["only_full_width","only_on_model"],()=>{new vn({isMeshVisible:a=>this.navigator.IsMeshVisible(a),onDialog:a=>{this.dialog=a}}).Show(this.model,this.viewer)}),e(this.toolbar,"share","Share model",["only_full_width","only_on_model"],()=>{this.dialog=ro(n.GetFileList(),this.settings,this.viewer.GetCamera())}),this.parameters.fileInput.addEventListener("change",l=>{l.target.files.length>0&&(se("model_load_started","open_file"),this.LoadModelFromFileList(l.target.files))})}InitDragAndDrop(){window.addEventListener("dragstart",e=>{e.preventDefault()},!1),window.addEventListener("dragover",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),window.addEventListener("drop",e=>{e.stopPropagation(),e.preventDefault(),Un(e.dataTransfer,t=>{t.length>0&&(se("model_load_started","drop"),this.LoadModelFromFileList(t))})},!1)}InitSidebar(){this.sidebar.Init({onEnvironmentMapChange:()=>{this.settings.SaveToCookies(),this.UpdateEnvironmentMap()},onBackgroundColorChange:()=>{this.settings.SaveToCookies(),this.viewer.SetBackgroundColor(this.settings.backgroundColor),this.measureTool.IsActive()&&this.measureTool.UpdatePanel()},onDefaultColorChange:()=>{this.settings.SaveToCookies();let e=this.modelLoaderUI.GetModelLoader();e.GetDefaultMaterial()!==null&&(xr(this.model,this.settings.defaultColor),e.ReplaceDefaultMaterialColor(this.settings.defaultColor)),this.viewer.Render()},onEdgeDisplayChange:()=>{se("edge_display_changed",this.settings.showEdges?"on":"off"),this.UpdateEdgeDisplay()},onThemeChange:()=>{se("theme_changed",this.settings.themeId===pe.Light?"light":"dark"),this.SwitchTheme(this.settings.themeId,!0)},onResize:()=>{this.Resize()},onShowHidePanels:e=>{Gt("ov_show_sidebar",e)}})}InitNavigator(){function e(n,o){let l=null;return n.EnumerateMeshesUserData(a=>{a.originalMeshId.IsEqual(o)&&(l=a)}),l}function t(n,o,l){let a=[];return n.EnumerateMeshesUserData(h=>{if(l===null||h.originalMaterials.indexOf(l)!==-1){let u=o.GetMesh(h.originalMeshId.meshIndex);a.push({meshId:h.originalMeshId,name:u.GetName()})}}),a}function i(n,o){let l=n.GetMaterial(o);return{index:o,name:l.name,color:l.color.Clone()}}function r(n,o,l){let a=[];if(l===null)for(let h=0;h<o.MaterialCount();h++)a.push(i(o,h));else{let h=e(n,l);for(let u=0;u<h.originalMaterials.length;u++){let d=h.originalMaterials[u];a.push(i(o,d))}}return a.sort((h,u)=>h.index-u.index),a}this.navigator.Init({openFileBrowserDialog:()=>{this.OpenFileBrowserDialog()},updateMeshesVisibility:()=>{this.UpdateMeshesVisibility()},updateMeshesSelection:()=>{this.UpdateMeshesSelection()},fitMeshToWindow:n=>{this.FitMeshToWindow(n)},fitMeshesToWindow:n=>{this.FitMeshesToWindow(n)},getMeshesForMaterial:n=>t(this.viewer,this.model,n),getMaterialsForMesh:n=>r(this.viewer,this.model,n),onModelSelected:()=>{this.sidebar.AddObject3DProperties(this.model)},onMeshSelected:n=>{let o=this.model.GetMeshInstance(n);this.sidebar.AddObject3DProperties(o)},onMaterialSelected:n=>{this.sidebar.AddMaterialProperties(this.model.GetMaterial(n))},onResize:()=>{this.Resize()},onShowHidePanels:n=>{Gt("ov_show_navigator",n)}})}UpdatePanelsVisibility(){let e=Dt("ov_show_navigator",!0),t=Dt("ov_show_sidebar",!0);this.navigator.ShowPanels(e),this.sidebar.ShowPanels(t)}InitCookieConsent(){if(Dt("ov_cookie_consent",!1))return;let t='This website uses cookies to offer you better user experience. See the details at the <a target="_blank" href="info/cookies.html">Cookies Policy</a> page.',i=v(document.body,"ov_bottom_floating_panel");v(i,"ov_floating_panel_text",t),v(i,"ov_button ov_floating_panel_button","Accept").addEventListener("click",()=>{Gt("ov_cookie_consent",!0),i.remove()})}};function Io(s){Hn(s)}function To(s){Qi(s),window.addEventListener("load",()=>{new Mn({headerDiv:document.getElementById("header"),toolbarDiv:document.getElementById("toolbar"),mainDiv:document.getElementById("main"),introDiv:document.getElementById("intro"),fileNameDiv:document.getElementById("main_file_name"),navigatorDiv:document.getElementById("main_navigator"),navigatorSplitterDiv:document.getElementById("main_navigator_splitter"),sidebarDiv:document.getElementById("main_sidebar"),sidebarSplitterDiv:document.getElementById("main_sidebar_splitter"),viewerDiv:document.getElementById("main_viewer"),fileInput:document.getElementById("open_file")}).Load()})}function Mo(s){Qi(s),window.addEventListener("load",()=>{new qr({viewerDiv:document.getElementById("embed_viewer"),websiteLinkDiv:document.getElementById("website_link")}).Load()})}function yo(s,e,t,i){let r=Vt("a");return r.setAttribute("href",i),r.setAttribute("target","_blank"),r.setAttribute("rel","noopener noreferrer"),Mi(r,t),ie(r,e,"header_button"),s.appendChild(r),r}return fo(So);})();
//# sourceMappingURL=o3dv.website.min-dev.js.map
